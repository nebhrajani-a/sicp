<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-11-22 Mon 17:37 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MIT 6.001 1986 Video Notes</title>
<meta name="author" content="Nebhrajani A.V." />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">MIT 6.001 1986 Video Notes</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgc27ab2f">1. Prologue</a>
<ul>
<li><a href="#orgc75df17">1.1. About</a></li>
<li><a href="#org1202e8c">1.2. License</a></li>
</ul>
</li>
<li><a href="#org71757d3">2. Lecture 1A: Overview and Introduction to Lisp</a>
<ul>
<li><a href="#org36fe685">2.1. Managing Complexity: Key Ideas of 6.001</a></li>
<li><a href="#org533e082">2.2. Let&rsquo;s Learn Lisp</a>
<ul>
<li><a href="#org0fab1d6">2.2.1. Primitive Elements</a></li>
<li><a href="#orgf41ca6d">2.2.2. Means of Combination</a></li>
<li><a href="#org3f11d53">2.2.3. Means of Abstraction</a></li>
</ul>
</li>
<li><a href="#orga2fab2f">2.3. Case Analysis in Lisp</a></li>
<li><a href="#orgddf6952">2.4. Finding Square Roots</a></li>
<li><a href="#orgf9188d0">2.5. Inbuilt/Primitive Procedures Aren&rsquo;t Special</a></li>
</ul>
</li>
<li><a href="#org92adb72">3. Lecture 1B: Procedures and Processes, Substitution Model</a>
<ul>
<li><a href="#org4ea17de">3.1. Substitution Rule/Model</a>
<ul>
<li><a href="#org3f58bfb">3.1.1. Kinds of Expressions in Lisp</a></li>
<li><a href="#orgbf43577">3.1.2. Example</a></li>
</ul>
</li>
<li><a href="#org3aa1e1b">3.2. Peano Arithmetic</a>
<ul>
<li><a href="#org9d27620">3.2.1. Simple Peano Addition</a></li>
<li><a href="#org63a398d">3.2.2. Another Peano Adder</a></li>
</ul>
</li>
<li><a href="#orgf8359bf">3.3. Differentiating Between Iterative and Recursive Processes</a></li>
<li><a href="#orgb3add4d">3.4. Fibonacci Numbers</a></li>
<li><a href="#org4b84191">3.5. Towers of Hanoi</a></li>
<li><a href="#org1b2683b">3.6. Iterative Fibonacci</a></li>
</ul>
</li>
<li><a href="#orgb84ecda">4. Lecture 2A: Higher-Order Procedures</a>
<ul>
<li><a href="#orgbf3efae">4.1. Abstracting Procedural Ideas</a></li>
<li><a href="#orgfecddf1">4.2. More on Square Roots</a>
<ul>
<li><a href="#org6a2588f">4.2.1. Fixed Points</a></li>
<li><a href="#orgc6d70b8">4.2.2. Damping Oscillations</a></li>
</ul>
</li>
<li><a href="#org53d241c">4.3. Newton&rsquo;s Method</a></li>
<li><a href="#orge2f63fb">4.4. Procedures are First-Class Citizens</a></li>
</ul>
</li>
<li><a href="#orge671513">5. Lecture 2B: Compound Data</a>
<ul>
<li><a href="#org03ce235">5.1. Rational Number Arithmetic</a>
<ul>
<li><a href="#org8b2e938">5.1.1. Abstraction</a></li>
<li><a href="#orgd9251e1">5.1.2. Data Object Creation</a></li>
</ul>
</li>
<li><a href="#org72d05e8">5.2. Representing Points on a Plane</a></li>
<li><a href="#org7c4b657">5.3. Pairs</a></li>
</ul>
</li>
<li><a href="#org5af9518">6. Lecture 3A: Henderson Escher Example</a>
<ul>
<li><a href="#org405a9d2">6.1. Lists</a>
<ul>
<li><a href="#org687965c">6.1.1. Procedures on Lists</a></li>
</ul>
</li>
<li><a href="#orgaeb3ba0">6.2. Henderson&rsquo;s Picture Language</a>
<ul>
<li><a href="#org85ef784">6.2.1. Primitives</a></li>
<li><a href="#org6afee3b">6.2.2. Means of Combination and Operations</a></li>
<li><a href="#orge535d82">6.2.3. An Implementation</a></li>
<li><a href="#orgb934905">6.2.4. Means of Abstraction</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0a522e0">7. Lecture 3B: Symbolic Differentiation; Quotation</a>
<ul>
<li><a href="#org9cc96cc">7.1. Differentiation v. Integration</a></li>
<li><a href="#orgc14e771">7.2. Some Wishful Thinking</a></li>
<li><a href="#orga797fc9">7.3. Representing Algebraic Expressions</a>
<ul>
<li><a href="#orgea076ff">7.3.1. Using Lisp Syntax</a></li>
<li><a href="#orgf2878ad">7.3.2. Representation Implementation</a></li>
<li><a href="#org5e0e99b">7.3.3. Simplification</a></li>
</ul>
</li>
<li><a href="#org9b6a17c">7.4. On Abstract Syntax</a></li>
</ul>
</li>
<li><a href="#orgf8507a0">8. Lecture 4A: Pattern Matching and Rule-Based Substitution</a>
<ul>
<li><a href="#org6197baf">8.1. Rule Language</a>
<ul>
<li><a href="#orgd912052">8.1.1. Pattern Matching</a></li>
<li><a href="#orgc43c06e">8.1.2. Skeleton and Instantiation</a></li>
</ul>
</li>
<li><a href="#org69f34f7">8.2. Desired Behaviour</a></li>
<li><a href="#org857d022">8.3. Implementation</a>
<ul>
<li><a href="#org04f071e">8.3.1. Matcher</a></li>
<li><a href="#orge6daa5f">8.3.2. Instantiator</a></li>
<li><a href="#orgd0da5e5">8.3.3. GIGO Simplifier</a></li>
<li><a href="#org75b5215">8.3.4. Dictionary Implementation</a></li>
<li><a href="#orgf474d66">8.3.5. Predicates</a></li>
</ul>
</li>
<li><a href="#org049aebc">8.4. Usage</a>
<ul>
<li><a href="#orgc83dc07">8.4.1. Algebraic Simplification</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org2ebea32">9. Lecture 4B: Generic Operators</a>
<ul>
<li><a href="#org28b6f1e">9.1. Dispatch on Type</a>
<ul>
<li><a href="#org2935e24">9.1.1. On Complex Numbers</a></li>
<li><a href="#org4ca6d08">9.1.2. Arithmetic Implementation</a></li>
<li><a href="#org7ea318d">9.1.3. George&rsquo;s Representation</a></li>
<li><a href="#orgc1114fd">9.1.4. Martha&rsquo;s Representation</a></li>
<li><a href="#org0030df8">9.1.5. Type Dispatch Manager</a></li>
<li><a href="#org18b462b">9.1.6. Usage</a></li>
<li><a href="#org3fb9aef">9.1.7. Review</a></li>
</ul>
</li>
<li><a href="#org89a6c14">9.2. Data-Directed Programming</a>
<ul>
<li><a href="#org5762ca7">9.2.1. Putting George&rsquo;s Procedures</a></li>
<li><a href="#org5076cd2">9.2.2. Putting Martha&rsquo;s Procedures</a></li>
<li><a href="#orgaf34ae0">9.2.3. Manager Automation</a></li>
<li><a href="#orgb6a1c45">9.2.4. Usage</a></li>
</ul>
</li>
<li><a href="#org314fc46">9.3. Advanced Example: Semi-Complete Arithmetic System</a>
<ul>
<li><a href="#orgfb402b7">9.3.1. Architecture</a></li>
<li><a href="#orgf874d31">9.3.2. Implementation</a></li>
<li><a href="#org64c3d2c">9.3.3. Usage</a></li>
<li><a href="#org3c1ba7f">9.3.4. Adding Polynomials</a></li>
<li><a href="#orgfd2659d">9.3.5. Recursive Data Directed Programming</a></li>
</ul>
</li>
<li><a href="#org562b882">9.4. Review</a></li>
</ul>
</li>
<li><a href="#org3c29e04">10. Lecture 5A: Assignment, State, and Side-Effects</a>
<ul>
<li><a href="#org524407b">10.1. Functional v. Imperative Style</a>
<ul>
<li><a href="#org2f9c6b9">10.1.1. Functional Programming</a></li>
<li><a href="#org7da1eb2">10.1.2. Imperative Programming</a></li>
<li><a href="#org154a8e3">10.1.3. Direct Comparison</a></li>
</ul>
</li>
<li><a href="#orgd3f8a97">10.2. Environment Model</a>
<ul>
<li><a href="#orgfd2a413">10.2.1. Bound and Free Variables</a></li>
<li><a href="#orgccf706b">10.2.2. Scope</a></li>
<li><a href="#orgb0cf695">10.2.3. Frames and Environments</a></li>
<li><a href="#org4b95200">10.2.4. Procedure Objects</a></li>
<li><a href="#org1965493">10.2.5. Rules for Environment Model</a></li>
<li><a href="#org3afb427">10.2.6. Assignment</a></li>
<li><a href="#org1408e7a">10.2.7. Some Philosophy</a></li>
</ul>
</li>
<li><a href="#org35bf65b">10.3. Advantages of Assignment</a>
<ul>
<li><a href="#orgb8f8f35">10.3.1. Cesàro&rsquo;s Pi Finder</a></li>
<li><a href="#org9f34117">10.3.2. Functional Cesàro&rsquo;s Pi Finder</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbbdc34c">11. Lecture 5B: Computational Objects</a>
<ul>
<li><a href="#org2a24f5d">11.1. Digital Circuit Language</a></li>
<li><a href="#org28667ec">11.2. Gates</a></li>
<li><a href="#org9e7cfb8">11.3. Wires</a></li>
<li><a href="#orge14f79f">11.4. Delays and Propagation</a></li>
<li><a href="#org7ad0538">11.5. The Agenda</a>
<ul>
<li><a href="#org55af064">11.5.1. Time Segments</a></li>
<li><a href="#org977eea8">11.5.2. Agenda Implementation</a></li>
</ul>
</li>
<li><a href="#org59851cf">11.6. Queues</a></li>
<li><a href="#org9e37d4a">11.7. Using the Digital Circuit Language</a></li>
<li><a href="#orgddc463a">11.8. Church&rsquo;s <code>set-car!</code> and <code>set-cdr!</code></a></li>
</ul>
</li>
<li><a href="#org25fd506">12. Lecture 6A: Streams, Part I</a>
<ul>
<li><a href="#org6822237">12.1. Stream Processing</a></li>
<li><a href="#org91e162a">12.2. Some More Complex Examples</a>
<ul>
<li><a href="#orge668ac8">12.2.1. Flattening</a></li>
<li><a href="#orge6e3d72">12.2.2. Prime Sum Pairs</a></li>
<li><a href="#org480e7f8">12.2.3. <span class="todo TODO">TODO</span> Backtracking: The Eight Queens Problem</a></li>
</ul>
</li>
<li><a href="#org9c04f84">12.3. The Catch: On Efficiency</a></li>
<li><a href="#org469e480">12.4. Implementing Streams</a>
<ul>
<li><a href="#orgc92105e">12.4.1. A Small Optimization</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgc27ab2f" class="outline-2">
<h2 id="orgc27ab2f"><span class="section-number-2">1.</span> Prologue</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgc75df17" class="outline-3">
<h3 id="orgc75df17"><span class="section-number-3">1.1.</span> About</h3>
<div class="outline-text-3" id="text-1-1">
<p>
These are my notes of the twenty SICP lectures of June 1986,
produced by Hewlett-Packard Television. These videos are available
under a Creative Commons license.
</p>

<p>
These notes aim to be concise and as example-heavy as possible. The
language used and referred to as &ldquo;Lisp&rdquo; is MIT-Scheme. These notes,
however, use the SICP language provided by Racket, a modern Scheme
dialect. This is because Racket&rsquo;s integration with Emacs and Org
mode is orders of magnitude better than MIT-Scheme&rsquo;s. In general,
all &ldquo;Lisp&rdquo; code looks exactly the same as in SICP, with the
exception of having to prefix some numbers with <code>#i</code> to ensure
Racket treats them as imprecise.
</p>

<p>
Note that Racket&rsquo;s SICP language creates mutable pairs (<code>mpair</code>&rsquo;s)
by default, as in MIT Scheme. Therefore, <code>set-car!</code> and <code>set-cdr!</code>
are available as primitives.
</p>
</div>
</div>

<div id="outline-container-org1202e8c" class="outline-3">
<h3 id="org1202e8c"><span class="section-number-3">1.2.</span> License</h3>
<div class="outline-text-3" id="text-1-2">
</div>
</div>
</div>

<div id="outline-container-org71757d3" class="outline-2">
<h2 id="org71757d3"><span class="section-number-2">2.</span> Lecture 1A: Overview and Introduction to Lisp</h2>
<div class="outline-text-2" id="text-2">
<p>
Computer science isn&rsquo;t really a science, and it isn&rsquo;t really about
computers. Computer science is the study of how-to or imperative
knowledge (as opposed to declarative knowledge). To illustrate the
difference, consider:
</p>

<p>
\[y = \sqrt{x} \mathrm{~such~that~} y^2=x, y \geq 0\]
</p>

<p>
This is declarative, in that we could recognize if \(y\) is the square
root of \(x\) given \(x\) and \(y\), but we&rsquo;re no closer to knowing how to
<i>find</i> \(y\) if we are given \(x\). Imperative knowledge would look
like:
</p>

<p>
To find the square root \(y\) of \(x\):
</p>
<ul class="org-ul">
<li>Make a guess \(g\).</li>
<li>If \(g^2\) is close enough to \(x\), \(y=g\).</li>
<li>Otherwise, make a new guess equal to the average of \(g\) and \(x/g\).</li>
</ul>

<p>
This method will eventually come up with a \(g\) close enough to the
actual square root \(y\) of \(x\).
</p>

<p>
Computer science focuses on this kind of imperative knowledge, and,
specifically, how to communicate that knowledge to a computer.
</p>
</div>

<div id="outline-container-org36fe685" class="outline-3">
<h3 id="org36fe685"><span class="section-number-3">2.1.</span> Managing Complexity: Key Ideas of 6.001</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Computer science is also about managing complexity, in that large
programs that you can&rsquo;t hold in your head should still be manageable
and easy to work with. We explore this theme in 6.001 by learning
three key ideas:
</p>

<ul class="org-ul">
<li>Black-box abstractions</li>
<li>Conventional interfaces</li>
<li>Metalinguistic abstraction.</li>
</ul>
</div>
</div>


<div id="outline-container-org533e082" class="outline-3">
<h3 id="org533e082"><span class="section-number-3">2.2.</span> Let&rsquo;s Learn Lisp</h3>
<div class="outline-text-3" id="text-2-2">
<p>
When learning a new language, always ask about its:
</p>
<ul class="org-ul">
<li>Primitive elements,</li>
<li>Means of combination, and</li>
<li>Means of abstraction.</li>
</ul>
</div>

<div id="outline-container-org0fab1d6" class="outline-4">
<h4 id="org0fab1d6"><span class="section-number-4">2.2.1.</span> Primitive Elements</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
These are numbers like 3, 17.4, or 5. Other primitives are
discussed later in the course.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #2e8b57;">4</span>
<span style="color: #2e8b57;">17.4</span>
<span style="color: #2e8b57;">5</span>
</pre>
</div>

<pre class="example">
4
17.4
5
</pre>
</div>
</div>

<div id="outline-container-orgf41ca6d" class="outline-4">
<h4 id="orgf41ca6d"><span class="section-number-4">2.2.2.</span> Means of Combination</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
Lisp&rsquo;s numerical primitives can be combined with &ldquo;operations&rdquo; such
as addition, written in prefix notation.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #a626a4;">+</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">17.4</span> <span style="color: #2e8b57;">5</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
25.4
</pre>


<p>
Other basic operations are provided by Lisp, such as
multiplication and division. Of course, combinations can be
combined recursively:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #a626a4;">+</span> <span style="color: #2e8b57;">3</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">5</span> <span style="color: #2e8b57;">6</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">2</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
43
</pre>


<p>
This should show you the tree structure inherent in all of Lisp:
</p>
<p>
In Lisp, () is the application of an operation or function in
prefix notation.
</p>
</div>
</div>

<div id="outline-container-org3f11d53" class="outline-4">
<h4 id="org3f11d53"><span class="section-number-4">2.2.3.</span> Means of Abstraction</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
Abstraction can simply be done by naming things. Giving
complicated things a name prevents us from having to understand
how the thing the name refers to <i>works</i>, and instead lets us
&ldquo;abstractly&rdquo; use the name for our purposes.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">5</span> <span style="color: #2e8b57;">5</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
a
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> a a<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">b</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> a <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">5</span> a<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
b
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">+</span> a <span style="color: #a626a4;">(</span><span style="color: #a626a4;">/</span> b <span style="color: #2e8b57;">5</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
25
625
150
55
</pre>


<p>
Now, it&rsquo;s often more useful to abstract away imperative how-to
knowledge. Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgb6cab58"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">square</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span>square <span style="color: #2e8b57;">10</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
100
</pre>


<p>
This defines <code>square</code> as a function taking a single argument <code>x</code>,
and returning <code>(* x x)</code>. Note that this way of writing a define is
actually &ldquo;syntactic sugar&rdquo; for:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">square</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>x<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>square <span style="color: #2e8b57;">25</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
625
</pre>


<p>
<code>lambda (x)</code> means &ldquo;make a procedure that takes argument <code>x</code>&rdquo;. The
second argument to lambda is the actual procedure body. The
<code>define</code> names this anonymous procedure <code>square</code>.
</p>

<p>
Just like we can use combinations recursively, so we can
abstractions. Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org7960548"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">average</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">/</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> x y<span style="color: #50a14f;">)</span> <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">mean-square</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>average <span style="color: #50a14f;">(</span>square x<span style="color: #50a14f;">)</span>
           <span style="color: #50a14f;">(</span>square y<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>mean-square <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">3</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
13/2
</pre>


<p>
Note the indentation: since Lisp is parenthesis heavy, we use
indentation. Good editors like Emacs should do this automatically.
</p>
</div>
</div>
</div>

<div id="outline-container-orga2fab2f" class="outline-3">
<h3 id="orga2fab2f"><span class="section-number-3">2.3.</span> Case Analysis in Lisp</h3>
<div class="outline-text-3" id="text-2-3">
<p>
To represent functions like:
\[abs(x) = \begin{cases}
   -x & x<0\\
   0 & x = 0\\
   x & x > 0
   \end{cases}\]
Lisp needs some form of conditional execution. In Lisp, this
function would look like:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">abs</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">&lt;</span> x <span style="color: #2e8b57;">0</span><span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">-</span> x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> x <span style="color: #2e8b57;">0</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">&gt;</span> x <span style="color: #2e8b57;">0</span><span style="color: #da8548;">)</span> x<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #2e8b57;">-3</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #2e8b57;">0</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #2e8b57;">5</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
3
0
5
</pre>


<p>
<code>cond</code> takes any number of arguments. Each argument must be
structured as <code>(predicate) (consequent)</code>. If <code>predicate</code> is true,
we do the <code>consequent</code>. Otherwise, we don&rsquo;t. Lisp also provides a
way to write conditionals that only have two branches (an if-else):
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgf257b1a"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">abs</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&lt;</span> x <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">-</span> x<span style="color: #50a14f;">)</span>
      x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #2e8b57;">-11</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #2e8b57;">0</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #2e8b57;">33</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
11
0
33
</pre>


<p>
<code>cond</code> and <code>if</code> are syntactical sugar for each other. The Lisp
implementation picks any one and defines the other in terms of it.
</p>

<p>
We now know most of Lisp. Lisp doesn&rsquo;t have <code>do...while</code> or <code>for</code>,
since anything a loop can do can be done via recursion.
</p>
</div>
</div>

<div id="outline-container-orgddf6952" class="outline-3">
<h3 id="orgddf6952"><span class="section-number-3">2.4.</span> Finding Square Roots</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Remember our square root finding algorithm?
</p>

<p>
To find the square root \(y\) of \(x\):
</p>
<ul class="org-ul">
<li>Make a guess \(g\).</li>
<li>If \(g^2\) is close enough to \(x\), \(y=g\).</li>
<li>Otherwise, make a new guess equal to the average of \(g\) and
\(x/g\).</li>
</ul>

<p>
Or, in Lisp,
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org7fb7876"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">try</span> g x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>good-enough? g x<span style="color: #50a14f;">)</span>
      g
      <span style="color: #50a14f;">(</span>try <span style="color: #da8548;">(</span>improve g x<span style="color: #da8548;">)</span> x<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
This is a form of programming called &ldquo;wishful thinking&rdquo;: we assume
<code>good-enough?</code> (good enough predicate) and <code>improve</code> are already
implemented. Now that we can try a guess and improve it till it&rsquo;s
good enough, we can write a simple square root function:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org4172163"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>try <span style="color: #2e8b57;">1</span> x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
This function simply starts the guess at 1, then improves it. Let&rsquo;s
now write the functions we don&rsquo;t have:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org42a997e"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">improve</span> g x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>average g <span style="color: #50a14f;">(</span><span style="color: #a626a4;">/</span> x g<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket" id="org1144362"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">good-enough?</span> g x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">&lt;</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">-</span> <span style="color: #b751b6;">(</span>square g<span style="color: #b751b6;">)</span> x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
     <span style="color: #2e8b57;">0.00001</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
This tests if \(g^2\) is within 0.0001 of \(x\). Putting it all
together, we can finally try to find square roots:
</p>

<div class="org-src-container">
<pre class="src src-racket">






<span style="color: #4078f2;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #2e8b57;">#i2</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #2e8b57;">#i3</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #2e8b57;">#i4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1.4142156862745097
1.7320508100147274
2.0000000929222947
</pre>


<blockquote>
<p>
<b>Note:</b> The <code>#i4</code> is Racket&rsquo;s syntax for using imprecise
(decimals) instead of precise (fractions). Ignore it, and treat it
as the number <code>4</code>.
</p>
</blockquote>

<p>
See that <code>try</code> actually runs a loop, but does so recursively,
calling itself every time the <code>if</code> condition fails to improve the
guess. Also note that these functions can all be nested inside the
square root function to hide them from the outer scope, thus:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">good-enough?</span> g<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">square</span> g<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> g g<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">abs</span> y<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">&lt;</span> y <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> y<span style="color: #b751b6;">)</span>
          y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&lt;</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> <span style="color: #986801;">(</span>square g<span style="color: #986801;">)</span> x<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
       <span style="color: #2e8b57;">0.0001</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">improve</span> g<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">average</span> y z<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> y z<span style="color: #b751b6;">)</span> <span style="color: #2e8b57;">2</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>average g <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> x g<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">try</span> g<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span>good-enough? g<span style="color: #da8548;">)</span>
        g
        <span style="color: #da8548;">(</span>try <span style="color: #b751b6;">(</span>improve g<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>try <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #2e8b57;">#i2</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1.4142156862745097
</pre>


<p>
This program should also show you a tree-like dependency of the
functions, with each function containing the definitions of the
functions it depends on. For someone using <code>sqrt</code>, all the functions
within it are hidden.
</p>

<p>
This discipline of writing procedures is called lexical scoping.
</p>
</div>
</div>


<div id="outline-container-orgf9188d0" class="outline-3">
<h3 id="orgf9188d0"><span class="section-number-3">2.5.</span> Inbuilt/Primitive Procedures Aren&rsquo;t Special</h3>
<div class="outline-text-3" id="text-2-5">
<div class="org-src-container">
<pre class="src src-racket">
square
<span style="color: #a626a4;">+</span>
</pre>
</div>

<pre class="example">
#&lt;procedure:square&gt;
#&lt;procedure:+&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org92adb72" class="outline-2">
<h2 id="org92adb72"><span class="section-number-2">3.</span> Lecture 1B: Procedures and Processes, Substitution Model</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org4ea17de" class="outline-3">
<h3 id="org4ea17de"><span class="section-number-3">3.1.</span> Substitution Rule/Model</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The substitution rule states that,
</p>

<blockquote>
<p>
To evaluate an application:
</p>
<ul class="org-ul">
<li>Evaluate the operator to get procedure.</li>
<li>Evaluate the operands to get arguments.</li>
<li>Apply procedure to arguments.
<ul class="org-ul">
<li>Copy body of procedure.</li>
<li>Replace formal parameters with actual arguments.</li>
</ul></li>
<li>Evaluate new body.</li>
</ul>
</blockquote>

<p>
Note that this isn&rsquo;t necessarily how the <i>interpreter</i> evaluates a
Lisp application, but the substitution rule is a &ldquo;good enough&rdquo;
model for our purposes.
</p>
</div>

<div id="outline-container-org3f58bfb" class="outline-4">
<h4 id="org3f58bfb"><span class="section-number-4">3.1.1.</span> Kinds of Expressions in Lisp</h4>
<div class="outline-text-4" id="text-3-1-1">
<ul class="org-ul">
<li>Numbers (evaluate to &ldquo;themselves&rdquo;)</li>
<li>Symbols (represent some procedure)</li>
<li>Combinations</li>
<li>&lambda;-expressions (used to build procedures)</li>
<li>Definitions (used to name symbols)</li>
<li>Conditionals</li>
</ul>

<p>
We will focus our use of the substitution rule on the first three.
The last three are called &ldquo;special forms&rdquo;, and we&rsquo;ll worry about
them later.
</p>
</div>
</div>

<div id="outline-container-orgbf43577" class="outline-4">
<h4 id="orgbf43577"><span class="section-number-4">3.1.2.</span> Example</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-of-squares</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> <span style="color: #50a14f;">(</span>square x<span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span>square y<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>sum-of-squares <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
25
</pre>


<p>
Let&rsquo;s try to apply the substitution rule to our application,
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span>sum-of-squares <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">+</span> <span style="color: #a626a4;">(</span>square <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span>square <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">+</span> <span style="color: #a626a4;">(</span>square <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">+</span> <span style="color: #a626a4;">(</span>square <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">16</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">+</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">16</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">+</span> <span style="color: #2e8b57;">9</span> <span style="color: #2e8b57;">16</span><span style="color: #4078f2;">)</span>
<span style="color: #2e8b57;">25</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3aa1e1b" class="outline-3">
<h3 id="org3aa1e1b"><span class="section-number-3">3.2.</span> Peano Arithmetic</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org9d27620" class="outline-4">
<h4 id="org9d27620"><span class="section-number-4">3.2.1.</span> Simple Peano Addition</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
Peano arithmetic defines addition as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org8b5316f"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">pa+</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">=</span> x <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
      y
      <span style="color: #50a14f;">(</span>pa+ <span style="color: #da8548;">(</span>dec x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>inc y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span>pa+ <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
7
</pre>


<p>
Assume that <code>inc</code> and <code>dec</code> are primitives available that increment
and decrement the argument respectively. How is the procedure <code>pa+</code>
working? Let&rsquo;s apply the substitution rule.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span>pa+ <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">if</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">=</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">0</span><span style="color: #a626a4;">)</span>
    <span style="color: #2e8b57;">4</span>
    <span style="color: #a626a4;">(</span>pa+ <span style="color: #50a14f;">(</span>dec <span style="color: #2e8b57;">3</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span>inc <span style="color: #2e8b57;">4</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>pa+ <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">5</span><span style="color: #4078f2;">)</span>
<span style="color: #e45649;">...</span>
<span style="color: #4078f2;">(</span>pa+ <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">6</span><span style="color: #4078f2;">)</span>
<span style="color: #e45649;">...</span>
<span style="color: #4078f2;">(</span>pa+ <span style="color: #2e8b57;">0</span> <span style="color: #2e8b57;">7</span><span style="color: #4078f2;">)</span>
<span style="color: #2e8b57;">7</span>
</pre>
</div>

<p>
We&rsquo;re skipping some steps, but the idea is that <code>x</code> keeps giving
one &ldquo;unit&rdquo; to <code>y</code> until it reaches zero. Then the sum is <code>y</code>.
Written with steps skipped:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span>pa+ <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>pa+ <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">5</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>pa+ <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">6</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>pa+ <span style="color: #2e8b57;">0</span> <span style="color: #2e8b57;">7</span><span style="color: #4078f2;">)</span>
<span style="color: #2e8b57;">7</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org63a398d" class="outline-4">
<h4 id="org63a398d"><span class="section-number-4">3.2.2.</span> Another Peano Adder</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
Consider:
</p>
<div class="org-src-container">
<pre class="src src-racket" id="orga52545d"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">pb+</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">=</span> x <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
      y
      <span style="color: #50a14f;">(</span>inc <span style="color: #da8548;">(</span>pb+ <span style="color: #b751b6;">(</span>dec x<span style="color: #b751b6;">)</span> y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>


<p>
This is also a Peano adder: but it&rsquo;s implemented <i>slightly</i>
differently syntax-wise, a few characters here and there. Let&rsquo;s
use the substitution rule to see how it works.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span>pb+ <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>inc <span style="color: #a626a4;">(</span>pb+ <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>inc <span style="color: #a626a4;">(</span>inc <span style="color: #50a14f;">(</span>pb+ <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">4</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>inc <span style="color: #a626a4;">(</span>inc <span style="color: #50a14f;">(</span>inc <span style="color: #da8548;">(</span>pb+ <span style="color: #2e8b57;">0</span> <span style="color: #2e8b57;">4</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>inc <span style="color: #a626a4;">(</span>inc <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>inc <span style="color: #2e8b57;">4</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>inc <span style="color: #a626a4;">(</span>inc <span style="color: #2e8b57;">5</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>inc <span style="color: #2e8b57;">6</span><span style="color: #4078f2;">)</span>
<span style="color: #2e8b57;">7</span>
</pre>
</div>

<p>
See that it <i>does</i> work:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span>pb+ <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
7
</pre>


<p>
Now, consider how these two, <code>pa+</code> and <code>pb+</code>, are different. While
the <i>procedures</i> do the same thing, the processes are wildly
different. Let&rsquo;s discuss their time and space complexity.
It should be obvious to you that the time complexity is the
vertical axis in the substitution rule application, since the
interpreter &ldquo;executes&rdquo; these instructions line by line. More lines
means more time.
</p>

<p>
In the case of <code>pa+</code>, the number of lines increases by 1 if you
increase input <code>x</code> by 1. Thus, the time complexity is \(O(x)\).
Similarly, in the case of <code>pb+</code>, the number of lines increases by
2 (once in the expansion, once in the contraction) when you
increase <code>x</code> by 1. Thus, it is also \(O(x)\).
</p>

<p>
Now, the horizontal axis shows us how much space is being used. In
the case of <code>pa+</code>, the space used is a constant. Thus, \(O(1)\). On
the other hand, see that <code>pb+</code> first <i>expands</i> then <i>contracts</i>.
The length of the maximum expansion increases by 1 if we increase
\(x\) by 1, since there&rsquo;s one more increment to do. Thus, \(O(x)\).
</p>

<p>
Now, we call a process like <code>pa+</code> <i>linear iterative</i> and a process
like <code>pb+</code> <i>linear recursive</i>.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Process</th>
<th scope="col" class="org-left">Time Complexity</th>
<th scope="col" class="org-left">Space Complexity</th>
<th scope="col" class="org-left">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>pa+</code></td>
<td class="org-left">\(O(x)\)</td>
<td class="org-left">\(O(1)\)</td>
<td class="org-left">Linear iterative</td>
</tr>

<tr>
<td class="org-left"><code>pb+</code></td>
<td class="org-left">\(O(x)\)</td>
<td class="org-left">\(O(x)\)</td>
<td class="org-left">Linear recursive</td>
</tr>
</tbody>
</table>

<p>
Note that the <i>process</i> <code>pa+</code> being iterative has nothing to do
with the implementation/definition of the <i>procedure</i>, which is
recursive. Iteration refers to the constant space requirement.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf8359bf" class="outline-3">
<h3 id="orgf8359bf"><span class="section-number-3">3.3.</span> Differentiating Between Iterative and Recursive Processes</h3>
<div class="outline-text-3" id="text-3-3">
<p>
One of the primary ways to differentiate between an iterative and
recursive process is to imagine what&rsquo;d happen if you turned the
computer off, then resumed the current computation.
</p>

<p>
In a recursive process, we&rsquo;ve lost some important information: how
deep into the recursion we are. In the <code>pb+</code> example, we wouldn&rsquo;t
know how many <code>inc</code>&rsquo;s deep we are (information stored in the RAM by
the interpreter, not by the process), meaning that we can&rsquo;t return
the right value.
</p>

<p>
In an iterative process, we can pick up right where we left off,
since <i>all</i> state information is contained by the process.
</p>
</div>
</div>

<div id="outline-container-orgb3add4d" class="outline-3">
<h3 id="orgb3add4d"><span class="section-number-3">3.4.</span> Fibonacci Numbers</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Fibonacci numbers are defined as:
</p>

<p>
\[F(x) =
   \begin{cases}
   0, & x = 0\\
   1, & x = 1\\
   F(x-1) + F(x-2), & \mathrm{otherwise}
   \end{cases}\]
</p>

<p>
The series itself is:
\[0,1,1,2,3,5,8,13,21,34,55\dots\]
</p>

<p>
Let&rsquo;s write a Lisp function to calculate the \(n\mathrm{th}\) Fibonacci
number, assuming 0 is the 0th.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">fib</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&lt;</span> n <span style="color: #2e8b57;">2</span><span style="color: #50a14f;">)</span>
      n
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>fib <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> n <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>fib <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> n <span style="color: #2e8b57;">2</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>fib <span style="color: #2e8b57;">10</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
55
</pre>


<p>
It works, that&rsquo;s true. But how <i>well</i> does it work. Let&rsquo;s see. When
we call (say) <code>(fib 4)</code>, we also call <code>(fib 3)</code> and <code>(fib 2)</code>, both
of which also call \(\dots\) let&rsquo;s draw it:
</p>

<p>
A tree! Clearly, this is an exponential-time process, since
computing \(n+1\) takes exponentially more effort. Also note that
it&rsquo;s a pretty bad process, since we constantly recompute many
values. The space complexity is the maximum depth of the tree
(depth of recursion), which is at most \(n\). Therefore, the time
complexity is \(O(\mathrm{fib}(n))\) and space complexity is \(O(n)\).
</p>

<p>
It is useful to try and write an iterative Fibonacci with better
performance as an exercise.
</p>
</div>
</div>

<div id="outline-container-org4b84191" class="outline-3">
<h3 id="org4b84191"><span class="section-number-3">3.5.</span> Towers of Hanoi</h3>
<div class="outline-text-3" id="text-3-5">
<p>
From Wikipedia:
</p>

<blockquote>
<p>
The Tower of Hanoi is a mathematical game or puzzle. It consists of
three rods and a number of disks of different diameters, which can
slide onto any rod. The puzzle starts with the disks stacked on one
rod in order of decreasing size, the smallest at the top, thus
approximating a conical shape. The objective of the puzzle is to
move the entire stack to the last rod, obeying the following simple
rules:
</p>

<ul class="org-ul">
<li>Only one disk may be moved at a time.</li>
<li>Each move consists of taking the upper disk from one of the
stacks and placing it on top of another stack or an empty rod.</li>
<li>No disk may be placed on top of a disk that is smaller than it.</li>
</ul>
</blockquote>

<p>
Let&rsquo;s try to solve Hanoi for 4 disks, from rod A to rod C. Again
&#x2014; &ldquo;wishful thinking&rdquo;. Let&rsquo;s assume that we know how to solve for
3 disks. To solve, we&rsquo;d take the top 3 disks, put it on the spare
rod B. Then, we&rsquo;d take the fourth and largest disk, and put it on
destination rod C. Finally, we&rsquo;d move the three disk pile from B
to C. Solved!
</p>

<p>
But wait &#x2014; to solve the 3 disk case, let&rsquo;s assume we know how to
solve the 2 disk case.
</p>

<p>
To solve the 2 disk case, we should know how
to solve the one disk case, which is just moving a disk from a rod
to another.
</p>

<p>
Or, in Lisp,
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">move</span> n from to spare<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> n <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> <span style="color: #50a14f;">"Move disk at rod "</span><span style="color: #da8548;">)</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> from<span style="color: #da8548;">)</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> <span style="color: #50a14f;">" to rod "</span><span style="color: #da8548;">)</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> to<span style="color: #da8548;">)</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> <span style="color: #50a14f;">".\n"</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
         <span style="color: #da8548;">(</span>move <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> n <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span> from spare to<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>move <span style="color: #2e8b57;">1</span> from to spare<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>move <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> n <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span> spare to from<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>move <span style="color: #2e8b57;">4</span> <span style="color: #50a14f;">"A"</span> <span style="color: #50a14f;">"C"</span> <span style="color: #50a14f;">"B"</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example" id="orgfb615ea">
Move disk at rod A to rod B.
Move disk at rod A to rod C.
Move disk at rod B to rod C.
Move disk at rod A to rod B.
Move disk at rod C to rod A.
Move disk at rod C to rod B.
Move disk at rod A to rod B.
Move disk at rod A to rod C.
Move disk at rod B to rod C.
Move disk at rod B to rod A.
Move disk at rod C to rod A.
Move disk at rod B to rod C.
Move disk at rod A to rod B.
Move disk at rod A to rod C.
Move disk at rod B to rod C.
</pre>

<p>
Note, of course, that this procedure too, is an exponential time
procedure. However, any procedure for Hanoi will be exponential
time, since for \(n\) disks, Hanoi requires \(2^{n-1}\) moves. Even if
you compute every move in \(O(1)\) (which we do, since it&rsquo;s just a
print), the complexity will be \(O(2^n)\).
</p>
</div>
</div>

<div id="outline-container-org1b2683b" class="outline-3">
<h3 id="org1b2683b"><span class="section-number-3">3.6.</span> Iterative Fibonacci</h3>
<div class="outline-text-3" id="text-3-6">
<div class="org-src-container">
<pre class="src src-racket" id="orgd59cca6"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">iter-fib</span> n a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">=</span> n <span style="color: #2e8b57;">1</span><span style="color: #50a14f;">)</span>
      b
      <span style="color: #50a14f;">(</span>iter-fib <span style="color: #da8548;">(</span>dec n<span style="color: #da8548;">)</span> b <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> a b<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">fib</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>iter-fib n <span style="color: #2e8b57;">0</span> <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span>fib <span style="color: #2e8b57;">10</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
55
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb84ecda" class="outline-2">
<h2 id="orgb84ecda"><span class="section-number-2">4.</span> Lecture 2A: Higher-Order Procedures</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgbf3efae" class="outline-3">
<h3 id="orgbf3efae"><span class="section-number-3">4.1.</span> Abstracting Procedural Ideas</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Consider the functions and their respective (recursive) procedures:
</p>

<p>
\[\sum_{i=a}^{b} i\]
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-int</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&gt;</span> a b<span style="color: #50a14f;">)</span>
      <span style="color: #2e8b57;">0</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> a
         <span style="color: #da8548;">(</span>sum-int <span style="color: #b751b6;">(</span>inc a<span style="color: #b751b6;">)</span> b<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>sum-int <span style="color: #2e8b57;">0</span> <span style="color: #2e8b57;">10</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
55
</pre>


<p>
\[\sum_{i=a}^{b} i^{2}\]
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-sq</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&gt;</span> a b<span style="color: #50a14f;">)</span>
      <span style="color: #2e8b57;">0</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>square a<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>sum-sq <span style="color: #b751b6;">(</span>inc a<span style="color: #b751b6;">)</span> b<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>sum-sq <span style="color: #2e8b57;">0</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
30
</pre>


<p>
\[\sum_{i=a_{\mathrm{~by~}4}}^{b} \frac{1}{i(i+2)}\]
</p>

<p>
Note that this series estimates \(\pi /8\).
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-pi</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&gt;</span> a b<span style="color: #50a14f;">)</span>
      <span style="color: #2e8b57;">0</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> <span style="color: #2e8b57;">1</span>
            <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> a <span style="color: #986801;">(</span><span style="color: #a626a4;">+</span> a <span style="color: #2e8b57;">2</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>sum-pi <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> a <span style="color: #2e8b57;">4</span><span style="color: #b751b6;">)</span> b<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">8</span> <span style="color: #a626a4;">(</span>sum-pi <span style="color: #2e8b57;">#i1</span> <span style="color: #2e8b57;">#i1000000</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
3.141590653589793
</pre>



<p>
See that the commonality between these procedures comes from the
fact that the notion of &ldquo;summation&rdquo; from <code>a</code> to <code>b</code> is the same,
but the <i>function</i> being summed is different in each case. Or, in
general form:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">&lt;name&gt;</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&gt;</span> a b<span style="color: #50a14f;">)</span>
      <span style="color: #2e8b57;">0</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>&lt;term&gt; a<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>&lt;name&gt; <span style="color: #b751b6;">(</span>&lt;next&gt; a<span style="color: #b751b6;">)</span> b<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The way to solve this is by writing a procedure <code>sum</code>, which has
available to it two procedures <code>term</code> and <code>next</code>. We supply these
as arguments. Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgde4d25d"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum</span> term a next b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&gt;</span> a b<span style="color: #50a14f;">)</span>
      <span style="color: #2e8b57;">0</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>term a<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>sum term <span style="color: #b751b6;">(</span>next a<span style="color: #b751b6;">)</span> next b<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
When we call <code>sum</code> recursively, see that we pass to it the <i>same
procedures</i> <code>term</code> and <code>next</code>, along with <code>b</code> and the next value of
<code>a</code>. Now, it is easy to define <code>sum-int</code>, <code>sum-sq</code>, and <code>sum-pi</code>
using <code>sum</code>, thus:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-int</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">identity</span> x<span style="color: #50a14f;">)</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>sum <span style="color: #a626a4;">identity</span>
       a
       inc
       b<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>sum-int <span style="color: #2e8b57;">0</span> <span style="color: #2e8b57;">10</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
55
</pre>


<p>
<code>identity</code> is the function \(p(x) = x\).
</p>

<div class="org-src-container">
<pre class="src src-racket">

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-sq</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>sum square
       a
       inc
       b<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>sum-sq <span style="color: #2e8b57;">0</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
30
</pre>


<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-pi</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>sum <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> <span style="color: #2e8b57;">1</span>
            <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> x <span style="color: #986801;">(</span><span style="color: #a626a4;">+</span> x <span style="color: #2e8b57;">2</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
       a
       <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> x <span style="color: #2e8b57;">4</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
       b<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">8</span> <span style="color: #a626a4;">(</span>sum-pi <span style="color: #2e8b57;">#i1</span> <span style="color: #2e8b57;">#i1000000</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
3.141590653589793
</pre>


<p>
Recall that <code>lambda</code> means &ldquo;make a procedure&rdquo; that is nameless. In
<code>sum-pi</code>, we choose to give <code>sum</code> anonymous functions as arguments
instead of defining our own, because there&rsquo;s no reason to name a
procedure we won&rsquo;t later use.
</p>

<p>
The big advantage of abstracting away <code>sum</code> this way is that in
case we want to implement it in a different way, we merely have to
change the implementation of one function (<code>sum</code>) and not that of
the three functions that use it. In fact, those functions can
remain exactly the same.
</p>

<p>
Here&rsquo;s another implementation of <code>sum</code>. See that <code>sum-pi</code> still
works without changes, because it doesn&rsquo;t care about how <code>sum</code> is
implemented as long as the argument number and order remains
constant.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum</span> term a next b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">iter</span> j ans<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">&gt;</span> j b<span style="color: #da8548;">)</span>
        ans
        <span style="color: #da8548;">(</span>iter <span style="color: #b751b6;">(</span>next j<span style="color: #b751b6;">)</span>
              <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> <span style="color: #986801;">(</span>term j<span style="color: #986801;">)</span>
                 ans<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>iter a <span style="color: #2e8b57;">0</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-pi</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>sum <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> <span style="color: #2e8b57;">1</span>
            <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> x <span style="color: #986801;">(</span><span style="color: #a626a4;">+</span> x <span style="color: #2e8b57;">2</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
       a
       <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> x <span style="color: #2e8b57;">4</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
       b<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">8</span> <span style="color: #a626a4;">(</span>sum-pi <span style="color: #2e8b57;">#i1</span> <span style="color: #2e8b57;">#i1000000</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
3.1415906535898936
</pre>
</div>
</div>

<div id="outline-container-orgfecddf1" class="outline-3">
<h3 id="orgfecddf1"><span class="section-number-3">4.2.</span> More on Square Roots</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Recall our square root procedure. When seen in Lisp code, it&rsquo;s not
very clear what it&rsquo;s doing, or how it&rsquo;s working.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org0d4a6e3"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">good-enough?</span> g<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">square</span> g<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> g g<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">abs</span> y<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">&lt;</span> y <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> y<span style="color: #b751b6;">)</span>
          y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&lt;</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> <span style="color: #986801;">(</span>square g<span style="color: #986801;">)</span> x<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
       <span style="color: #2e8b57;">0.0001</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">improve</span> g<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">average</span> y z<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> y z<span style="color: #b751b6;">)</span> <span style="color: #2e8b57;">2</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>average g <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> x g<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">try</span> g<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span>good-enough? g<span style="color: #da8548;">)</span>
        g
        <span style="color: #da8548;">(</span>try <span style="color: #b751b6;">(</span>improve g<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>try <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #2e8b57;">#i2</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1.4142156862745097
</pre>


<p>
Let&rsquo;s use higher-order procedure abstraction to make it clearer.
</p>
</div>

<div id="outline-container-org6a2588f" class="outline-4">
<h4 id="org6a2588f"><span class="section-number-4">4.2.1.</span> Fixed Points</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Recall that the algorithm itself relies on writing a function
</p>

<p>
\[f\colon y\mapsto \frac{y+\frac{x}{y}}{2}\]
</p>

<p>
Note that this works because \(f(\sqrt{x}) = \sqrt{x}\):
</p>

<p>
\[f(\sqrt{x})=\frac{\sqrt{x}+\frac{x}{\sqrt{x}}}{2} = \frac{2\sqrt{x}}{2} = \sqrt{x}\]
</p>

<p>
See that this is <i>actually</i> an algorithm for finding a fixed point
of a function \(f\), which is defined as finding the point where
\(f(z)=z\). This algorithm is merely an instance of a function \(f\)
whose fixed point happens to be the square root.
</p>

<blockquote>
<p>
For some functions, the fixed point can be found by iterating it.
</p>
</blockquote>

<p>
This is the top-level abstraction we&rsquo;ll write a function for.
First, let&rsquo;s see how we&rsquo;d write a square-root function by wishful
thinking:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org9711ec9">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>fixed-point
   <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>y<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>average <span style="color: #b751b6;">(</span><span style="color: #a626a4;">/</span> x y<span style="color: #b751b6;">)</span>
                        y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Now writing <code>fixed-point</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org69c859f">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">fixed-point</span> f start<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">close-enough-p</span> x y<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&lt;</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">abs</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> x y<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
       <span style="color: #2e8b57;">0.00001</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">iter</span> old <span style="color: #a626a4;">new</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span>close-enough-p old <span style="color: #a626a4;">new</span><span style="color: #da8548;">)</span>
        <span style="color: #a626a4;">new</span>
        <span style="color: #da8548;">(</span>iter <span style="color: #a626a4;">new</span> <span style="color: #b751b6;">(</span>f <span style="color: #a626a4;">new</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>iter start <span style="color: #50a14f;">(</span>f start<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Let&rsquo;s try it out!
</p>

<div class="org-src-container">
<pre class="src src-racket">

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #2e8b57;">#i2</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1.4142135623746899
</pre>
</div>
</div>

<div id="outline-container-orgc6d70b8" class="outline-4">
<h4 id="orgc6d70b8"><span class="section-number-4">4.2.2.</span> Damping Oscillations</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
A fair question when seeing the function
\[f_1\colon y\mapsto \frac{y+\frac{x}{y}}{2}\]
is why another function
\[f\colon y\mapsto \frac{x}{y}\]
wouldn&rsquo;t work in its place. This question is best
answered by trying to find its fixed point by iteration. Let&rsquo;s try
to find it for \(x=2\), starting at \(y=1\). Then,
</p>

<p>
\[f(1) = \frac{2}{1} = 2\]
\[f(2) = \frac{2}{2} = 1\]
\[f(1) = \frac{2}{1} = 2\]
\[f(2) = \frac{2}{2} = 1\]
\[~\dots\]
</p>

<p>
It seems that instead of converging, this function is
<i>oscillating</i> between two values. We know that it&rsquo;s easy to fix
this: we have to damp these oscillations. The most natural way to
do this is to take the average of successive values \(y\) and
\(f(y)\). A <code>sqrt</code> function that uses average damping would be:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgf43e139">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>fixed-point
   <span style="color: #50a14f;">(</span>avg-damp <span style="color: #da8548;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #b751b6;">(</span>y<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">/</span> x y<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The <code>avg-damp</code> function takes in a procedure, creates an average damping
procedure, and returns it. Or, in Lisp:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgd3fa1ca">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">avg-damp</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>f<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>average <span style="color: #b751b6;">(</span>f x<span style="color: #b751b6;">)</span> x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
It is worth discussing how <code>avg-damp</code> works. It is defined as a
procedure which takes the argument of a function <code>f</code>. It then
returns an anonymous procedure which takes an argument <code>x</code>, and
computes the average of \(f(x)\) and \(x\). This is finally the
highest level of abstraction we can reach for the <code>sqrt</code>
algorithm &#x2014; finding the fixed point of a damped oscillating
function.
</p>

<p>
Using the <code>sqrt</code> function,
</p>

<div class="org-src-container">
<pre class="src src-racket">

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #2e8b57;">#i2</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1.4142135623746899
</pre>
</div>
</div>
</div>

<div id="outline-container-org53d241c" class="outline-3">
<h3 id="org53d241c"><span class="section-number-3">4.3.</span> Newton&rsquo;s Method</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Newton&rsquo;s method is used to find the zeros of a function (\(y \ni
   f(y)=0\)). To use it, start with some guess \(y_0\). Then,
</p>

<p>
\[y_{n+1} = y_n - \frac{f(y_n)}{f'(y_n)}\]
</p>

<p>
where \[f'(y) = \frac{\mathrm{d}f(y)}{\mathrm{d}y}\]
</p>

<p>
We can, of course, find the zero of the square root finding function
\(f(y) =  x-y^2\) using Newton&rsquo;s method. Note that Newton&rsquo;s method
<i>itself</i> is based on fixed points, since it aims to find a fixed
point where \(y_{n+1}\approx y_n\).
</p>

<p>
Defining <code>sqrt</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org018560f">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>newton <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>y<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">-</span> x <span style="color: #b751b6;">(</span>square y<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
          <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
We pass to <code>newton</code> a function \(f(y)=x-y^2\), since its zero is \(x=y^2\).
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orga09ef5c">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">newton</span> f guess<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">df</span> <span style="color: #50a14f;">(</span>deriv f<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>fixed-point
   <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">-</span> x
                  <span style="color: #b751b6;">(</span><span style="color: #a626a4;">/</span> <span style="color: #986801;">(</span>f x<span style="color: #986801;">)</span>
                     <span style="color: #986801;">(</span>df x<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   guess<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>


<p>
It is important to note that defining <code>df</code> to be <code>(deriv f)</code> once
prevents wasteful recomputation of <code>df</code> every time <code>fixed-point</code>
calls itself.
</p>

<p>
Of course, we now have to define a derivative function. We can
simply use the standard limit definition to find it numerically:
</p>

<p>
\[f'(x) = \lim_{\Delta x\to 0} \frac{f(x+\Delta x) - f(x)}{\Delta
   x}\]
</p>

<p>
Or, in Lisp,
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org0ec6e2f"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">dx</span> <span style="color: #2e8b57;">0.0000001</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">deriv</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>f<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> <span style="color: #986801;">(</span>f <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">+</span> x dx<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
            <span style="color: #986801;">(</span>f x<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
         dx<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>


</pre>
</div>

<p>
This function returns a function which is the derivative of <code>f</code>,
and can be used as such. Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">(</span>deriv <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">2</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
12.000000584322379
</pre>


<p>
Which is the expected value of differentiating \(x^{3}\) w.r.t \(x\)
(\(3x^2\)) and evaluating at 2.
</p>

<p>
Testing out our <code>sqrt</code> function:
</p>

<div class="org-src-container">
<pre class="src src-racket">


<span style="color: #4078f2;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #2e8b57;">#i2</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1.4142135623747674
</pre>
</div>
</div>

<div id="outline-container-orge2f63fb" class="outline-3">
<h3 id="orge2f63fb"><span class="section-number-3">4.4.</span> Procedures are First-Class Citizens</h3>
<div class="outline-text-3" id="text-4-4">
<p>
This means that procedures can be:
</p>
<ul class="org-ul">
<li>Named using variables.</li>
<li>Passed as arguments to procedures.</li>
<li>Returned as values from procedures.</li>
<li>Included in data structures.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge671513" class="outline-2">
<h2 id="orge671513"><span class="section-number-2">5.</span> Lecture 2B: Compound Data</h2>
<div class="outline-text-2" id="text-5">
<p>
Consider our <code>sqrt</code> function that uses <code>good-enough?</code>. What we did
while writing <code>sqrt</code> is assume the existence of <code>good-enough?</code>.
That is, we divorced the task of building <code>sqrt</code> from the task of
implementing its parts.
</p>

<p>
Let&rsquo;s do this for data.
</p>
</div>

<div id="outline-container-org03ce235" class="outline-3">
<h3 id="org03ce235"><span class="section-number-3">5.1.</span> Rational Number Arithmetic</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Let&rsquo;s design a system which can add fractions:
\[\frac{1}{2}+\frac{1}{4}=\frac{3}{4}\]
and multiply them:
\[\frac{3}{4}\times \frac{2}{3} = \frac{1}{2}\]
</p>

<p>
The <i>procedures</i> for these two tasks are well known to most people:
</p>

<p>
\[\frac{n_1}{d_1} + \frac{n_2}{d_2} = \frac{n_1d_2+n_2d_2}{d_1d_2}\]
and
\[\frac{n_1}{d_1} \times \frac{n_2}{d_2} = \frac{n_1n_2}{d_1d_2}\]
</p>
</div>

<div id="outline-container-org8b2e938" class="outline-4">
<h4 id="org8b2e938"><span class="section-number-4">5.1.1.</span> Abstraction</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
We don&rsquo;t know, however, how to represent this data in a Lisp
procedure. Let&rsquo;s use our powerful &ldquo;wishful thinking&rdquo; strategy.
Assume that we have the following procedures available to us:
</p>

<ul class="org-ul">
<li>A constructor <code>(make-rat n d)</code> which makes a fraction with
numerator <code>n</code> and denominator <code>d</code>.</li>
<li>Two selectors:
<ul class="org-ul">
<li><code>(numer x)</code> which takes in a fraction <code>x</code> and returns its
numerator.</li>
<li><code>(denom x)</code> which takes in a fraction <code>x</code> and returns its
denominator.</li>
</ul></li>
</ul>

<p>
Then, our procedures are easy to write:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org26eb420"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+rat</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-rat
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span>numer x<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>denom y<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span>numer y<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>denom x<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #da8548;">(</span>denom x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>denom y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*rat</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-rat
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #da8548;">(</span>numer x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>numer y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #da8548;">(</span>denom x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>denom y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Why do we need this data object abstraction anyway? We could very
well define <code>+rat</code> to take in four numbers, two numerators and two
denominators. But to return, we can&rsquo;t return <i>both</i> numerator and
denominator. We now have to define two summation functions, one for
the numerator and one for the denominator, and somehow keep track
of the fact that one of these numbers is the numerator and the other
the denominator. Furthermore, when applying more complex operations
like:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span>*rat <span style="color: #a626a4;">(</span>+rat x y<span style="color: #a626a4;">)</span>
      <span style="color: #a626a4;">(</span>+rat s t<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The data abstraction helps. If it weren&rsquo;t there, we&rsquo;d have to
maintain some temporary registers to store the numerator and
denominator values of the <code>+rat</code> operations into, then pass them to
<code>*rat</code>.
</p>

<p>
Worse than confusing the program, such a design philosophy would
confuse us, the programmers.
</p>
</div>
</div>

<div id="outline-container-orgd9251e1" class="outline-4">
<h4 id="orgd9251e1"><span class="section-number-4">5.1.2.</span> Data Object Creation</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
The glue we use to stick two numbers together is provided by three
Lisp primitives:
</p>
<ul class="org-ul">
<li>A constructor <code>cons</code>, which generates an ordered pair.</li>
<li>Two selectors:
<ul class="org-ul">
<li><code>car</code>, which selects the first element of the pair, and</li>
<li><code>cdr</code>, which selects the second element of the pair.</li>
</ul></li>
</ul>

<p>
In use,
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">x</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> x<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cdr</span> x<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1
2
</pre>


<p>
We can now write the procedures that we&rsquo;d deferred writing
earlier:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgac8f7c5"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-rat</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">numer</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">denom</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">


<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">x</span> <span style="color: #a626a4;">(</span>make-rat <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">y</span> <span style="color: #a626a4;">(</span>make-rat <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">z</span> <span style="color: #a626a4;">(</span>+rat x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>numer z<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>denom z<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
6
8
</pre>


<p>
Agh. We forgot to reduce results to the simplest form. We can
easily include this in the <code>make-rat</code> procedure:<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgb426645"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-rat</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">g</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">gcd</span> x y<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> x g<span style="color: #da8548;">)</span>
          <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> y g<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">numer</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">denom</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Note that we could shift the <code>gcd</code> bit to functions <code>numer</code> and
<code>denom</code>, which would display the simplest form at access time
rather than creation time. Deciding between the two is a matter of
system efficiency: a system which displays often should use
creation time simplification, while a system which creates many
fractions should use access time simplification.
We now need a GCD function:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org3829de8"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">gcd</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">=</span> b <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
      a
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">gcd</span> b <span style="color: #da8548;">(</span><span style="color: #a626a4;">remainder</span> a b<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
We can now use <code>+rat</code> in <i>exactly</i> the same way, since the
interface is the same. This is the advantage of abstraction.
</p>

<div class="org-src-container">
<pre class="src src-racket">


<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">x</span> <span style="color: #a626a4;">(</span>make-rat <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">y</span> <span style="color: #a626a4;">(</span>make-rat <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">z</span> <span style="color: #a626a4;">(</span>+rat x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>numer z<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>denom z<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
3
4
</pre>


<p>
Excellent: we now have a working system. The data abstraction
model can be visualised as follows:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><code>+rat</code>, <code>*rat</code> &#x2026;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>make-rat</code>, <code>numer</code>, <code>denom</code></td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><code>gcd</code></td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Pairs</td>
</tr>
</tbody>
</table>

<p>
At each layer of abstraction, we merely care about the usage of
the lower layers and not their implementation or underlying
representation.
</p>
</div>
</div>
</div>

<div id="outline-container-org72d05e8" class="outline-3">
<h3 id="org72d05e8"><span class="section-number-3">5.2.</span> Representing Points on a Plane</h3>
<div class="outline-text-3" id="text-5-2">
<p>
This is now an easy problem &#x2014; the code should be
self-explanatory.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgeaf7cc2"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-vec</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">xcor</span> v<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> v<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">ycor</span> v<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> v<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
We could now define a segment as a pair of vectors:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org9e4dbde"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-seg</span> v w<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> v w<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">seg-start</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> s<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">seg-end</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> s<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Some sample operations:
</p>

<div class="org-src-container">
<pre class="src src-racket">





<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">midpoint</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">a</span> <span style="color: #b751b6;">(</span>seg-start s<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #6a1868;">b</span> <span style="color: #b751b6;">(</span>seg-end s<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>make-vec
     <span style="color: #da8548;">(</span>average <span style="color: #b751b6;">(</span>xcor a<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>xcor b<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
     <span style="color: #da8548;">(</span>average <span style="color: #b751b6;">(</span>ycor a<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>ycor b<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">length</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">dx</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> <span style="color: #986801;">(</span>xcor <span style="color: #4db5bd;">(</span>seg-end s<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
               <span style="color: #986801;">(</span>xcor <span style="color: #4db5bd;">(</span>seg-start s<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #6a1868;">dy</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">-</span> <span style="color: #986801;">(</span>ycor <span style="color: #4db5bd;">(</span>seg-end s<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
               <span style="color: #986801;">(</span>ycor <span style="color: #4db5bd;">(</span>seg-start s<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span>square dx<span style="color: #b751b6;">)</span>
             <span style="color: #b751b6;">(</span>square dy<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">side-a</span> <span style="color: #a626a4;">(</span>make-vec <span style="color: #2e8b57;">#i3</span> <span style="color: #2e8b57;">#i0</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">side-b</span> <span style="color: #a626a4;">(</span>make-vec <span style="color: #2e8b57;">#i0</span> <span style="color: #2e8b57;">#i4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">segment</span> <span style="color: #a626a4;">(</span>make-seg side-a side-b<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">length</span> segment<span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">mp</span> <span style="color: #a626a4;">(</span>midpoint segment<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>xcor mp<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>ycor mp<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
5.000000000053722
1.5
2.0
</pre>


<p>
The abstraction layer diagram of this code is:
</p>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Segments</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Vectors</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Pairs</td>
</tr>
</tbody>
</table>

<p>
It is interesting to note that segments are pairs of vectors,
which are pairs of numbers, so segments are actually pairs of
pairs. Represented as a tree:
</p>

<p>
This property is called <i>closure</i> (from abstract algebra<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>): that means
of combination can be nested recursively. It&rsquo;s an important and
powerful technique.
</p>

<p>
For instance, a three-dimensional vector can be represented by a
pair whose one element is a number and whose other element is a
pair of numbers. Or, in Lisp:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">three-d-vec</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">3</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">5</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> three-d-vec<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> three-d-vec<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cdr</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> three-d-vec<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
3
4
5
</pre>
</div>
</div>

<div id="outline-container-org7c4b657" class="outline-3">
<h3 id="org7c4b657"><span class="section-number-3">5.3.</span> Pairs</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Let&rsquo;s go back to when we assumed that <code>make-rat</code>, <code>numer</code>, and
<code>denom</code>, were already implemented. The procedures we then wrote
were written using <i>abstract data</i>, with the only &ldquo;assured&rdquo;
property being that:
</p>

<p class="verse">
<code>if x = (make-rat n d):</code><br />
<br />
&#xa0;&#xa0;\(\displaystyle \frac{\mathtt{numer~x}}{\mathtt{denom~x}} = \frac{\mathtt{n}}{\mathtt{d}}\)<br />
</p>

<p>
Beyond this basic &ldquo;spec&rdquo;, or the interface contract, we know
nothing about its implementation.
</p>

<p>
Now, it&rsquo;s easy not to appreciate how knowing <i>merely</i> the
specification of the layer below is sufficient to use it, so let&rsquo;s
discuss how pairs work. When we wanted to implement <code>make-rat</code>, we
kind of &ldquo;cheated&rdquo; in that we said, &ldquo;Okay, Lisp has a primitive to
do this so we don&rsquo;t have to implement a pair.&rdquo; Let&rsquo;s now take a
look at a possible implementation of a pair that doesn&rsquo;t use data
objects at all, and instead mimics them from thin air. Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgf0accc6"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">our-cons</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>pick<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">cond</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #a626a4;">=</span> pick <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span> a<span style="color: #da8548;">)</span>
          <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #a626a4;">=</span> pick <span style="color: #2e8b57;">2</span><span style="color: #b751b6;">)</span> b<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">our-car</span> x<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span>x <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">our-cdr</span> x<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span>x <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">pair</span> <span style="color: #a626a4;">(</span>our-cons <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>our-car pair<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>our-cdr pair<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
3
4
</pre>


<p>
Before thinking about how it works: consider the fact that Lisp&rsquo;s
pairs could be implemented this way, and not only would we not know
about this while implementing <code>make-rat</code> &#x2014; we wouldn&rsquo;t care,
since it&rsquo;s below the level of abstraction we&rsquo;re working at. As long
as it behaves the way we expect it to &#x2014; that is, it follows the
&ldquo;spec&rdquo;, we don&rsquo;t know or care about its implementation<sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup>. Such is the
power of abstraction.
</p>

<p>
Now, how is this implementation even working? Well:
</p>
<ul class="org-ul">
<li><p>
<code>cons</code> is a procedure that returns a lambda (anonymous procedure)
which, by the substitution model, looks like:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #a626a4;">(</span>pick<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> pick <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">3</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> pick <span style="color: #2e8b57;">2</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">4</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div></li>
<li><code>car</code> expects this procedure as an input, and returns the result of
supplying this procedure with the value 1. This is naturally the
first of the two numbers given to <code>cons</code> (<code>a</code>).</li>
<li><code>cdr</code> is identical to <code>car</code>, except that <i>it</i> supplies the input
procedure with argument 2 to get <code>b</code>.</li>
</ul>

<p>
We can thus implement a pair &ldquo;data structure&rdquo; using only lambdas.
In fact, these pairs are closed:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">three-d-vec</span> <span style="color: #a626a4;">(</span>our-cons <span style="color: #2e8b57;">3</span> <span style="color: #50a14f;">(</span>our-cons <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">5</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>our-car three-d-vec<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>our-car <span style="color: #a626a4;">(</span>our-cdr three-d-vec<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>our-cdr <span style="color: #a626a4;">(</span>our-cdr three-d-vec<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>our-cdr three-d-vec<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
3
4
5
#&lt;procedure:...6f_i/ob-2136OZJ.rkt:4:2&gt;
</pre>


<p>
It is worth thinking about the structure of <code>three-d-vec</code>:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #a626a4;">(</span>pick<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> pick <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">3</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> pick <span style="color: #2e8b57;">2</span><span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #b751b6;">(</span>pick<span style="color: #b751b6;">)</span>
                      <span style="color: #b751b6;">(</span><span style="color: #e45649;">cond</span> <span style="color: #986801;">(</span><span style="color: #4db5bd;">(</span><span style="color: #a626a4;">=</span> pick <span style="color: #2e8b57;">1</span><span style="color: #4db5bd;">)</span> <span style="color: #2e8b57;">4</span><span style="color: #986801;">)</span>
                            <span style="color: #986801;">(</span><span style="color: #4db5bd;">(</span><span style="color: #a626a4;">=</span> pick <span style="color: #2e8b57;">2</span><span style="color: #4db5bd;">)</span> <span style="color: #2e8b57;">5</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Picking <code>2</code> in the top-level lambda gives us another lambda, in
which we can pick either the first number (4) or the second (5).
Note that this is precisely the nested pair structure we were going
for.
</p>
</div>
</div>
</div>

<div id="outline-container-org5af9518" class="outline-2">
<h2 id="org5af9518"><span class="section-number-2">6.</span> Lecture 3A: Henderson Escher Example</h2>
<div class="outline-text-2" id="text-6">
<p>
Recall our vector procedures:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-vec</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">xcor</span> v<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> v<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">ycor</span> v<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> v<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
We could define more procedures using these:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org8d55b8c"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+vect</span> v1 v2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-vec
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>xcor v1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>xcor v2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>ycor v1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>ycor v2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">scale</span> v s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-vec
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> s <span style="color: #da8548;">(</span>xcor v<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> s <span style="color: #da8548;">(</span>ycor v<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Recall that our representation of a line segment was as a pair of
vectors, or pair of pairs. That is, we can use the property of
closure that pairs have to store any amount of data.
</p>
</div>

<div id="outline-container-org405a9d2" class="outline-3">
<h3 id="org405a9d2"><span class="section-number-3">6.1.</span> Lists</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Often, we want to store a sequence of data. Using pairs, there are
many ways to do this, for instance:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">1</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">3</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
((1 . 2) 3 . 4)
((1 2 . 3) . 4)
</pre>


<p>
However, we want to establish a conventional way of dealing with
sequences, to prevent having to make ad-hoc choices. Lisp uses a
representation called a list:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">1</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">2</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">3</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">4</span> nil<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(1 2 3 4)
</pre>


<p>
Note that the <code>nil</code> represents the null or empty list. Since
writing so many <code>cons</code> is painful, Lisp provides the primitive
<code>list</code> which lets us build such a structure.
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #a626a4;">list</span> <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(1 2 3 4)
</pre>


<p>
Note that <code>list</code> is merely syntactic sugar for building up using
pairs:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org2955317"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">one-to-four</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">list</span> <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> one-to-four<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cdr</span> one-to-four<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> one-to-four<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cdr</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> one-to-four<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cdr</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">cdr</span> one-to-four<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cdr</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cdr</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">cdr</span> one-to-four<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1
(2 3 4)
2
(3 4)
4
()
</pre>


<p>
Note that the empty list, <code>nil</code>, is also represented by <code>()</code>. This
way of walking down the list for elements is called <code>cdr</code>-ing down
a list, but it&rsquo;s a bit painful. Thus, when we want to process
lists, we write procedures.
</p>
</div>

<div id="outline-container-org687965c" class="outline-4">
<h4 id="org687965c"><span class="section-number-4">6.1.1.</span> Procedures on Lists</h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
Say we wanted to write a procedure <code>scale-list</code> which multiplies
every element in the list by a certain value. That is, when scale
list is called on <code>one-to-four</code> with value 10, it returns <code>(10 20
    30 40)</code>. Here&rsquo;s one possible (recursive) implementation:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">scale-list</span> l scale<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">null?</span> l<span style="color: #50a14f;">)</span>
      nil
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> scale <span style="color: #b751b6;">(</span><span style="color: #a626a4;">car</span> l<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
            <span style="color: #da8548;">(</span>scale-list <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> l<span style="color: #b751b6;">)</span> scale<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>scale-list one-to-four <span style="color: #2e8b57;">10</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(10 20 30 40)
</pre>


<p>
<code>null?</code> is a predicate which tells us whether the given input is
the empty list. This will be the case at the end of the list.
Of course, this is <i>actually</i> a general method for processing all
values of a list and returning another list, so we write a
higher-order procedure which applies a procedure to all elements
of a list and returns the result as a list, called <code>map</code>.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org392a4b9"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">map</span> p l<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">null?</span> l<span style="color: #50a14f;">)</span>
      nil
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #da8548;">(</span>p <span style="color: #b751b6;">(</span><span style="color: #a626a4;">car</span> l<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
            <span style="color: #da8548;">(</span><span style="color: #a626a4;">map</span> p <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> l<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Now defining <code>scale-list</code> in terms of <code>map</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket">

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">scale-list</span> l s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">map</span> <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x s<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
       l<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>scale-list one-to-four <span style="color: #2e8b57;">20</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(20 40 60 80)
</pre>


<p>
We can now square lists:
</p>
<div class="org-src-container">
<pre class="src src-racket">


<span style="color: #4078f2;">(</span><span style="color: #a626a4;">map</span> square one-to-four<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(1 4 9 16)
</pre>


<p>
Similar to <code>map</code>, we define a higher-order procedure <code>for-each</code>,
which, instead of <code>cons</code>-ing a list and returning it, simply
applies to procedure to each element of the list.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org6c36d8e"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">for-each</span> proc l<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">null?</span> l<span style="color: #da8548;">)</span> done<span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
         <span style="color: #da8548;">(</span>proc <span style="color: #b751b6;">(</span><span style="color: #a626a4;">car</span> l<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #a626a4;">for-each</span> proc <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> l<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgaeb3ba0" class="outline-3">
<h3 id="orgaeb3ba0"><span class="section-number-3">6.2.</span> Henderson&rsquo;s Picture Language</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Let&rsquo;s define a language. As usual, we&rsquo;ll concern ourselves with its
primitives, means of combination, and means of abstraction,
implementing some of this language in Lisp along the way.
</p>
</div>


<div id="outline-container-org85ef784" class="outline-4">
<h4 id="org85ef784"><span class="section-number-4">6.2.1.</span> Primitives</h4>
<div class="outline-text-4" id="text-6-2-1">
<p>
This language has only one primitive: &ldquo;picture&rdquo;, which is a figure
scaled to fit a frame.
</p>
</div>
</div>


<div id="outline-container-org6afee3b" class="outline-4">
<h4 id="org6afee3b"><span class="section-number-4">6.2.2.</span> Means of Combination and Operations</h4>
<div class="outline-text-4" id="text-6-2-2">
<ul class="org-ul">
<li>Rotate, which rotates a picture and returns it.</li>
<li>Flip, which flips the picture across an axis and returns it.</li>
<li>Beside, which takes two pictures and a scale, then puts the two
next to each other, returning a picture.</li>
<li>Above, like beside, but above.</li>
</ul>

<p>
See that the closure property (that an operation on pictures
returns a picture)<sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup> allows us to combine these operations/means of
combination to build complex pictures with ease.
</p>

<p>
Let&rsquo;s now implement this part of the language.
</p>
</div>
</div>

<div id="outline-container-orge535d82" class="outline-4">
<h4 id="orge535d82"><span class="section-number-4">6.2.3.</span> An Implementation</h4>
<div class="outline-text-4" id="text-6-2-3">
</div>
<ol class="org-ol">
<li><a id="orga48f00a"></a>Frames<br />
<div class="outline-text-5" id="text-6-2-3-1">
<p>
Three vectors are needed to uniquely identify a frame on the
plane. By convention, we take these to be the bottom left corner
(&ldquo;origin&rdquo;), the bottom right corner (&ldquo;horizontal&rdquo;) and the top
left corner (&ldquo;vertical&rdquo;). Their positions can be described
relative to the \((0,0)\) of the display screen. Therefore,
frame is implemented by:
</p>
<ul class="org-ul">
<li>Constructor <code>make-frame</code>.</li>
<li>Selectors <code>origin</code>, <code>horiz</code>, and <code>vert</code>, for the three vectors.</li>
</ul>

<p>
Note that technically, a frame describes a transformation of
the unit square, where each point in the unit square:
\[(x,y)\mapsto \mathtt{origin} + x\cdot \mathtt{horiz} + y\cdot
     \mathtt{vert}\]
</p>

<p>
We can define a procedure which returns a procedure which maps
a pair of points \((x,y)\) on the unit square to a given frame:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">coord-map</span> rect<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>point<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>+vect
     <span style="color: #da8548;">(</span>+vect <span style="color: #b751b6;">(</span>scale <span style="color: #986801;">(</span>xcor point<span style="color: #986801;">)</span>
                   <span style="color: #986801;">(</span>horiz rect<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
            <span style="color: #b751b6;">(</span>scale <span style="color: #986801;">(</span>ycor point<span style="color: #986801;">)</span>
                   <span style="color: #986801;">(</span>vert rect<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
     <span style="color: #da8548;">(</span>origin rect<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
<code>coord-map</code> returns a procedure which given a point will map it
correctly to <code>rect</code>.
</p>
</div>
</li>

<li><a id="orgc36713a"></a>Pictures<br />
<div class="outline-text-5" id="text-6-2-3-2">
<p>
We can now easily define a procedure which makes a picture:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-picture</span> seglist<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>rect<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #a626a4;">for-each</span>
     <span style="color: #da8548;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #b751b6;">(</span>s<span style="color: #b751b6;">)</span>
       <span style="color: #b751b6;">(</span>drawline
        <span style="color: #986801;">(</span><span style="color: #4db5bd;">(</span>coord-map rect<span style="color: #4db5bd;">)</span> <span style="color: #4db5bd;">(</span>seg-start s<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
        <span style="color: #986801;">(</span><span style="color: #4db5bd;">(</span>coord-map rect<span style="color: #4db5bd;">)</span> <span style="color: #4db5bd;">(</span>seg-end s<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
     seglist<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Well, relatively easily. Let&rsquo;s explain what <code>make-picture</code>
actually does:
</p>

<ul class="org-ul">
<li>Takes argument <code>seglist</code>, which is a list of line segments
(pairs of vectors) that the picture is.</li>
<li>Returns a procedure which:
<ul class="org-ul">
<li>Takes the argument of a frame.</li>
<li>For every element in <code>seglist</code>:
<ul class="org-ul">
<li>Draws the segment within frame, by scaling it correctly
using <code>coord-map</code>.</li>
<li>This is done by giving <code>coord-map</code> the frame to scale
to.</li>
<li>The procedure returned by <code>coord-map</code> then scales the
vectors <code>(seg-start s)</code> and <code>(seg-end s)</code> to the frame.</li>
<li>This can now be drawn by <code>drawline</code>, since it has as
arguments two points.</li>
</ul></li>
</ul></li>
</ul>

<p>
Note that a picture is <i>actually</i> a procedure which draws itself
inside a given frame, and <code>make-picture</code> generates this
procedure from a <code>seglist</code>. Or, in use:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">R</span> <span style="color: #a626a4;">(</span>make-frame <span style="color: #a52a2a; font-style: italic;">;</span><span style="color: #a52a2a; font-style: italic;">some vectors</span>
           <span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">draw-george-in-frame</span> <span style="color: #a626a4;">(</span>make-picture <span style="color: #a52a2a; font-style: italic;">;</span><span style="color: #a52a2a; font-style: italic;">some seglist</span>
                <span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>draw-george-in-frame R<span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="org7c711ea"></a>Beside<br />
<div class="outline-text-5" id="text-6-2-3-3">
<p>
<code>beside</code> needs to draw two pictures on the screen, after scaling
them correctly (by <code>a</code>) and placing them side by side. Thus,
<code>beside</code> returns a picture which takes in an argument <code>rect</code>.
<code>beside</code> starts drawing the left picture at <code>(origin rect),
     (scale a (horiz rect)) (vert rect)</code> and the right picture at
<code>(+vect (origin rect) (scale a (horiz rect))), (scale (- 1 a)
     (horiz rect)), (vert rect)</code>. This places the two pictures side by
side and scales them correctly within <code>rect</code>. Or, in Lisp,
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">beside</span> p1 p2 a<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>rect<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>p1 <span style="color: #da8548;">(</span>make-frame
         <span style="color: #b751b6;">(</span>origin rect<span style="color: #b751b6;">)</span>
         <span style="color: #b751b6;">(</span>scale a <span style="color: #986801;">(</span>horiz rect<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
         <span style="color: #b751b6;">(</span>vert rect<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>p2 <span style="color: #da8548;">(</span>make-frame
         <span style="color: #b751b6;">(</span>+vect <span style="color: #986801;">(</span>origin rect<span style="color: #986801;">)</span>
                <span style="color: #986801;">(</span>scale a <span style="color: #4db5bd;">(</span>horiz rect<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
         <span style="color: #b751b6;">(</span>scale <span style="color: #986801;">(</span><span style="color: #2e8b57;">-1</span> a<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>horiz rect<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
         <span style="color: #b751b6;">(</span>vert rect<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</li>

<li><a id="org7c6cfd9"></a>Rotate-90<br />
<div class="outline-text-5" id="text-6-2-3-4">
<p>
To rotate a picture by 90 degrees counter-clockwise, all we have
to do is make the <code>origin</code> shift to where <code>horiz</code> is, then draw
the new <code>horiz</code> and <code>vert</code> correctly. With some vector algebra,
the procedure in Lisp is:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">rot90</span> pict<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>rect<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>pict <span style="color: #da8548;">(</span>make-frame
           <span style="color: #b751b6;">(</span>+vect <span style="color: #986801;">(</span>origin rect<span style="color: #986801;">)</span>
                  <span style="color: #986801;">(</span>horiz rect<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
           <span style="color: #b751b6;">(</span>vert rect<span style="color: #b751b6;">)</span>
           <span style="color: #b751b6;">(</span>scale <span style="color: #2e8b57;">-1</span> <span style="color: #986801;">(</span>horiz rect<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>


<div id="outline-container-orgb934905" class="outline-4">
<h4 id="orgb934905"><span class="section-number-4">6.2.4.</span> Means of Abstraction</h4>
<div class="outline-text-4" id="text-6-2-4">
<p>
See that the picture language is now embedded in Lisp. We can
write recursive procedures to modify a picture:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">right-push</span> pict n a<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">=</span> n <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
      pict
      <span style="color: #50a14f;">(</span>beside pict
              <span style="color: #da8548;">(</span>right-push pict <span style="color: #b751b6;">(</span>dec n<span style="color: #b751b6;">)</span> a<span style="color: #da8548;">)</span>
              a<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
We can even write a higher order procedure for &ldquo;pushing&rdquo;:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">push</span> comb<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>pict n a<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>repeated
      <span style="color: #b751b6;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #986801;">(</span>p<span style="color: #986801;">)</span>
        <span style="color: #986801;">(</span>comb pict p a<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
      n<span style="color: #da8548;">)</span>
     pict<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">right-push</span> <span style="color: #a626a4;">(</span>push beside<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
There&rsquo;s a lot to learn from this example:
</p>
<ul class="org-ul">
<li>We&rsquo;re embedding a language inside Lisp. All of Lisp&rsquo;s power is
available to this small language now: including recursion.</li>
<li>There&rsquo;s no difference between a procedure and data: we&rsquo;re
passing pictures around exactly like data, even though it&rsquo;s
actually a procedure.</li>
<li>We&rsquo;ve created a layered system of abstractions on top of Lisp,
which allows <i>each layer</i> to have all of Lisp&rsquo;s expressive
power. This is contrasted to a designing such a system bottom-up
as a tree, which would mean that:
<ul class="org-ul">
<li>Each node does a very specific purpose and is limited in
complexity because a new feature has to be built ground-up at
the node.</li>
<li>Making a change is near impossible, since there&rsquo;s no higher
order procedural abstraction. Making a change that affects
more than one node is a nightmare.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org0a522e0" class="outline-2">
<h2 id="org0a522e0"><span class="section-number-2">7.</span> Lecture 3B: Symbolic Differentiation; Quotation</h2>
<div class="outline-text-2" id="text-7">
<p>
We saw that robust system design involves insensitivity to small
changes, and that embedding a language within Lisp allows this. Let
us turn to a somewhat similar thread, solving the problem of
symbolic differentiation in Lisp.
</p>

<p>
This problem is somewhat different from <i>numerical</i> differentiation
of a function like we did for Newton&rsquo;s method, since we actually
want the expressions we work with to be in an algebraic language.
Before figuring out how to implement such a thing, let&rsquo;s talk about
the operation of differentiation itself.
</p>
</div>

<div id="outline-container-org9cc96cc" class="outline-3">
<h3 id="org9cc96cc"><span class="section-number-3">7.1.</span> Differentiation v. Integration</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Why is it so much easier to differentiate than to integrate?
Let us look at the basic rules of differentiation:
</p>

<p>
\[\frac{\mathrm{d}k}{\mathrm{d}x} = 0\]
\[\frac{\mathrm{d}x}{\mathrm{d}x} = 1\]
\[\frac{\mathrm{d}k\cdot a}{\mathrm{d}x} = k\cdot \frac{\mathrm{d}a}{\mathrm{d}x}\]
\[\frac{\mathrm{d}(a+b)}{\mathrm{d}x} =
   \frac{\mathrm{d}a}{\mathrm{d}x} + \frac{\mathrm{d}b}{\mathrm{d}x}\]
\[\frac{\mathrm{d}(ab)}{\mathrm{d}x} =  a\cdot
   \frac{\mathrm{d}b}{\mathrm{d}x} +
   \frac{\mathrm{d}a}{\mathrm{d}x}\cdot b\]
\[\frac{\mathrm{d}x^{n}}{\mathrm{d}x} = nx^{n-1}\]
</p>

<p>
See that these rules are reduction rules, in that the derivative of
some complex thing is the derivative of simpler things joined
together by basic operations. Such reduction rules are naturally
recursive in nature. This makes the problem of differentiation very
easy to solve using simple algorithms.
</p>

<p>
On the other hand, implementing an integration system is a much
harder problem, since such a system would require us to go the
other way, combining up simpler expressions to make more
complicated ones, which often involves an intrinsically difficult
choice to make.
</p>

<p>
With these simple recursive rules in mind, let&rsquo;s implement a
symbolic differentiation system.
</p>
</div>
</div>

<div id="outline-container-orgc14e771" class="outline-3">
<h3 id="orgc14e771"><span class="section-number-3">7.2.</span> Some Wishful Thinking</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">
<pre class="src src-racket" id="orgcc40803"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">deriv</span> expr var<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>constant? expr var<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>same-var? expr var<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>sum? expr<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>make-sum <span style="color: #b751b6;">(</span>deriv <span style="color: #986801;">(</span>a1 expr<span style="color: #986801;">)</span> var<span style="color: #b751b6;">)</span>
                   <span style="color: #b751b6;">(</span>deriv <span style="color: #986801;">(</span>a2 expr<span style="color: #986801;">)</span> var<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>product? expr<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>make-sum
          <span style="color: #b751b6;">(</span>make-product <span style="color: #986801;">(</span>m1 expr<span style="color: #986801;">)</span>
                        <span style="color: #986801;">(</span>deriv <span style="color: #4db5bd;">(</span>m2 expr<span style="color: #4db5bd;">)</span> var<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span>make-product <span style="color: #986801;">(</span>deriv <span style="color: #4db5bd;">(</span>m1 expr<span style="color: #4db5bd;">)</span> var<span style="color: #986801;">)</span>
                        <span style="color: #986801;">(</span>m2 expr<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>


<p>
That&rsquo;s enough rules for now, we can add more later.
</p>

<p>
Note that <code>a1</code> is a procedure returning the first term of the
addition \(x+y\) (in this case, \(x\)), and <code>a2</code> is a procedure
returning the second (in this case, \(y\)). Similar for
multiplication, <code>m1</code> and <code>m2</code>.
</p>

<p>
All the -<code>?</code> procedures are predicates, and should be
self-explanatory. <code>make-</code>, as expected, makes the object with given
arguments as values and returns it. These are a level of
abstraction below <code>deriv</code>, and involve the actual representation of
algebraic expressions. Let&rsquo;s figure out how to do this.
</p>
</div>
</div>

<div id="outline-container-orga797fc9" class="outline-3">
<h3 id="orga797fc9"><span class="section-number-3">7.3.</span> Representing Algebraic Expressions</h3>
<div class="outline-text-3" id="text-7-3">
</div>
<div id="outline-container-orgea076ff" class="outline-4">
<h4 id="orgea076ff"><span class="section-number-4">7.3.1.</span> Using Lisp Syntax</h4>
<div class="outline-text-4" id="text-7-3-1">
<p>
One very simple way to represent expressions is to use Lisp&rsquo;s way:
expressions that form trees. Consider:
</p>

<p>
\[ax^{2} \mapsto \mathtt{(*~a~(*~x~x))}\] \[bx+c \mapsto \mathtt{(
    \mathtt{+} ~(*~b~x)~c)}\]
</p>

<p>
This has the advantage that representing such expression is just a
list. Moreover, finding out the operation is merely the <code>car</code> of
the list, and the operands are the <code>cdr</code>. This effectively
eliminates our need for parsing algebraic expressions.
</p>
</div>
</div>

<div id="outline-container-orgf2878ad" class="outline-4">
<h4 id="orgf2878ad"><span class="section-number-4">7.3.2.</span> Representation Implementation</h4>
<div class="outline-text-4" id="text-7-3-2">
<p>
Let&rsquo;s start defining our procedures.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orge01eecf"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">constant?</span> expr var<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">and</span> <span style="color: #50a14f;">(</span>atom? expr<span style="color: #50a14f;">)</span>
       <span style="color: #50a14f;">(</span><span style="color: #a626a4;">not</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">eq?</span> expr var<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">same-var?</span> expr var<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">and</span> <span style="color: #50a14f;">(</span>atom? expr<span style="color: #50a14f;">)</span>
       <span style="color: #50a14f;">(</span><span style="color: #a626a4;">eq?</span> expr var<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum?</span> expr<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">and</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">not</span> <span style="color: #da8548;">(</span>atom? expr<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
       <span style="color: #50a14f;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">car</span> expr<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'+</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">product?</span> expr<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">and</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">not</span> <span style="color: #da8548;">(</span>atom? expr<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
       <span style="color: #50a14f;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">car</span> expr<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'*</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
We see a new form here: <code>'+</code> and <code>'*</code>. This is called &ldquo;quoting&rdquo;.
Why do we need to do this? Consider:
</p>

<p class="verse">
&ldquo;Say your name!&rdquo;<br />
&ldquo;Susanne.&rdquo;<br />
&ldquo;Say &lsquo;your name&rsquo;!&rdquo;<br />
&ldquo;Your name.&rdquo;<br />
</p>

<p>
To differentiate the cases where we mean <i>literally</i> say &ldquo;your
name&rdquo; and the case where we actually ask what &ldquo;your name&rdquo; <i>is</i>, we
use quotation marks in English. Similarly, quoting a symbol in
Lisp tells the interpreter to check <i>literally</i> for <code>(car expr)</code>
to be the symbol <code>+</code> and not the procedure <code>+</code>.
</p>

<p>
Quotation is actually quite a complicated thing. Following the
principle of substituting equals for equals, consider:
</p>

<p class="verse">
&ldquo;Chicago&rdquo; has seven letters.<br />
Chicago is the biggest city in Illinois.<br />
&ldquo;The biggest city in Illinois&rdquo; has seven letters.<br />
</p>

<p>
The first two statements are true, and quotation marks are used
correctly in the first to show that we&rsquo;re talking about Chicago
the word and not Chicago the city. However, the third statement is
wrong entirely (although it is the result of changing equals for
equals), because the phrase &ldquo;The biggest city in Illinois&rdquo; does
not have seven letters.
That is, we cannot substitute equals for equals in referentially
opaque contexts.
</p>

<p>
Note that the <code>'</code> symbol breaks the neat pattern of Lisp where all
expressions are delimited by <code>()</code>. To resolve this, we introduce
the special form <code>(quote +)</code>, which does the exactly same thing as
<code>'+</code>.
</p>

<p>
Now defining the constructors:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgdd9af16"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-sum</span> a1 a2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">list</span> <span style="color: #2e8b57;">'+</span> a1 a2<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-product</span> m1 m2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">list</span> <span style="color: #2e8b57;">'*</span> m1 m2<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>


<p>
Finally, we must define the selectors:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org23886a5"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a1</span> <span style="color: #a626a4;">cadr</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a2</span> <span style="color: #a626a4;">caddr</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">m1</span> <span style="color: #a626a4;">cadr</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">m2</span> <span style="color: #a626a4;">caddr</span><span style="color: #4078f2;">)</span>
</pre>
</div>


<p>
<code>cadr</code> is the <code>car</code> of the <code>cdr</code> and <code>caddr</code> is the <code>car</code> of the
<code>cdr</code> of the <code>cdr</code>. These are forms provided for convenience while
programming, since list processing a big part of Lisp.<sup><a id="fnr.5" class="footref" href="#fn.5" role="doc-backlink">5</a></sup>
</p>

<p>
Let&rsquo;s try it out:
</p>

<div class="org-src-container">
<pre class="src src-racket">





<span style="color: #4078f2;">(</span>deriv '<span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> a <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> b x<span style="color: #da8548;">)</span> c<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">'x</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>deriv '<span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> a <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> b x<span style="color: #da8548;">)</span> c<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">'a</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>deriv '<span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> a <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> b x<span style="color: #da8548;">)</span> c<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">'b</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>deriv '<span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> a <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> b x<span style="color: #da8548;">)</span> c<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">'c</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(+ (+ (* a (+ (* x 1) (* 1 x))) (* 0 (* x x))) (+ (+ (* b 1) (* 0 x)) 0))
(+ (+ (* a (+ (* x 0) (* 0 x))) (* 1 (* x x))) (+ (+ (* b 0) (* 0 x)) 0))
(+ (+ (* a (+ (* x 0) (* 0 x))) (* 0 (* x x))) (+ (+ (* b 0) (* 1 x)) 0))
(+ (+ (* a (+ (* x 0) (* 0 x))) (* 0 (* x x))) (+ (+ (* b 0) (* 0 x)) 1))
</pre>


<p>
Note the recursive nature of <code>deriv</code>: the process creates results
with the same shape even when we differentiate with respect to
some other variable. This is because the recursion only ends when
an expression is decomposed to either <code>same-var?</code> or <code>constant?</code>.
</p>
</div>
</div>

<div id="outline-container-org5e0e99b" class="outline-4">
<h4 id="org5e0e99b"><span class="section-number-4">7.3.3.</span> Simplification</h4>
<div class="outline-text-4" id="text-7-3-3">
<p>
However, these results are ugly, and we know why &#x2014; there&rsquo;s no
simplification. Technically, it&rsquo;s correct:
</p>

\begin{align*}
&a(1x+1x) + 0x^{2} + b + 0x + 0\\
=& 2ax + b
\end{align*}

<p>
Note that we&rsquo;ve faced this same problem before with fractions, and
recall that the solution was to change the constructors so that
they&rsquo;d simplify while creating the lists. Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgf0740b8"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-sum</span> a1 a2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #e45649;">and</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> a1<span style="color: #b751b6;">)</span>
              <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> a2<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> a1 a2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #e45649;">and</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> a1<span style="color: #b751b6;">)</span>
              <span style="color: #b751b6;">(</span><span style="color: #a626a4;">=</span> a1 <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         a2<span style="color: #50a14f;">)</span>
         <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #e45649;">and</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> a2<span style="color: #b751b6;">)</span>
              <span style="color: #b751b6;">(</span><span style="color: #a626a4;">=</span> a2 <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
          a1<span style="color: #50a14f;">)</span>
         <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
          <span style="color: #da8548;">(</span><span style="color: #a626a4;">list</span> <span style="color: #2e8b57;">'+</span> a1 a2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-product</span> m1 m2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #e45649;">and</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> m1<span style="color: #b751b6;">)</span>
              <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> m2<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> m1 m2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #e45649;">and</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> m1<span style="color: #b751b6;">)</span>
              <span style="color: #b751b6;">(</span><span style="color: #a626a4;">=</span> m1 <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
         <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #e45649;">and</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> m2<span style="color: #b751b6;">)</span>
              <span style="color: #b751b6;">(</span><span style="color: #a626a4;">=</span> m2 <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
          <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
         <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #e45649;">and</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> m1<span style="color: #b751b6;">)</span>
               <span style="color: #b751b6;">(</span><span style="color: #a626a4;">=</span> m1 <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
          m2<span style="color: #50a14f;">)</span>
         <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #e45649;">and</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">number?</span> m2<span style="color: #b751b6;">)</span>
               <span style="color: #b751b6;">(</span><span style="color: #a626a4;">=</span> m2 <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
          m1<span style="color: #50a14f;">)</span>
         <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
          <span style="color: #da8548;">(</span><span style="color: #a626a4;">list</span> <span style="color: #2e8b57;">'+</span> m1 m2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Now trying <code>deriv</code>:
</p>


<div class="org-src-container">
<pre class="src src-racket">





<span style="color: #4078f2;">(</span>deriv '<span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> a <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> b x<span style="color: #da8548;">)</span> c<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">'x</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>deriv '<span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> a <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> b x<span style="color: #da8548;">)</span> c<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">'a</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>deriv '<span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> a <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> b x<span style="color: #da8548;">)</span> c<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">'b</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>deriv '<span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> a <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> b x<span style="color: #da8548;">)</span> c<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">'c</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(+ (+ a (+ x x)) b)
(* x x)
x
1
</pre>


<p>
Excellent, these are much better. Note, of course, that we could
simplify the first one further, but, in general, algebraic
simplification is a painful problem, since the definition of
simplest form varies with application. However, this is good
enough.
</p>
</div>
</div>
</div>

<div id="outline-container-org9b6a17c" class="outline-3">
<h3 id="org9b6a17c"><span class="section-number-3">7.4.</span> On Abstract Syntax</h3>
<div class="outline-text-3" id="text-7-4">
<p>
Note that the syntax we used was abstract in the sense that it had
its own rules and grammar. However, since it followed Lisp&rsquo;s syntax
closely, we needed quotation to allow full expression.
</p>

<p>
This is a powerful paradigm: not only can we use meta-linguistic
abstraction to create languages embedded within Lisp, but we can
also use Lisp to interpret any syntax. We&rsquo;ll see more of this in
the future.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf8507a0" class="outline-2">
<h2 id="orgf8507a0"><span class="section-number-2">8.</span> Lecture 4A: Pattern Matching and Rule-Based Substitution</h2>
<div class="outline-text-2" id="text-8">
<p>
It&rsquo;s a funny technique we used last time, converting the rules of
differentiation to Lisp. In fact, if we wanted to explain (say) the
rules of algebra to the computer, we&rsquo;d have to again create a
similar program which converts the rules of algebra to Lisp.
</p>

<p>
See that there&rsquo;s a higher-order idea here, of explaining rules to
Lisp and having the rules applied to an input expression to
&ldquo;simplify&rdquo; it. Our style of writing a rule-based substitution
program is:
</p>

<p>
Rules &rarr; conditional &rarr; dispatch
</p>

<p>
That is, we try the rules on the given expression. If there&rsquo;s a
match, we &ldquo;dispatch&rdquo; the result to substitute. Now, in general, the
application of a rule is:
</p>

<ul class="org-ul">
<li>Compare LHS of rule to input expression.</li>
<li>If match, RHS with substituted values is replacement.</li>
</ul>

<p>
Or, diagrammatically:
</p>

<p>
Let us now build a simple language to express these rules, which can
then be pattern matched, skeletons created, then instantiated.
</p>
</div>

<div id="outline-container-org6197baf" class="outline-3">
<h3 id="org6197baf"><span class="section-number-3">8.1.</span> Rule Language</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Here&rsquo;s a sample bit of what we want the rule language to look like:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgd55fbf2"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">deriv-rules</span>
  '<span style="color: #a626a4;">(</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>dd <span style="color: #b751b6;">(</span>?c c<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>? v<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>dd <span style="color: #b751b6;">(</span>?v v<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>? v<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>dd <span style="color: #b751b6;">(</span>?v u<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>? v<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>

    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>dd <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span>?c c<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? x<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>? v<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> c<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>dd <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> x<span style="color: #986801;">)</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> v<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>

    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>dd <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> <span style="color: #986801;">(</span>? x1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? x2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>? v<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
     <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span>dd <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> x1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> v<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
        <span style="color: #b751b6;">(</span>dd <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> x2<span style="color: #986801;">)</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> v<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>

    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>dd <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span>? x1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? x2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>? v<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
     <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> x1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>dd <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">:</span> x2<span style="color: #4db5bd;">)</span> <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">:</span> v<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
        <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> x2<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>dd <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">:</span> x1<span style="color: #4db5bd;">)</span> <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">:</span> v<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #a52a2a; font-style: italic;">; </span><span style="color: #a52a2a; font-style: italic;">...</span>
    <span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
It is worth explaining what this syntax means exactly, because
eventually, we want to parse it.
</p>

<p>
The rules are a list of pairs. The <code>car</code> of each pair is the
pattern to match (rule LHS), and the <code>cdr</code> is the skeleton
substitution expression (rule RHS).
</p>
</div>

<div id="outline-container-orgd912052" class="outline-4">
<h4 id="orgd912052"><span class="section-number-4">8.1.1.</span> Pattern Matching</h4>
<div class="outline-text-4" id="text-8-1-1">
<p>
The idea of the LHS language is to provide a framework where
certain constructs can be matched and possibly named. These names
will then be passed to the skeleton instantiator.<sup><a id="fnr.6" class="footref" href="#fn.6" role="doc-backlink">6</a></sup>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Syntax</th>
<th scope="col" class="org-left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>foo</code></td>
<td class="org-left">Matches itself literally.</td>
</tr>

<tr>
<td class="org-left"><code>(f a b)</code></td>
<td class="org-left">Matches every 3-list whose <code>car</code> is <code>f</code>, <code>cadr</code> is <code>a</code>, and <code>caddr</code> is <code>b</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(? x)</code></td>
<td class="org-left">Matches any expression, and calls it <code>x</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(?c x)</code></td>
<td class="org-left">Matches an expression which is a constant, and calls it <code>x</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(?v x)</code></td>
<td class="org-left">Matches an expression which is a variable, and calls it <code>x</code>.</td>
</tr>
</tbody>
</table>
</div>
</div>


<div id="outline-container-orgc43c06e" class="outline-4">
<h4 id="orgc43c06e"><span class="section-number-4">8.1.2.</span> Skeleton and Instantiation</h4>
<div class="outline-text-4" id="text-8-1-2">
<p>
The RHS language provides a skeleton wherein values provided by
the LHS language can be substituted.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Syntax</th>
<th scope="col" class="org-left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>foo</code></td>
<td class="org-left">Instantiates <code>foo</code>.</td>
</tr>

<tr>
<td class="org-left"><code>(f a b)</code></td>
<td class="org-left">Instantiates each element of the list and returns a list.</td>
</tr>

<tr>
<td class="org-left"><code>(: x)</code></td>
<td class="org-left">Instantiate the value of <code>x</code> provided by the pattern matcher.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org69f34f7" class="outline-3">
<h3 id="org69f34f7"><span class="section-number-3">8.2.</span> Desired Behaviour</h3>
<div class="outline-text-3" id="text-8-2">
<p>
We expect to use this program by calling a procedure called
<code>simplifier</code>, to which we provide the list of rules. The procedure
should return another procedure, which is able to apply the rules
to a given input expression. Or, in Lisp:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">dsimp</span>
  <span style="color: #a626a4;">(</span>simplifier deriv-rules<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>dsimp '<span style="color: #a626a4;">(</span>dd <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> x y<span style="color: #50a14f;">)</span> x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example" id="org99fb63e">
(+ 1 0)
</pre>
</div>
</div>

<div id="outline-container-org857d022" class="outline-3">
<h3 id="org857d022"><span class="section-number-3">8.3.</span> Implementation</h3>
<div class="outline-text-3" id="text-8-3">
<p>
We implement a procedure <code>match</code>, which takes a pattern, an
expression, and a dictionary as arguments. If that pattern matches
the expression, it writes the <code>?</code> values to the dictionary and
returns it. Next, we implement <code>instantiate</code>, which takes as
arguments a skeleton and a dictionary, and substitutes variables in
the skeleton with their dictionary values. Finally, this new
expression is returned to the <code>match</code>-er to match more patterns.
Finally, we implement <code>simplify</code>, which takes in a list of the
rules and applies these in a match-instantiate cycle until the
expression cannot be further simplified (no more change after a
round of match-instantiate).
</p>
</div>

<div id="outline-container-org04f071e" class="outline-4">
<h4 id="org04f071e"><span class="section-number-4">8.3.1.</span> Matcher</h4>
<div class="outline-text-4" id="text-8-3-1">
<p>
Abstractly, the job of the matcher is to do a tree traversal and
comparison. Consider the rule LHS: <code>(+ (* (? x) (? y)) (? y))</code>,
and an expression to match: <code>(+ (* 3 x) x)</code> (say). Then, the trees
are:
</p>

<p>
Clearly, these expressions should be matched in the tree
traversal. Don&rsquo;t confuse the <code>(? x)</code> in the rule LHS with the
symbol <code>x</code> in the expression: for the rule, it&rsquo;s just a matching
variable, but the <code>x</code> in the expression goes into the dictionary.
</p>

<p>
Let&rsquo;s now write our first implementation of <code>match</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">match</span> pat expr dict<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">eq?</span> dict <span style="color: #2e8b57;">'failed</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'failed</span><span style="color: #50a14f;">)</span>
        <span style="color: #a52a2a; font-style: italic;">; </span><span style="color: #a52a2a; font-style: italic;">... some other cases</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>atom? expr<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'failed</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
         <span style="color: #da8548;">(</span><span style="color: #a626a4;">match</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> pat<span style="color: #b751b6;">)</span>
                 <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> expr<span style="color: #b751b6;">)</span>
                 <span style="color: #b751b6;">(</span><span style="color: #a626a4;">match</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> pat<span style="color: #986801;">)</span>
                         <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> expr<span style="color: #986801;">)</span>
                         dict<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Before we write the entire procedure, let&rsquo;s observe how the
general case (<code>else</code>) works, because that&rsquo;s the bit which does the
tree traversal. It calls <code>match</code> on the <code>car</code> of the pattern and
expression. If they match, we return a dictionary, which is then
used to match the <code>cdr</code> of the original expression. Why does this
do tree traversal? Well, it&rsquo;s basically a depth first search on a
tree. Consider what happens when <code>match</code> is called on the <code>car</code>.
After being called for the <code>caar</code> and <code>caaar</code>&#x2026;it&rsquo;ll eventually
be called for the <code>cadr</code> and the <code>caddr</code> and so on. That&rsquo;s
precisely what a depth first search is. It&rsquo;ll keep going deeper
and deeper until it fails, which is when it takes one step back
and goes deeper into another branch.
</p>

<p>
Now, it is important to define the non-general cases, especially
the ones that terminate <code>match</code>. The most important of these is
when the expression passed is atomic, since that means we&rsquo;re at
the leaf of the expression tree. Another possible failure is the
insertion into the dictionary failing. How is this possible?
Consider:
</p>

<p>
Just before <code>match</code> reaches the last leaf (boxed), our dictionary will look
something like the following:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">rule-vars</th>
<th scope="col" class="org-left">expr-vals</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">x</td>
<td class="org-left">3</td>
</tr>

<tr>
<td class="org-left">y</td>
<td class="org-left">x</td>
</tr>
</tbody>
</table>

<p>
However, when it tries to insert <code>y: q</code>, the dictionary will
<code>failed</code> to do so, because <code>y</code> already has value <code>x</code>, and thus the
rule does not match.
</p>

<p>
Finally, we implement as more cases in the <code>cond</code> other things we
may need to match, according to the rule language (<a href="#org6197baf">8.1</a>).
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org9f7098c"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">match</span> pattern expression dict<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">eq?</span> dict <span style="color: #2e8b57;">'failed</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'failed</span><span style="color: #50a14f;">)</span>

        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>atom? pattern<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>atom? expression<span style="color: #b751b6;">)</span>
             <span style="color: #b751b6;">(</span><span style="color: #e45649;">if</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">eq?</span> pattern expression<span style="color: #986801;">)</span>
                 dict
                 <span style="color: #2e8b57;">'failed</span><span style="color: #b751b6;">)</span>
             <span style="color: #2e8b57;">'failed</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>

        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>arbitrary-constant? pattern<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>constant? expression<span style="color: #b751b6;">)</span>
             <span style="color: #b751b6;">(</span>extend-dict pattern expression dict<span style="color: #b751b6;">)</span>
             <span style="color: #2e8b57;">'failed</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>

        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>arbitrary-variable? pattern<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>variable? expression<span style="color: #b751b6;">)</span>
             <span style="color: #b751b6;">(</span>extend-dict pattern expression dict<span style="color: #b751b6;">)</span>
             <span style="color: #2e8b57;">'failed</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>

        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>arbitrary-expression? pattern<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>extend-dict pattern expression dict<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>

        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>atom? expression<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'failed</span><span style="color: #50a14f;">)</span>

        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
         <span style="color: #da8548;">(</span><span style="color: #a626a4;">match</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> pattern<span style="color: #b751b6;">)</span>
                 <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> expression<span style="color: #b751b6;">)</span>
                 <span style="color: #b751b6;">(</span><span style="color: #a626a4;">match</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> pattern<span style="color: #986801;">)</span>
                         <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> expression<span style="color: #986801;">)</span>
                         dict<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
We add one case wherein both the pattern to be matched and the
expression are atomic and the same, (the case <code>foo</code> in <a href="#org6197baf">8.1</a>), in which we simply return the dictionary, since the
pattern matches. The other new cases are self-explanatory: they are
merely matching <code>(?c)</code>, <code>(?v)</code>, and <code>(?)</code>.
</p>
</div>
</div>


<div id="outline-container-orge6daa5f" class="outline-4">
<h4 id="orge6daa5f"><span class="section-number-4">8.3.2.</span> Instantiator</h4>
<div class="outline-text-4" id="text-8-3-2">
<p>
Recall that instantiate must take accept the input of a skeleton
and a dictionary, traverse the skeleton tree, and replace rule
variables for expression values according to the dictionary. That
is, given the tree:
</p>

<p>
And the dictionary <code>(x: 3, y: 4)</code>, it should produce the tree:
</p>

<p>
This is a fairly simple procedure to write:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org27bd34b"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">instantiate</span> skeleton dict<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>atom? skeleton<span style="color: #da8548;">)</span> skeleton<span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>skeleton-evaluation? skeleton<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>evaluate <span style="color: #b751b6;">(</span>evaluation-expression skeleton<span style="color: #b751b6;">)</span>
                   dict<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">instantiate</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> skeleton<span style="color: #986801;">)</span> dict<span style="color: #b751b6;">)</span>
                    <span style="color: #b751b6;">(</span><span style="color: #a626a4;">instantiate</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">cdr</span> skeleton<span style="color: #986801;">)</span> dict<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The general case is our usual tree recursion: it first
instantiates the <code>car</code>, then <code>cons</code>&rsquo; that with the instantiated
<code>cdr</code>. The depth-first search ends if the leaf is atomic, as
usual.
</p>

<p>
The interesting bit is what we do when we want to evaluate a
skeleton of the <code>(:)</code> form (predicate <code>skeleton-evaluation?</code>). In
this case, we call a procedure <code>evaluate</code>, to which we pass the
expression to be evaluated (the <code>cadr</code>, really, since we don&rsquo;t
need the <code>:</code>).
</p>

<p>
Now, <code>evaluate</code> works in a special way we&rsquo;ll see later, so take on
faith that the following <code>evaluate</code> function does its job of
instantiation the way we want it to:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgb6c3672"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">evaluation-expression</span> evaluation<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cadr</span> evaluation<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">evaluate</span> form dict<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>atom? form<span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span>lookup form dict<span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #e45649;">apply</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">eval</span> <span style="color: #b751b6;">(</span>lookup <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> form<span style="color: #986801;">)</span> dict<span style="color: #b751b6;">)</span>
                   user-initial-environment<span style="color: #da8548;">)</span>
             <span style="color: #da8548;">(</span><span style="color: #a626a4;">map</span> <span style="color: #b751b6;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #986801;">(</span>v<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>lookup v dict<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
                  <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> form<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd0da5e5" class="outline-4">
<h4 id="orgd0da5e5"><span class="section-number-4">8.3.3.</span> GIGO Simplifier</h4>
<div class="outline-text-4" id="text-8-3-3">
<p>
The GIGO (garbage in, garbage out)<sup><a id="fnr.7" class="footref" href="#fn.7" role="doc-backlink">7</a></sup> simplifier is implemented
by stringing together the matcher, the instantiator, and the list
of rules we are given as an input. We write it in lexically scoped
style, because the procedures within it are merely helpers.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgdfb3f2b"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">simplifier</span> the-rules<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">simplify-expression</span> expression<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>try-rules
     <span style="color: #da8548;">(</span><span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span>compound? expression<span style="color: #b751b6;">)</span>
         <span style="color: #b751b6;">(</span><span style="color: #a626a4;">map</span> simplify-expression expression<span style="color: #b751b6;">)</span>
         expression<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">try-rules</span> expression<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">scan</span> rules<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">null?</span> rules<span style="color: #b751b6;">)</span>
          expression
          <span style="color: #b751b6;">(</span><span style="color: #e45649;">let</span> <span style="color: #986801;">(</span><span style="color: #4db5bd;">(</span><span style="color: #6a1868;">dict</span> <span style="color: #a2b6da;">(</span><span style="color: #a626a4;">match</span> <span style="color: #9cb6ad;">(</span>pattern <span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> rules<span style="color: #4078f2;">)</span><span style="color: #9cb6ad;">)</span>
                        expression
                        <span style="color: #9cb6ad;">(</span>make-empty-dict<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
            <span style="color: #986801;">(</span><span style="color: #e45649;">if</span> <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">eq?</span> dict <span style="color: #2e8b57;">'failed</span><span style="color: #4db5bd;">)</span>
                <span style="color: #4db5bd;">(</span>scan <span style="color: #a2b6da;">(</span><span style="color: #a626a4;">cdr</span> rules<span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span>
                <span style="color: #4db5bd;">(</span>simplify-expression <span style="color: #a2b6da;">(</span><span style="color: #a626a4;">instantiate</span>
                                         <span style="color: #9cb6ad;">(</span>skeleton <span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> rules<span style="color: #4078f2;">)</span><span style="color: #9cb6ad;">)</span>
                                         dict<span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
  <span style="color: #50a14f;">(</span>scan the-rules<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  simplify-expression<span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Okay, there&rsquo;s a fair amount to break down here.
</p>
<ul class="org-ul">
<li><code>simplify-expression</code> tries <i>all</i> the rules on every node in the
given expression tree. It does this using our (by now) standard
depth first tree recursion. In this case, the leaf is an atomic
expression. The general case is when the expression is compound,
in which case we try to simplify the <code>car</code>. If this doesn&rsquo;t
work, we try the <code>cdr</code>, recursively. This fulfils our objective
of trying all rules on all nodes. Note that instead of doing the
recursion explicitly, we use <code>map</code>. This doesn&rsquo;t make a
difference, it is merely somewhat easier to write.</li>
<li><code>try-rules</code> accepts an expression as an input, and scans the
input list of rules, applying each in turn using <code>scan</code>.</li>
<li><code>scan</code> takes the pattern of the first rule in the list and tries
to match it to the expression. If it succeeds, we instantiate
the skeleton of this rule with the values from the dictionary.
On the other hand, if the <code>match</code> failed, we simply try the rest
of the rules (<code>cdr</code>).</li>
<li>Finally, <code>simplifier</code> returns the <code>simplify-expression</code>
procedure, which can apply <code>the-rules</code> to any input expression.
Note that this is what the desired behaviour is (<a href="#org69f34f7">8.2</a>).</li>
</ul>
</div>
</div>

<div id="outline-container-org75b5215" class="outline-4">
<h4 id="org75b5215"><span class="section-number-4">8.3.4.</span> Dictionary Implementation</h4>
<div class="outline-text-4" id="text-8-3-4">
<p>
The actual dictionary implementation isn&rsquo;t of much interest to us,
since it has much more to do with Lisp primitives we&rsquo;ll study
later than our program.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org1b48fca"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-empty-dict</span><span style="color: #a626a4;">)</span> '<span style="color: #a626a4;">()</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">extend-dict</span> pat dat dictionary<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">vname</span> <span style="color: #b751b6;">(</span>variable-name pat<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">let</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #6a1868;">v</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">assq</span> vname dictionary<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">cond</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">not</span> v<span style="color: #986801;">)</span>
             <span style="color: #986801;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">list</span> vname dat<span style="color: #4db5bd;">)</span> dictionary<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
            <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">cadr</span> v<span style="color: #4db5bd;">)</span> dat<span style="color: #986801;">)</span> dictionary<span style="color: #b751b6;">)</span>
            <span style="color: #b751b6;">(</span><span style="color: #e45649;">else</span> <span style="color: #2e8b57;">'failed</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">lookup</span> var dictionary<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">v</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">assq</span> var dictionary<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">null?</span> v<span style="color: #da8548;">)</span>
        var
        <span style="color: #da8548;">(</span><span style="color: #a626a4;">cadr</span> v<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf474d66" class="outline-4">
<h4 id="orgf474d66"><span class="section-number-4">8.3.5.</span> Predicates</h4>
<div class="outline-text-4" id="text-8-3-5">
<p>
Finally, we must implement the predicates we&rsquo;ve used throughout.
These are simple to implement and self-explanatory:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org5cf62a5"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">compound?</span> <span style="color: #a626a4;">exp</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">pair?</span> <span style="color: #a626a4;">exp</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">constant?</span> <span style="color: #a626a4;">exp</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">number?</span> <span style="color: #a626a4;">exp</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">variable?</span> <span style="color: #a626a4;">exp</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span>atom? <span style="color: #a626a4;">exp</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">pattern</span> rule<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> rule<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">skeleton</span> rule<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cadr</span> rule<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">arbitrary-constant?</span> pat<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">pair?</span> pat<span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">car</span> pat<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'?c</span><span style="color: #50a14f;">)</span> <span style="color: #a626a4;">false</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">arbitrary-expression?</span> pat<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">pair?</span> pat<span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">car</span> pat<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'?</span><span style="color: #50a14f;">)</span> <span style="color: #a626a4;">false</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">arbitrary-variable?</span> pat<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">pair?</span> pat<span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">car</span> pat<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'?v</span><span style="color: #50a14f;">)</span> <span style="color: #a626a4;">false</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">variable-name</span> pat<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cadr</span> pat<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">skeleton-evaluation?</span> pat<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">pair?</span> pat<span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">car</span> pat<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">':</span><span style="color: #50a14f;">)</span> <span style="color: #a626a4;">false</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org049aebc" class="outline-3">
<h3 id="org049aebc"><span class="section-number-3">8.4.</span> Usage</h3>
<div class="outline-text-3" id="text-8-4">
<div class="org-src-container">
<pre class="src src-racket">







<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">dsimp</span>
  <span style="color: #a626a4;">(</span>simplifier deriv-rules<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>dsimp '<span style="color: #a626a4;">(</span>dd <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #50a14f;">)</span> x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(+ (* x 1) (* x 1))
</pre>


<p>
Excellent &#x2014; it works. Note that there is no algebraic
simplification. Witness now the power of abstraction &#x2014; all we
really have to do is define some rules for algebraic
simplification, and pass the result of <code>dsimp</code> to <code>algsimp</code> to get
a clean expression.
</p>
</div>

<div id="outline-container-orgc83dc07" class="outline-4">
<h4 id="orgc83dc07"><span class="section-number-4">8.4.1.</span> Algebraic Simplification</h4>
<div class="outline-text-4" id="text-8-4-1">
<p>
Consider the rule set:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orga101fb5"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">algebra-rules</span>
  '<span style="color: #a626a4;">(</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span>? op<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>?c c1<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>?c c2<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>                <span style="color: #da8548;">(</span><span style="color: #a626a4;">:</span> <span style="color: #b751b6;">(</span>op c1 c2<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>                <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span>? op<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>?  e <span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>?c c <span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>                <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> op<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> c<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> e<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>          <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #2e8b57;">0</span> <span style="color: #b751b6;">(</span>? e<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>                             <span style="color: #da8548;">(</span><span style="color: #a626a4;">:</span> e<span style="color: #da8548;">)</span>                         <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">1</span> <span style="color: #b751b6;">(</span>? e<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>                             <span style="color: #da8548;">(</span><span style="color: #a626a4;">:</span> e<span style="color: #da8548;">)</span>                         <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">0</span> <span style="color: #b751b6;">(</span>? e<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>                             <span style="color: #2e8b57;">0</span>                             <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span>?c c1<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span>?c c2<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? e <span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>          <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">*</span> c1 c2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> e<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>       <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span>?  e1<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span>?c c <span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? e2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>          <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> c <span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>  <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span>? e1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? e2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>? e3<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>            <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> e1<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e2<span style="color: #986801;">)</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e3<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>  <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span>?c c1<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> <span style="color: #986801;">(</span>?c c2<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? e <span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>          <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">+</span> c1 c2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> e<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>       <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span>?  e1<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> <span style="color: #986801;">(</span>?c c <span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? e2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>          <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> c <span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>  <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> <span style="color: #986801;">(</span>? e1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? e2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>? e3<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>            <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> e1<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e2<span style="color: #986801;">)</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e3<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>  <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span>?c c1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? e<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span>?c c2<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? e<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">+</span> c1 c2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">:</span> e<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>       <span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span>? e1<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> <span style="color: #986801;">(</span>? e2<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>? e3<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>            <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e1<span style="color: #986801;">)</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">:</span> e2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>         <span style="color: #50a14f;">)</span>
    <span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-racket">








<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">dsimp</span>
  <span style="color: #a626a4;">(</span>simplifier deriv-rules<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">algsimp</span>
  <span style="color: #a626a4;">(</span>simplifier algebra-rules<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">derivative</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>algsimp <span style="color: #50a14f;">(</span>dsimp x<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>derivative '<span style="color: #a626a4;">(</span>dd <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #50a14f;">)</span> x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>derivative '<span style="color: #a626a4;">(</span>dd <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">+</span> x <span style="color: #b751b6;">(</span><span style="color: #a626a4;">*</span> x <span style="color: #2e8b57;">5</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x x<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> x<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(+ x x)
(+ 6 (+ x x))
</pre>


<p>
We now have a complete pattern matching and replacement language at
our disposal, and we&rsquo;ve tested it out on the rules of
differentiation and algebraic simplification.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org2ebea32" class="outline-2">
<h2 id="org2ebea32"><span class="section-number-2">9.</span> Lecture 4B: Generic Operators</h2>
<div class="outline-text-2" id="text-9">
<p>
We&rsquo;ve seen that data abstraction separates the use of data objects
from its representation. Unfortunately, this is not sufficient for
complex systems.
</p>

<p>
Consider a situation where there are multiple representation
designers and they cannot agree on a single uniform representation.
This makes the use complicated, since the user has to use different
operators for different representations of the same object, creating
clutter.
</p>

<p>
One of the ways to solve such a problem is to enforce a standard for
representations, but this is often impossible. Alternately, we could
make a generic set of operators for the user that work on any kind
of representation correctly and without complaint. Diagrammatically:
</p>

<p>
Moreover, note that it won&rsquo;t be too hard to add another
representation R4, because all it needs to do is fit in the
generic operators architecture.
</p>

<p>
Throughout the rest of this lecture, we discuss the application of
various generic operator techniques on an extended example: first
representing complex numbers in rectangular and polar form, and then
expanding this to include the entire real number system.
</p>
</div>

<div id="outline-container-org28b6f1e" class="outline-3">
<h3 id="org28b6f1e"><span class="section-number-3">9.1.</span> Dispatch on Type</h3>
<div class="outline-text-3" id="text-9-1">
</div>
<div id="outline-container-org2935e24" class="outline-4">
<h4 id="org2935e24"><span class="section-number-4">9.1.1.</span> On Complex Numbers</h4>
<div class="outline-text-4" id="text-9-1-1">
<p>
Complex numbers are represented in the complex plane as:
</p>

<p>
It should be clear that for a complex number \(z=|z|e^{i\theta}=x+iy\):
\[|z|=\sqrt{x^{2}+y^{2}}\]
\[\theta = \arctan{\frac{y}{x}}\]
\[x=|z|\cos{\theta}\]
\[y=|z|\sin{\theta}\]
</p>

<p>
Let us say we want to add, subtract, multiply, and divide complex
numbers. The most natural way to add is using rectangular form:
</p>

<p>
\[\Re{(z_1+z_2)} = \Re{(z_1)} + \Re{(z_2)}\]
\[\Im{(z_1+z_2)} = \Im{(z_1)} + \Im{(z_2)}\]
</p>

<p>
However, the most natural way to multiply is using polar form:
</p>

<p>
\[|z_1z_2|=|z_1||z_2|\]
\[\theta{(z_1z_2)} = \theta{(z_1)}+\theta{(z_2)}\]
</p>
</div>
</div>

<div id="outline-container-org4ca6d08" class="outline-4">
<h4 id="org4ca6d08"><span class="section-number-4">9.1.2.</span> Arithmetic Implementation</h4>
<div class="outline-text-4" id="text-9-1-2">
<p>
Let&rsquo;s implement the four basic arithmetic operations. As in the
case of rational numbers, we assume the availability of the
constructors and selectors:
</p>

<pre class="example" id="orgfdb6bf8">
(make-rect x y)
(make-pol magnitude theta)
(real z)
(img z)
(mag z)
(ang z)
</pre>

<p>
Then,
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgee68358"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+c</span> z1 z2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-rect
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>real z1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>real z2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>img z1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>img z2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">-c</span> z1 z2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-rect
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">-</span> <span style="color: #da8548;">(</span>real z1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>real z2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">-</span> <span style="color: #da8548;">(</span>img z1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>img z2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*c</span> z1 z2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-pol
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #da8548;">(</span>mag z1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>mag z2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>ang z1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>ang z2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">/c</span> z1 z2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-pol
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">/</span> <span style="color: #da8548;">(</span>mag z1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>mag z2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">-</span> <span style="color: #da8548;">(</span>ang z1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>ang z2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ea318d" class="outline-4">
<h4 id="org7ea318d"><span class="section-number-4">9.1.3.</span> George&rsquo;s Representation</h4>
<div class="outline-text-4" id="text-9-1-3">
<p>
George loves the rectangular form of complex numbers. He therefore
implements the constructors and selectors in the following way:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-rect</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">real</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">img</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-pol</span> r a<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> r <span style="color: #da8548;">(</span><span style="color: #a626a4;">cos</span> a<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> r <span style="color: #da8548;">(</span><span style="color: #a626a4;">sin</span> a<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">mag</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>square <span style="color: #b751b6;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
           <span style="color: #da8548;">(</span>square <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">ang</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">atan</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc1114fd" class="outline-4">
<h4 id="orgc1114fd"><span class="section-number-4">9.1.4.</span> Martha&rsquo;s Representation</h4>
<div class="outline-text-4" id="text-9-1-4">
<p>
Martha, on the other hand, much prefers the polar representation.
She implements the constructors and selectors as:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-pol</span> r a<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> r a<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">mag</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">ang</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">real</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #50a14f;">)</span>
     <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cos</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">img</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #50a14f;">)</span>
     <span style="color: #50a14f;">(</span><span style="color: #a626a4;">sin</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-rect</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #da8548;">(</span>square x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>square y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">atan</span> y x<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Naturally, George&rsquo;s representation is better if we want to use
<code>+c</code> a lot, while Martha&rsquo;s is better if we want to use <code>*c</code> a lot.
Often, it&rsquo;s impossible to choose between two equally good
representations. The solution is to use generic selectors and
constructors. Diagrammatically:
</p>
</div>
</div>


<div id="outline-container-org0030df8" class="outline-4">
<h4 id="org0030df8"><span class="section-number-4">9.1.5.</span> Type Dispatch Manager</h4>
<div class="outline-text-4" id="text-9-1-5">
<p>
One of our chief problems is that when we have a pair that&rsquo;s a
complex number, we have no way of knowing whether it&rsquo;s rectangular
or polar. By attaching this pair to a &ldquo;type label&rdquo;, we can easily
tell by reading the label which type it is, and accordingly call
George&rsquo;s or Martha&rsquo;s procedures. Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org96d42a5"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">attach-type</span> type contents<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> type contents<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">type</span> datum<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> datum<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">contents</span> datum<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> datum<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Now, George redefines his procedures as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org2494ba4"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-rect</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>attach-type <span style="color: #2e8b57;">'rectangular</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> x y<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">real-rectangular</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">img-rectangular</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">mag-rectangular</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>square <span style="color: #b751b6;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
           <span style="color: #da8548;">(</span>square <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">ang-rectangular</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">atan</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Note that he changes his procedure names so that they don&rsquo;t
conflict with the generic <code>make-rect</code>, <code>real</code>, and so on. The
major change is that he rectangular complex numbers. Moreover,
there&rsquo;s no need for George to have a <code>make-pol</code>, since that
functionality is already provided by Martha, who implements her
procedures as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org2cfc233"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-pol</span> r a<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>attach-type <span style="color: #2e8b57;">'polar</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> r a<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">mag-polar</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">ang-polar</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">real-polar</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #50a14f;">)</span>
     <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cos</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">img-polar</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">car</span> z<span style="color: #50a14f;">)</span>
     <span style="color: #50a14f;">(</span><span style="color: #a626a4;">sin</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">cdr</span> z<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Now, we can implement the generic procedures as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org07a2d1f"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">real</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>rectangular? z<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>real-rectangular <span style="color: #b751b6;">(</span>contents z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>polar? z<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>real-polar <span style="color: #b751b6;">(</span>contents z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">img</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>rectangular? z<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>img-rectangular <span style="color: #b751b6;">(</span>contents z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>polar? z<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>img-polar <span style="color: #b751b6;">(</span>contents z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">mag</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>rectangular? z<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>mag-rectangular <span style="color: #b751b6;">(</span>contents z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>polar? z<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>mag-polar <span style="color: #b751b6;">(</span>contents z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">ang</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>rectangular? z<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>ang-rectangular <span style="color: #b751b6;">(</span>contents z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>polar? z<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>ang-polar <span style="color: #b751b6;">(</span>contents z<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
We call procedures written this way &ldquo;managers&rdquo;, since they decide
whom to dispatch the data object to for processing. The predicates
are simple label-checkers:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgb425b45"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">rectangular?</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #2e8b57;">'rectangular</span> <span style="color: #50a14f;">(</span>type z<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">polar?</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #2e8b57;">'polar</span> <span style="color: #50a14f;">(</span>type z<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org18b462b" class="outline-4">
<h4 id="org18b462b"><span class="section-number-4">9.1.6.</span> Usage</h4>
<div class="outline-text-4" id="text-9-1-6">
<div class="org-src-container">
<pre class="src src-racket">






<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a</span> <span style="color: #a626a4;">(</span>make-rect <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">b</span> <span style="color: #a626a4;">(</span>make-pol <span style="color: #2e8b57;">5</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">tan</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">result</span> <span style="color: #a626a4;">(</span>+c a b<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>real result<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>img result<span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> a<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> b<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> result<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cadr</span> result<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cddr</span> result<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
4.98276733430013
7.012866684732013
rectangular
polar
rectangular
4.98276733430013
7.012866684732013
</pre>


<p>
Note that complex numbers are now a pair of a label and a pair.
</p>
</div>
</div>

<div id="outline-container-org3fb9aef" class="outline-4">
<h4 id="org3fb9aef"><span class="section-number-4">9.1.7.</span> Review</h4>
<div class="outline-text-4" id="text-9-1-7">
<p>
There are two major issues with this way of engineering the
complex number system (&ldquo;dispatch on type&rdquo;):
</p>
<ul class="org-ul">
<li>George and Martha having to change their procedure names to
prevent namespace violation. This issue, however, can be fixed
by methods explored in later lectures.</li>
<li>A larger issue is that when an additional representation is
added (say, Harry&rsquo;s), the manager&rsquo;s <code>cond</code> has to be changed.
This isn&rsquo;t ideal, since it&rsquo;s a set of centralized procedures
which all of George, Martha, and Harry have to be able to edit.
This centralization and causes a bottleneck, and is annoying,
especially because all the manager does, really, is a
conditional dispatch &#x2014; it&rsquo;s a bureaucrat.</li>
</ul>

<p>
Our next efforts will be directed at eliminating the manager
procedures.
</p>
</div>
</div>
</div>

<div id="outline-container-org89a6c14" class="outline-3">
<h3 id="org89a6c14"><span class="section-number-3">9.2.</span> Data-Directed Programming</h3>
<div class="outline-text-3" id="text-9-2">
<p>
Abstractly, what does the manager do? It acts as a lookup table, of
shape and form:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Generic</th>
<th scope="col" class="org-left">Polar</th>
<th scope="col" class="org-left">Rectangular</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>real</code></td>
<td class="org-left"><code>real-polar</code></td>
<td class="org-left"><code>real-rectangular</code></td>
</tr>

<tr>
<td class="org-left"><code>img</code></td>
<td class="org-left"><code>img-polar</code></td>
<td class="org-left"><code>img-rectangular</code></td>
</tr>

<tr>
<td class="org-left"><code>mag</code></td>
<td class="org-left"><code>mag-polar</code></td>
<td class="org-left"><code>mag-rectangular</code></td>
</tr>

<tr>
<td class="org-left"><code>ang</code></td>
<td class="org-left"><code>ang-polar</code></td>
<td class="org-left"><code>ang-rectangular</code></td>
</tr>
</tbody>
</table>

<p>
We could decentralize the manager by simply constructing a globally
accessible table like this, and letting George and Martha put their
procedures into the correct place in the table. They must each set
up their own columns, then they can continue to define their own
&ldquo;versions&rdquo; of all the generic operators. They do this using two
procedures:
</p>

<pre class="example" id="org8e161e8">
(put KEY1 KEY2 value)
(get KEY1 KEY2)
</pre>

<p>
<code>get</code> returns the value we&rsquo;d <code>put</code> in the table. The precise way
this table is represented is not of interest to us, and we defer
its implementation to a later lecture.
</p>
</div>

<div id="outline-container-org5762ca7" class="outline-4">
<h4 id="org5762ca7"><span class="section-number-4">9.2.1.</span> Putting George&rsquo;s Procedures</h4>
<div class="outline-text-4" id="text-9-2-1">
<div class="org-src-container">
<pre class="src src-racket" id="orga66bc59"><span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'rectangular</span> <span style="color: #2e8b57;">'real</span> real-rectangular<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'rectangular</span> <span style="color: #2e8b57;">'img</span> img-rectangular<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'rectangular</span> <span style="color: #2e8b57;">'mag</span> mag-rectangular<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'rectangular</span> <span style="color: #2e8b57;">'ang</span> ang-rectangular<span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Note carefully that the value inserted into the table cell is
actually a <i>lambda</i>, it&rsquo;s not a symbol. This means that the table
literally contains within it the procedures, not their names.
Technically, George could have given the third argument of <code>put</code>
as a &lambda; directly instead of first defining it. This is
desirable, since George can safely debug and change his
procedures, and only &ldquo;commit&rdquo; them when he puts them in the table.
Moreover, it greatly simplifies lookups: to apply a procedure, one
must only grab the correct cell of the table.
</p>
</div>
</div>


<div id="outline-container-org5076cd2" class="outline-4">
<h4 id="org5076cd2"><span class="section-number-4">9.2.2.</span> Putting Martha&rsquo;s Procedures</h4>
<div class="outline-text-4" id="text-9-2-2">
<p>
Similarly:
</p>
<div class="org-src-container">
<pre class="src src-racket" id="orga25804a"><span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'polar</span> <span style="color: #2e8b57;">'real</span> real-polar<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'polar</span> <span style="color: #2e8b57;">'img</span> img-polar<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'polar</span> <span style="color: #2e8b57;">'mag</span> mag-polar<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'polar</span> <span style="color: #2e8b57;">'ang</span> ang-polar<span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Now, if Harry wants to add his procedures, he doesn&rsquo;t have to do
anything except <code>put</code> them in the table.
</p>
</div>
</div>

<div id="outline-container-orgaf34ae0" class="outline-4">
<h4 id="orgaf34ae0"><span class="section-number-4">9.2.3.</span> Manager Automation</h4>
<div class="outline-text-4" id="text-9-2-3">
<p>
The procedures hanging around in the table isn&rsquo;t enough: when <code>+c</code>
calls (say) <code>real</code>, it needs to <code>get</code> these values from the table.
This is done by:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orga596af8"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">operate</span> op object<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">proc</span> <span style="color: #b751b6;">(</span>get <span style="color: #986801;">(</span>type object<span style="color: #986801;">)</span> op<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">not</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">null?</span> proc<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span>proc <span style="color: #b751b6;">(</span>contents object<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"Operation undefined."</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
It is now simple to define the generic operators:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org83d0de1"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">real</span> obj<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>operate <span style="color: #2e8b57;">'real</span> obj<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">img</span> obj<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>operate <span style="color: #2e8b57;">'img</span> obj<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">mag</span> obj<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>operate <span style="color: #2e8b57;">'mag</span> obj<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">ang</span> obj<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>operate <span style="color: #2e8b57;">'ang</span> obj<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-orgb6a1c45" class="outline-4">
<h4 id="orgb6a1c45"><span class="section-number-4">9.2.4.</span> Usage</h4>
<div class="outline-text-4" id="text-9-2-4">
<p>
The usage is the same as last time, since the difference is in the
implementation:
</p>

<div class="org-src-container">
<pre class="src src-racket">









<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a</span> <span style="color: #a626a4;">(</span>make-rect <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">b</span> <span style="color: #a626a4;">(</span>make-pol <span style="color: #2e8b57;">5</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">tan</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">/</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">result</span> <span style="color: #a626a4;">(</span>+c a b<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>real result<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>img result<span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> a<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> b<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> result<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cadr</span> result<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cddr</span> result<span style="color: #4078f2;">)</span>

</pre>
</div>

<pre class="example">
4.98276733430013
7.012866684732013
rectangular
polar
rectangular
4.98276733430013
7.012866684732013
</pre>


<blockquote>
<p>
Note that an alternative to keeping the operations in a lookup
table is to include the operations with the data object. This
allows the data object to carry independently all the information
required to work with it. This style of programming is called
&ldquo;message passing&rdquo;.
</p>
</blockquote>

<p>
We can see by the substitution rule how this system is working:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span>real z<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>operate <span style="color: #2e8b57;">'real</span> z<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">(</span>get <span style="color: #2e8b57;">'polar</span> <span style="color: #2e8b57;">'real</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span>contents z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>real-polar <span style="color: #a626a4;">(</span>contents z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org314fc46" class="outline-3">
<h3 id="org314fc46"><span class="section-number-3">9.3.</span> Advanced Example: Semi-Complete Arithmetic System</h3>
<div class="outline-text-3" id="text-9-3">
</div>
<div id="outline-container-orgfb402b7" class="outline-4">
<h4 id="orgfb402b7"><span class="section-number-4">9.3.1.</span> Architecture</h4>
<div class="outline-text-4" id="text-9-3-1">
<p>
Let us now embed our complex number system &ldquo;package&rdquo; in a more
complex arithmetic system which, diagrammatically, looks like the
following:
</p>

<p>
Our goal is to embed our complex number, rational number, and
standard Lisp number code into a single system. This will also be
done with tags and a lookup table, with data being tagged as
<code>complex</code>, <code>rational</code>, or <code>number</code>. The top-level operations
<code>add</code>, <code>sub</code>, <code>mul</code>, and <code>div</code> are defined in terms of an <code>operate</code>
which is binary rather than unary. Later, we expand this system by
adding a way to add polynomials.
</p>
</div>
</div>

<div id="outline-container-orgf874d31" class="outline-4">
<h4 id="orgf874d31"><span class="section-number-4">9.3.2.</span> Implementation</h4>
<div class="outline-text-4" id="text-9-3-2">
<p>
The rational number procedures in this system are implemented thus:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org79f2e0b"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-rat</span> n d<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>attach-type <span style="color: #2e8b57;">'rational</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> n d<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'rational</span> <span style="color: #2e8b57;">'add</span> +rat<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'rational</span> <span style="color: #2e8b57;">'mul</span> *rat<span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The definitions of <code>+rat</code> and <code>*rat</code> are the same as last time:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+rat</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-rat
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span>numer x<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>denom y<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> <span style="color: #b751b6;">(</span>numer y<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span>denom x<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #da8548;">(</span>denom x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>denom y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*rat</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-rat
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #da8548;">(</span>numer x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>numer y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #da8548;">(</span>denom x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>denom y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Similarly, we can implement constructors and <code>put</code> procedures for
complex numbers and standard Lisp numbers in this system:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org02272e7"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-complex</span> z<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>attach-type <span style="color: #2e8b57;">'complex</span> z<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+complex</span> z1 z2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-complex <span style="color: #50a14f;">(</span>+c z1 z2<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">-complex</span> z1 z2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-complex <span style="color: #50a14f;">(</span>-c z1 z2<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*complex</span> z1 z2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-complex <span style="color: #50a14f;">(</span>*c z1 z2<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">/complex</span> z1 z2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-complex <span style="color: #50a14f;">(</span>/c z1 z2<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'complex</span> <span style="color: #2e8b57;">'add</span> +complex<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'complex</span> <span style="color: #2e8b57;">'sub</span> -complex<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'complex</span> <span style="color: #2e8b57;">'mul</span> *complex<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'complex</span> <span style="color: #2e8b57;">'div</span> /complex<span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Note that we define additional procedures <code>+complex</code>, <code>-complex</code>,
and so on to add the <code>complex</code> tag to results of operating on
complex numbers. Moving to standard numbers:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgd29f549"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-number</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>attach-type <span style="color: #2e8b57;">'number</span> n<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+number</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-number <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> x y<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">-number</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-number <span style="color: #50a14f;">(</span><span style="color: #a626a4;">-</span> x y<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*number</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-number <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> x y<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">/number</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>make-number <span style="color: #50a14f;">(</span><span style="color: #a626a4;">/</span> x y<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'number</span> <span style="color: #2e8b57;">'add</span> +number<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'number</span> <span style="color: #2e8b57;">'sub</span> -number<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'number</span> <span style="color: #2e8b57;">'mul</span> *number<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'number</span> <span style="color: #2e8b57;">'div</span> /number<span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Finally, we must implement <code>add</code>, <code>sub</code>, <code>mul</code>, and <code>div</code>
themselves:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org754e8f5"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">add</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>operate-2 <span style="color: #2e8b57;">'add</span> x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sub</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>operate-2 <span style="color: #2e8b57;">'sub</span> x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">mul</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>operate-2 <span style="color: #2e8b57;">'mul</span> x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">div</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>operate-2 <span style="color: #2e8b57;">'div</span> x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Finally, we implement the binary <code>operate</code>, <code>operate-2</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org89c2ee9"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">operate-2</span> op arg1 arg2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #da8548;">(</span>type arg1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>type arg2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #e45649;">let</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #6a1868;">proc</span> <span style="color: #986801;">(</span>get <span style="color: #4db5bd;">(</span>type arg1<span style="color: #4db5bd;">)</span> op<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">not</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">null?</span> proc<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
            <span style="color: #b751b6;">(</span>proc <span style="color: #986801;">(</span>contents arg1<span style="color: #986801;">)</span>
                  <span style="color: #986801;">(</span>contents arg2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
            <span style="color: #b751b6;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"Operation undefined."</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"Argument type mismatch."</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org64c3d2c" class="outline-4">
<h4 id="org64c3d2c"><span class="section-number-4">9.3.3.</span> Usage</h4>
<div class="outline-text-4" id="text-9-3-3">
<p>
We&rsquo;re now ready to test this system:
</p>

<div class="org-src-container">
<pre class="src src-racket">

















<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">p</span> <span style="color: #a626a4;">(</span>make-complex <span style="color: #50a14f;">(</span>make-pol <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">q</span> <span style="color: #a626a4;">(</span>make-complex <span style="color: #50a14f;">(</span>make-pol <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>mul q p<span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">r</span> <span style="color: #a626a4;">(</span>make-rat <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">s</span> <span style="color: #a626a4;">(</span>make-rat <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">4</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>add r s<span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>sub <span style="color: #a626a4;">(</span>make-number <span style="color: #2e8b57;">65</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span>make-number <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(complex polar 3 . 6)
(rational 12 . 16)
(number . 62)
</pre>


<p>
See from the output the structure: labels followed by actual value
of the datum.
</p>
</div>
</div>

<div id="outline-container-org3c1ba7f" class="outline-4">
<h4 id="org3c1ba7f"><span class="section-number-4">9.3.4.</span> Adding Polynomials</h4>
<div class="outline-text-4" id="text-9-3-4">
<p>
To do arithmetic on polynomials, we must first figure out how to
represent them. Consider the polynomial:
</p>

<p>
\[x^{15} + 2x^7 + 5\]
</p>

<p>
One simple way to represent a polynomial is a list of
coefficients, with the rightmost coefficient being the constant
term, the second last being the linear term, followed by
quadratic, and so on. However, for &ldquo;sparse&rdquo; polynomials like the
one in the example, this will result in a list with a lot of
zeros. We therefore choose a slightly different representation: a
list of pairs. The <code>car</code> of the pair is the order, and the <code>cdr</code>
is the coefficient. Thus, the polynomial in the example is
represented as <code>((15 1) (7 2) (0 5))</code>. We call this the &ldquo;term
list&rdquo; of the polynomial. In our final representation, we&rsquo;ll <code>cons</code>
this with the last bit of missing information: the variable the
polynomial is in.
</p>

<p>
Thus, to construct a polynomial:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org2b7dcbc"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-poly</span> var term-list<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>attach-type <span style="color: #2e8b57;">'polynomial</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> var term-list<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">var</span> poly<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> poly<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">term-list</span> poly<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> poly<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Now, implementing <code>+poly</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgdbf792d"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+poly</span> p1 p2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">eq?</span> <span style="color: #da8548;">(</span>var p1<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>var p2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span>make-poly
       <span style="color: #da8548;">(</span>var p1<span style="color: #da8548;">)</span>
       <span style="color: #da8548;">(</span>+term <span style="color: #b751b6;">(</span>term-list p1<span style="color: #b751b6;">)</span>
              <span style="color: #b751b6;">(</span>term-list p2<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"Polynomials not in same variable."</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>put <span style="color: #2e8b57;">'polynomial</span> <span style="color: #2e8b57;">'add</span> +poly<span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Of course, this just pushed the real work onto <code>+term</code>, which is
defined as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgd2f7d77"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+term</span> L1 L2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>empty-termlist? L1<span style="color: #da8548;">)</span> L2<span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>empty-termlist? L2<span style="color: #da8548;">)</span> L1<span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
         <span style="color: #da8548;">(</span><span style="color: #e45649;">let</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #6a1868;">t1</span> <span style="color: #4db5bd;">(</span>first-term L1<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
               <span style="color: #986801;">(</span><span style="color: #6a1868;">t2</span> <span style="color: #4db5bd;">(</span>first-term L2<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
           <span style="color: #b751b6;">(</span><span style="color: #e45649;">cond</span> <span style="color: #986801;">(</span><span style="color: #4db5bd;">(</span><span style="color: #a626a4;">&gt;</span> <span style="color: #a2b6da;">(</span>order t1<span style="color: #a2b6da;">)</span> <span style="color: #a2b6da;">(</span>order t2<span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span>
                  <span style="color: #4db5bd;">(</span>adjoin-term
                   t1
                   <span style="color: #a2b6da;">(</span>+term <span style="color: #9cb6ad;">(</span>rest-terms L1<span style="color: #9cb6ad;">)</span> L2<span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
                 <span style="color: #986801;">(</span><span style="color: #4db5bd;">(</span><span style="color: #a626a4;">&lt;</span> <span style="color: #a2b6da;">(</span>order t1<span style="color: #a2b6da;">)</span> <span style="color: #a2b6da;">(</span>order t2<span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span>
                  <span style="color: #4db5bd;">(</span>adjoin-term
                   t2
                   <span style="color: #a2b6da;">(</span>+term L1 <span style="color: #9cb6ad;">(</span>rest-terms L2<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
                 <span style="color: #986801;">(</span><span style="color: #e45649;">else</span>
                  <span style="color: #4db5bd;">(</span>adjoin-term
                   <span style="color: #a2b6da;">(</span>make-term <span style="color: #9cb6ad;">(</span>order t1<span style="color: #9cb6ad;">)</span>
                              <span style="color: #9cb6ad;">(</span>add <span style="color: #4078f2;">(</span>coeff t1<span style="color: #4078f2;">)</span>
                                   <span style="color: #4078f2;">(</span>coeff t2<span style="color: #4078f2;">)</span><span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span>
                   <span style="color: #a2b6da;">(</span>+term <span style="color: #9cb6ad;">(</span>rest-terms L1<span style="color: #9cb6ad;">)</span> <span style="color: #9cb6ad;">(</span>rest-terms L2<span style="color: #9cb6ad;">)</span><span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>



<p>
Clearly, we need to implement some predicates, constructors, and
selectors for <code>term</code>&rsquo;s and <code>term-list</code>&rsquo;s:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgc6d01e9"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">empty-termlist?</span> tl<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">null?</span> tl<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">first-term</span> tl<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> tl<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">rest-terms</span> tl<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> tl<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">adjoin-term</span> term tl<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> term tl<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-term</span> o c<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> o c<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">order</span> t<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> t<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">coeff</span> t<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> t<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Usage is obvious:
</p>


<div class="org-src-container">
<pre class="src src-racket">





















<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">p1-tl</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">list</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">15</span> <span style="color: #da8548;">(</span>make-number <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">7</span> <span style="color: #da8548;">(</span>make-number <span style="color: #2e8b57;">2</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">0</span> <span style="color: #da8548;">(</span>make-number <span style="color: #2e8b57;">5</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">poly1</span> <span style="color: #a626a4;">(</span>make-poly <span style="color: #2e8b57;">'x</span> p1-tl<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">p2-tl</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">list</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">25</span> <span style="color: #da8548;">(</span>make-number <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">15</span> <span style="color: #da8548;">(</span>make-number <span style="color: #2e8b57;">8</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">9</span> <span style="color: #da8548;">(</span>make-number <span style="color: #2e8b57;">4</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">7</span> <span style="color: #da8548;">(</span>make-number <span style="color: #2e8b57;">4</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">0</span> <span style="color: #da8548;">(</span>make-number <span style="color: #2e8b57;">15</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">poly2</span> <span style="color: #a626a4;">(</span>make-poly <span style="color: #2e8b57;">'x</span> p2-tl<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>add poly1 poly2<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(polynomial x (25 number . 1) (15 number . 9)
              (9 number . 4) (7 number . 6) (0 number . 20))
</pre>


<p>
Although somewhat hard to read, this is just the polynomial:
</p>

<p>
\[x^{25} + 9x^{15} + 4x^9 + 6x^7 + 20\]
</p>

<p>
which is the correct result of summing the polynomials:
</p>

<p>
\[(x^{15}+2x^7+5) + (x^{25} + 8x^{15} + 4x^9 + 4x^7 + 15)\]
</p>
</div>
</div>

<div id="outline-container-orgfd2659d" class="outline-4">
<h4 id="orgfd2659d"><span class="section-number-4">9.3.5.</span> Recursive Data Directed Programming</h4>
<div class="outline-text-4" id="text-9-3-5">
<p>
It&rsquo;s easy to miss one <i>very</i> crucial point in the implementation
of procedure <code>+term</code>: that when we actually add the coefficients
of two same-order terms, we use the generic operator <code>add</code>. Or,
instead of doing this:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #a626a4;">+</span> <span style="color: #a626a4;">(</span>coeff t1<span style="color: #a626a4;">)</span>
   <span style="color: #a626a4;">(</span>coeff t2<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
we do:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span>add <span style="color: #a626a4;">(</span>coeff t1<span style="color: #a626a4;">)</span>
   <span style="color: #a626a4;">(</span>coeff t2<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
What this does is that it lets our polynomial have any
coefficients supported by the overall system. We therefore, &ldquo;for
free&rdquo;, have rational and complex coefficients. Therefore,
expressions like the following are fully supported:
</p>

<p>
\[\frac{3}{2}x^{2} + \frac{17}{7}\] \[(3+2i)x^5+(4+7i)\]
</p>

<p>
This works by calling <code>add</code> on the coefficients, which knows how
to add fractions and complex numbers.
</p>


<div class="org-src-container">
<pre class="src src-racket">





















<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">p1-tl</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">list</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">15</span> <span style="color: #da8548;">(</span>make-rat <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">7</span> <span style="color: #da8548;">(</span>make-rat <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">17</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">0</span> <span style="color: #da8548;">(</span>make-rat <span style="color: #2e8b57;">5</span> <span style="color: #2e8b57;">4</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">poly1</span> <span style="color: #a626a4;">(</span>make-poly <span style="color: #2e8b57;">'x</span> p1-tl<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">p2-tl</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">list</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">25</span> <span style="color: #da8548;">(</span>make-rat <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">3</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">15</span> <span style="color: #da8548;">(</span>make-rat <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">7</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">9</span> <span style="color: #da8548;">(</span>make-rat <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">13</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">7</span> <span style="color: #da8548;">(</span>make-rat <span style="color: #2e8b57;">14</span> <span style="color: #2e8b57;">7</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">0</span> <span style="color: #da8548;">(</span>make-rat <span style="color: #2e8b57;">15</span> <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">poly2</span> <span style="color: #a626a4;">(</span>make-poly <span style="color: #2e8b57;">'x</span> p2-tl<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>add poly1 poly2<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(polynomial x (25 rational 1 . 3) (15 rational 23 . 14)
              (9 rational 4 . 13) (7 rational 252 . 119) (0 rational 65 . 4))
</pre>





<p>
Even cooler is the fact that we have support for polynomials with
polynomial coefficients, such as:
</p>

<p>
\[(x^2+1)y^2 + (x^3-2x)y + (x^4-7)\]
</p>

<p>
This is because <code>add</code> also knows, recursively, how to add
polynomials. We can, theoretically, nest this as far as we want
to, having polynomials whose coefficients are polynomials whose
coefficients are polynomials whose&hellip;
</p>

<p>
Note that we could rewrite <code>+rat</code> to use <code>add</code> instead of <code>+</code>, and
we&rsquo;d be able to support expressions such as
</p>

<p>
\[\frac{3x+7}{x^2+1}\]
</p>

<p>
This exposes a powerful technique: once we have the basic
implementation of any operation, say matrix addition, in the form:
</p>

<p>
\[\begin{bmatrix}
    a & b\\
    c & d
    \end{bmatrix} +
    \begin{bmatrix}
    p & q\\
    r & s
    \end{bmatrix} =
    \begin{bmatrix}
    a+p & b+q\\
    c+r & d+s
    \end{bmatrix} \]
</p>

<p>
If we use generic operators, it doesn&rsquo;t matter what \(a\), \(b\), and
the other operands are: they can be any type the generic operators
support, including matrices.
</p>
</div>
</div>
</div>

<div id="outline-container-org562b882" class="outline-3">
<h3 id="org562b882"><span class="section-number-3">9.4.</span> Review</h3>
<div class="outline-text-3" id="text-9-4">
<p>
We started our implementation of generic operators by writing a
manager to dispatch the correct procedure according to type using
conditional statements. We saw that this created a bottleneck at
the manager. We then eliminated the manager by using a lookup
table, which the generic operators accessed and got the correct
&lambda;, effectively decentralising the manager&rsquo;s role, since
any new representation can be added to the table without any
interaction with the others. Finally, we saw how to use generic
operators to allow the recursive use of operations on types within
the system.
</p>

<p>
One feature, however, missing from the system, is the idea of &ldquo;type
coercion&rdquo;. Our system fails when it tries to add, say,
</p>

<p>
\[3 + \frac{2}{5}\]
</p>

<p>
by reporting a type mismatch (it cannot add a <code>number</code> and a
<code>rational</code>). However, it won&rsquo;t complain if we ask it to add
</p>

<p>
\[\frac{3}{1} + \frac{2}{5}\]
</p>

<p>
Despite the meanings being mathematically the same. We then need to
implement a way to &ldquo;coerce&rdquo; types into other types when it is
mathematically meaningful to do so, for instance, interpreting a
pure real number \(r\) as complex number \(r+0i\). The implementation
of &ldquo;type coercion&rdquo; is shown in the SICP book.
</p>
</div>
</div>
</div>

<div id="outline-container-org3c29e04" class="outline-2">
<h2 id="org3c29e04"><span class="section-number-2">10.</span> Lecture 5A: Assignment, State, and Side-Effects</h2>
<div class="outline-text-2" id="text-10">
<p>
Up until now, we&rsquo;ve used no assignment statements in our use of
Lisp. If we add one, there must be a good reason to do so, and the
creation of significant advantage.
We will first consider how we&rsquo;d go about dealing with assignment in
Lisp, then the benefits it brings to our programming practice.
</p>
</div>

<div id="outline-container-org524407b" class="outline-3">
<h3 id="org524407b"><span class="section-number-3">10.1.</span> Functional v. Imperative Style</h3>
<div class="outline-text-3" id="text-10-1">
</div>
<div id="outline-container-org2f9c6b9" class="outline-4">
<h4 id="org2f9c6b9"><span class="section-number-4">10.1.1.</span> Functional Programming</h4>
<div class="outline-text-4" id="text-10-1-1">
<p>
Functional programs encode mathematical truth in a procedure. For
instance,
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">fact</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> n <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> n <span style="color: #b751b6;">(</span>fact <span style="color: #986801;">(</span>dec n<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>fact <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
24
</pre>


<p>
This is almost precisely the mathematical definition of a factorial
in Lisp:
\[f(n) = \begin{cases} 1& n=1\\ n\times f(n-1) & n>1\end{cases}\]
</p>

<p>
Moreover, such a function can be fully understood by substituting
recursively:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span>fact <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">4</span> <span style="color: #a626a4;">(</span>fact <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">4</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">3</span> <span style="color: #50a14f;">(</span>fact <span style="color: #2e8b57;">2</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">4</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">3</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">2</span> <span style="color: #da8548;">(</span>fact <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">4</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">3</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">1</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">4</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">*</span> <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">6</span><span style="color: #4078f2;">)</span>
<span style="color: #2e8b57;">24</span>
</pre>
</div>

<p>
Furthermore, we can differentiate between procedures with different
processes. Consider our Peano adders:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">pa+</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">=</span> x <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
      y
      <span style="color: #50a14f;">(</span>pa+ <span style="color: #da8548;">(</span>dec x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>inc y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
and
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">pb+</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">=</span> x <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
      y
      <span style="color: #50a14f;">(</span>inc <span style="color: #da8548;">(</span>pb+ <span style="color: #b751b6;">(</span>dec x<span style="color: #b751b6;">)</span> y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>



<div id="outline-container-org7da1eb2" class="outline-4">
<h4 id="org7da1eb2"><span class="section-number-4">10.1.2.</span> Imperative Programming</h4>
<div class="outline-text-4" id="text-10-1-2">
<p>
Imperative programming involves writing statements which change
the overall <i>state</i> of the program. Lisp does this using
assignment statements called <code>set!</code>.
<code>set!</code> is called by giving it two arguments. The second is a
value, and the first is the variable to assign it to. Or:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">set!</span> &lt;var&gt; &lt;value&gt;<span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Consider what this assignment does. It creates an instant in time.
Before this instant, <code>&lt;var&gt;</code> had no value, or some other value.
<i>After</i> this <code>set!</code>, <code>&lt;var&gt;</code> has value <code>&lt;value&gt;</code>, which means that
the <code>set!</code> changed something in the program state. Before the
<code>set!</code> the state was (say) A, and after, it was a different state,
(say) B. This is entirely different from any of our previous
programs, all of which used functional programming style.
</p>

<p>
It should be obvious that procedures which use assignment are not
bijective, that is, for the same input, they may have different
outputs. Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">count</span> <span style="color: #2e8b57;">1</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">demo</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">set!</span> <span style="color: #a626a4;">count</span> <span style="color: #50a14f;">(</span>inc <span style="color: #a626a4;">count</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">+</span> x <span style="color: #a626a4;">count</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>demo <span style="color: #2e8b57;">3</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>demo <span style="color: #2e8b57;">3</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>demo <span style="color: #2e8b57;">3</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
5
6
7
</pre>


<p>
<code>demo</code> does not compute any mathematical function.
Instead, the successive values of <code>count</code> are <code>set!</code> and
remembered somewhere in the environment each time <code>demo</code> is
called.
</p>

<p>
Clearly, assignment introduces difficulties. Even our previous
substitution model is now insufficient, since it is a static
phenomenon which cannot account for changing values in the
environment. Symbols now can refer to some place where the values
of variables are stored. While this certainly makes our job
harder, assignment is worth the trouble, as we&rsquo;ll see later.
</p>
</div>
</div>

<div id="outline-container-org154a8e3" class="outline-4">
<h4 id="org154a8e3"><span class="section-number-4">10.1.3.</span> Direct Comparison</h4>
<div class="outline-text-4" id="text-10-1-3">
<p>
Here&rsquo;s an iterative implementation of a functional factorial
procedure:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">fact</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">iter</span> m i<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">cond</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #a626a4;">&gt;</span> i n<span style="color: #b751b6;">)</span> m<span style="color: #da8548;">)</span>
          <span style="color: #da8548;">(</span><span style="color: #e45649;">else</span>
           <span style="color: #b751b6;">(</span>iter <span style="color: #986801;">(</span><span style="color: #a626a4;">*</span> i m<span style="color: #986801;">)</span> <span style="color: #986801;">(</span>inc i<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>iter <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>fact <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
24
</pre>


<p>
And an iterative implementation of an imperative-style factorial
procedure:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">fact</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">i</span> <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #6a1868;">m</span> <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">loop</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">cond</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">&gt;</span> i n<span style="color: #986801;">)</span> m<span style="color: #b751b6;">)</span>
            <span style="color: #b751b6;">(</span><span style="color: #e45649;">else</span>
             <span style="color: #986801;">(</span><span style="color: #e45649;">set!</span> m <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">*</span> i m<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
             <span style="color: #986801;">(</span><span style="color: #e45649;">set!</span> i <span style="color: #4db5bd;">(</span>inc i<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
             <span style="color: #986801;">(</span>loop<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>loop<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>fact <span style="color: #2e8b57;">4</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
24
</pre>


<p>
Note the difference between the two. The first passes successive
values of <code>i</code> and <code>m</code> as parameters into the next call of <code>iter</code>.
However, in the imperative style, the very values of <code>i</code> and <code>m</code>
are changed to their new values, and the procedure simply called
again without any arguments.
</p>

<p>
Note also that swapping the <code>set!</code> statements:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">set!</span> i <span style="color: #a626a4;">(</span>inc i<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">set!</span> m <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> i m<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Will mess up the execution of the program, since <code>m</code> depends on
<code>i</code> having the correct value <i>at the time</i> it&rsquo;s reassigned to <code>(*
    i m)</code>. The time instance creation inherent in assignment creates
these time-based dependencies, which are worth being aware of.
</p>
</div>
</div>
</div>

<div id="outline-container-orgd3f8a97" class="outline-3">
<h3 id="orgd3f8a97"><span class="section-number-3">10.2.</span> Environment Model</h3>
<div class="outline-text-3" id="text-10-2">
<p>
As we observed, assignment invalidates our substitution model of
evaluating Lisp programs. We therefore work on the creation of a
new model which supports assignment.
</p>
</div>

<div id="outline-container-orgfd2a413" class="outline-4">
<h4 id="orgfd2a413"><span class="section-number-4">10.2.1.</span> Bound and Free Variables</h4>
<div class="outline-text-4" id="text-10-2-1">
<blockquote>
<p>
We say that a variable <code>v</code> is &ldquo;bound in an expression&rdquo; <code>E</code> if the
meaning of <code>E</code> is unchanged by the uniform replacement of <code>v</code> with
a variable <code>w</code> (not occurring in <code>E</code>) for every occurrence of <code>v</code>
in <code>E</code>.
</p>
</blockquote>

<p>
Bound variables exist naturally in mathematics. Consider the
expressions:
\[\forall x\exists y P(x,y)\]
\[\int_0^1 \frac{\mathrm{d}x}{1+x^2}\]
</p>

<p>
have no difference in meaning when \(x\) is substituted:
\[\forall w\exists y P(w,y)\]
\[\int_0^1 \frac{\mathrm{d}w}{1+w^2}\]
</p>

<p>
This is because, in both cases, \(x\) is a bound variable. Now,
</p>

<blockquote>
<p>
A quantifier is a symbol which binds a variable.
</p>
</blockquote>

<p>
Thus, in these cases, \(\forall\), \(\exists\), and \(\int\) were the
quantifiers of bound variable \(x\). Similarly, consider a Lisp
expression:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #a626a4;">(</span>y<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Here, <code>x</code> and <code>y</code> are bound variables, and the &lambda; are
quantifiers for them. This can be illustrated by swapping out the
variables and having no change in meaning:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #a626a4;">(</span>v<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>w<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> w v<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
However, it is not necessary that all variables be bound. Consider
the Lisp expression:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #a626a4;">(</span>x<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">*</span> x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
<code>x</code> is bound, with quantifier &lambda;. However, <code>y</code> is not bound
(it is a free variable). This is because the definition of <code>y</code>
does not come from the formal parameter list of a
&lambda;-expression or any other known location within the
expression. Instead, it comes from somewhere outside. We cannot
replace <code>y</code> with another variable <code>v</code>, since we don&rsquo;t know what
value <code>y</code> may have.
Formally,
</p>
<blockquote>
<p>
We say that a variable <code>v</code> is &ldquo;free in an expression&rdquo; <code>E</code> if the
meaning of <code>E</code> is changed by the uniform replacement of <code>v</code> with
a variable <code>w</code> (not occurring in <code>E</code>) for every occurrence of <code>v</code>
in <code>E</code>.
</p>
</blockquote>

<p>
In fact, in the expression:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #a626a4;">(</span>y<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>x<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">*</span> x y<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The symbol <code>*</code> is a free variable, since the expression&rsquo;s meaning
will change if we replace it with the symbol <code>+</code>.
</p>
</div>
</div>

<div id="outline-container-orgccf706b" class="outline-4">
<h4 id="orgccf706b"><span class="section-number-4">10.2.2.</span> Scope</h4>
<div class="outline-text-4" id="text-10-2-2">
<p>
Formally,
</p>

<blockquote>
<p>
If <code>x</code> is a bound variable in <code>E</code>, then there is a
&lambda;-expression where it is bound. We call the list of formal
parameters of this &lambda;-expression the &ldquo;bound variable list&rdquo;
and we say that the &lambda;-expression &ldquo;binds&rdquo; the variable
defined in the bound variable list. Moreover, those parts of the
expression where a variable has a value defined by the
&lambda;-expression which binds it is called the &ldquo;scope&rdquo; of the
variable.
</p>
</blockquote>


<p>
Or, for example:
\[\mathtt{(\lambda~(y)~\underbrace{\mathtt{((\lambda~(x)~\overbrace{\mathtt{(*~x~y)}}^{\mathrm{Scope~of~}\mathtt{x}})~3)}}_{\mathrm{Scope~of~}\mathtt{y}})}\]
</p>
</div>
</div>

<div id="outline-container-orgb0cf695" class="outline-4">
<h4 id="orgb0cf695"><span class="section-number-4">10.2.3.</span> Frames and Environments</h4>
<div class="outline-text-4" id="text-10-2-3">
<p>
<a href="./images/frames.pdf">./images/frames.pdf</a>
</p>


<p>
An environment is made up of a linked chain of frames. Shown in
the figure are three frames, I, II, and III. Now, each of A, B, C,
and D are different environments, which view the frames in
different ways.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Environment</th>
<th scope="col" class="org-right">x</th>
<th scope="col" class="org-right">y</th>
<th scope="col" class="org-left">z</th>
<th scope="col" class="org-left">m</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">A</td>
<td class="org-right">7</td>
<td class="org-right">5</td>
<td class="org-left">6</td>
<td class="org-left">-</td>
</tr>

<tr>
<td class="org-left">B</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-left">-</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-right">3</td>
<td class="org-right">5</td>
<td class="org-left">-</td>
<td class="org-left">-</td>
</tr>

<tr>
<td class="org-left">D</td>
<td class="org-right">3</td>
<td class="org-right">5</td>
<td class="org-left">-</td>
<td class="org-left">-</td>
</tr>
</tbody>
</table>

<p>
Environments can be considered as different &ldquo;vantage points&rdquo; of
the frame chain. From A, we see the values of the frame II and the
frames behind II, in this case I. Therefore, we get the values of
x, y, and z. However, there are two possible values of x. In this
case, we say that the value of x in frame II &ldquo;shadows&rdquo; the value
of x in all previous frames, and we consider that value to be the
correct one. Note that this is actually making the choice to use
the innermost scope&rsquo;s variables over ones in outer scopes. Other
environments are similarly analyzed. Note that C and D are the
same environment.
</p>
</div>
</div>

<div id="outline-container-org4b95200" class="outline-4">
<h4 id="org4b95200"><span class="section-number-4">10.2.4.</span> Procedure Objects</h4>
<div class="outline-text-4" id="text-10-2-4">
<p>
A procedure objects consists of:
</p>
<ol class="org-ol">
<li>A pointer to the procedure object.</li>
<li>A pointer to the environment the procedure will execute in.</li>
<li>The actual body (code) of the procedure.</li>
</ol>

<p>
Diagrammatically:
</p>

<p>
<a href="./images/frameobj.pdf">./images/frameobj.pdf</a>
</p>
</div>
</div>

<div id="outline-container-org1965493" class="outline-4">
<h4 id="org1965493"><span class="section-number-4">10.2.5.</span> Rules for Environment Model</h4>
<div class="outline-text-4" id="text-10-2-5">
<ol class="org-ol">
<li><p>
A procedure object is applied to a set of arguments by
constructing a frame binding the formal parameters of the
procedure to the actual arguments of the call, then evaluating
the body of the procedure <i>in the context</i> of the new
environment thus constructed. The new frame has as its
enclosing environment the environment part of the procedure
being applied.
</p>

<p>
For example, for a procedure <code>P</code>, evaluated at <code>(P 3 4)</code>, the
actual arguments to <code>P</code> are &ldquo;appended&rdquo; to the environment <code>P</code>
is called in. The procedure object itself has three pointers:
</p>

<ul class="org-ul">
<li>The first is to the procedure itself, <code>P</code>.</li>
<li>The second points to the extended environment.</li>
<li>The third point points to the actual &lambda;.</li>
</ul>

<p>
Diagrammatically:
</p>

<p>
<a href="./images/rule1.pdf">./images/rule1.pdf</a>
</p></li>

<li><p>
A &lambda;-expression is evaluated relative to a given
environment as follows: a new procedure object is formed, the
combining the code of the &lambda;-expression with a pointer to
the environment of evaluation.
</p>

<p>
This rule is self-explanatory.
</p></li>
</ol>

<p>
Our most important take-away is that an environment is a linked
chain of frames, going all the way back to the first (global)
frame. We now have a new working model, which works with
assignment, as we&rsquo;ll soon see.
</p>
</div>
</div>


<div id="outline-container-org3afb427" class="outline-4">
<h4 id="org3afb427"><span class="section-number-4">10.2.6.</span> Assignment</h4>
<div class="outline-text-4" id="text-10-2-6">
<p>
Let&rsquo;s play around with assignment in the environment model.
Consider the following procedure:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orga2b63eb"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">make-counter</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>n<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">()</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">set!</span> n <span style="color: #b751b6;">(</span>inc n<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      n<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
What does the environment look like once we define <code>make-counter</code>?
Something like this:
</p>

<p>
<a href="./images/make-counter.pdf">./images/make-counter.pdf</a>
</p>

<p>
Let us now use <code>make-counter</code> to define two counters, each of
which start at different values of <code>n</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orga1ff5bd">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">C1</span> <span style="color: #a626a4;">(</span>make-counter <span style="color: #2e8b57;">0</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">C2</span> <span style="color: #a626a4;">(</span>make-counter <span style="color: #2e8b57;">10</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The environment now looks like:
</p>

<p>
<a href="./images/c1c2.pdf">./images/c1c2.pdf</a>
</p>

<p>
See that there is no <i>possible</i> confusion between which <code>n</code> <code>C1</code>
uses and which <code>n</code> <code>C2</code> uses. Moreover, neither <code>C1</code> nor <code>C2</code>
would care about a globally defined <code>n</code>, or any <code>n</code> in a higher
level frame, since it&rsquo;d get shadowed by their own <code>n</code>&rsquo;s.
</p>

<p>
We can now see how the following would work:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span>C1<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>C2<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>C1<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>C2<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1
11
2
12
</pre>


<p>
The first call to <code>(C1)</code> sees that <code>n</code> is zero in its environment,
and sets <code>n</code> to <code>0+1=1</code>, and returns <code>1</code>. The first call to <code>(C2)</code>
sees that <i>its</i> <code>n</code> is <code>10</code>, sets it to <code>11</code>, and returns <code>11</code>. The
second call to <code>(C1)</code> sees that its <code>n</code> is <code>1</code>, then sets and
returns <code>2</code>. The final call to <code>(C2)</code> sees that its <code>n</code> is <code>11</code>,
which is then sets to <code>12</code> and returned.
</p>
</div>
</div>


<div id="outline-container-org1408e7a" class="outline-4">
<h4 id="org1408e7a"><span class="section-number-4">10.2.7.</span> Some Philosophy</h4>
<div class="outline-text-4" id="text-10-2-7">
<p>
We have some questions to answer about sameness and change of
objects. Consider that in the previous example, <code>C1</code>&rsquo;s <code>n</code> and
<code>C2</code>&rsquo;s <code>n</code> are both called <code>n</code>, and yet refer to different
objects. However, <code>C1</code> refers to only one object, <code>C1</code>. How then,
can we tell if an identifier refers to an object? This issue is
almost philosophical: if the only way know of an object is its
identifier, what is an object anyway?
</p>

<p>
We avoid these issues in Lisp&rsquo;s environment model by defining
action, change, and identity as follows:
</p>

<blockquote>
<p>
Action \(A\) has an effect on object \(X\) (\(A\) changes \(X\)) if
property \(P\) true of \(X\) before \(A\) is false of \(X\) after \(A\).
</p>
</blockquote>

<p>
and
</p>

<blockquote>
<p>
\(X\) and \(Y\) are the same object if any action which changes \(X\)
changes \(Y\).
</p>
</blockquote>

<p>
The (Lisp) world is thus made up of many individual objects, all
with some local state.
</p>
</div>
</div>
</div>

<div id="outline-container-org35bf65b" class="outline-3">
<h3 id="org35bf65b"><span class="section-number-3">10.3.</span> Advantages of Assignment</h3>
<div class="outline-text-3" id="text-10-3">
<p>
We&rsquo;ve seen that introducing assignment makes our pure functional
programming somewhat &ldquo;murky&rdquo;. One of the reasons to do this is that
assignment often greatly enhances modularity, as we will show in an
example. A word of caution, however: do not use assignment unless
it is necessary.
</p>
</div>

<div id="outline-container-orgb8f8f35" class="outline-4">
<h4 id="orgb8f8f35"><span class="section-number-4">10.3.1.</span> Cesàro&rsquo;s Pi Finder</h4>
<div class="outline-text-4" id="text-10-3-1">
<p>
Cesàro&rsquo;s theorem tells us that:
</p>

<p>
\[P(\mathrm{gcd}(a,b)=1) = \frac{6}{\pi^{2}}\]
</p>

<p>
Of course, we can estimate probabilities using the Monte Carlo
method (do lots of tests, and divide the number of successful tests
by the total number of tests conducted). Using assignment, the
program looks like:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgd4e3a42"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">estimate-pi</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">/</span> <span style="color: #2e8b57;">6</span> <span style="color: #da8548;">(</span>monte-carlo n cesaro<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cesaro</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">=</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">gcd</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">random</span> <span style="color: #2e8b57;">4294967087</span><span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">random</span> <span style="color: #2e8b57;">4294967087</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">monte-carlo</span> trials experiment<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">iter</span> remaining passed<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">cond</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #a626a4;">=</span> remaining <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span>
           <span style="color: #b751b6;">(</span><span style="color: #a626a4;">/</span> passed trials<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
          <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span>experiment<span style="color: #b751b6;">)</span>
           <span style="color: #b751b6;">(</span>iter <span style="color: #986801;">(</span>dec remaining<span style="color: #986801;">)</span>
                 <span style="color: #986801;">(</span>inc passed<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
          <span style="color: #da8548;">(</span><span style="color: #e45649;">else</span>
           <span style="color: #b751b6;">(</span>iter <span style="color: #986801;">(</span>dec remaining<span style="color: #986801;">)</span>
                 passed<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>iter trials <span style="color: #2e8b57;">0</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>estimate-pi <span style="color: #2e8b57;">10000000</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
3.141330429791511
</pre>


<p>
Note that we use Racket&rsquo;s built in <code>random</code> to generate a random
number. However, if we had to implement a PRNG on our own, it&rsquo;d
look something like:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">rand</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">x</span> random-init<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">()</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">set!</span> x <span style="color: #b751b6;">(</span>rand-update x<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      x<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Assignment is used most naturally here because we want to give <code>x</code>
the value of computing some function with input <code>x</code> to use the
next time <code>rand</code> is called. This function is evaluated within a
local scope where <code>x</code> at first has some constant seed value
<code>random-init</code>.
</p>
</div>
</div>


<div id="outline-container-org9f34117" class="outline-4">
<h4 id="org9f34117"><span class="section-number-4">10.3.2.</span> Functional Cesàro&rsquo;s Pi Finder</h4>
<div class="outline-text-4" id="text-10-3-2">
<p>
Since we can&rsquo;t use assignment to keep track of the &ldquo;state&rdquo; of the
PRNG, we must write our program like:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">estimate-pi</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sqrt</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">/</span> <span style="color: #2e8b57;">6</span> <span style="color: #da8548;">(</span>random-gcd-test n<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">random-gcd-test</span> trials<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">iter</span> remaining passed x<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">let</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #6a1868;">x1</span> <span style="color: #986801;">(</span>rand-update x<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span><span style="color: #6a1868;">x2</span> <span style="color: #986801;">(</span>rand-update x1<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">cond</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> remaining <span style="color: #2e8b57;">0</span><span style="color: #986801;">)</span>
             <span style="color: #986801;">(</span><span style="color: #a626a4;">/</span> passed trials<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
            <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">gcd</span> x1 x2<span style="color: #4db5bd;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #986801;">)</span>
             <span style="color: #986801;">(</span>iter <span style="color: #4db5bd;">(</span>dec remaining<span style="color: #4db5bd;">)</span>
                   <span style="color: #4db5bd;">(</span>inc passed<span style="color: #4db5bd;">)</span>
                   x<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
            <span style="color: #b751b6;">(</span><span style="color: #e45649;">else</span>
             <span style="color: #986801;">(</span>iter <span style="color: #4db5bd;">(</span>dec remaining<span style="color: #4db5bd;">)</span>
                   passed
                   x2<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>iter trials <span style="color: #2e8b57;">0</span> <span style="color: #a626a4;">random-seed</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The state of the PRNG has &ldquo;leaked&rdquo; out into our program, that is,
<code>iter</code> has to keep track of successive values of the seed. Worse
still, this makes <code>monte-carlo</code> and <code>cesaro</code> non-general, reducing
modularity. It is applications like these where assignment is
incredibly useful, and helps keep our programs neat and modular.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgbbdc34c" class="outline-2">
<h2 id="orgbbdc34c"><span class="section-number-2">11.</span> Lecture 5B: Computational Objects</h2>
<div class="outline-text-2" id="text-11">
<p>
Now that we have local state, let&rsquo;s see what we can do with it. As
we saw earlier, real world objects also have local state. As such,
we can now make a model of the real world in our computer, taking
advantage of its inherent modularity to built a model with modular
objects.
</p>

<p>
We explore this possibility in this lecture by writing a simulator
for digital circuits in Lisp. Along the way, we&rsquo;ll have to implement
certain data structures which support local state.
</p>
</div>

<div id="outline-container-org2a24f5d" class="outline-3">
<h3 id="org2a24f5d"><span class="section-number-3">11.1.</span> Digital Circuit Language</h3>
<div class="outline-text-3" id="text-11-1">
<p>
We build a language embedded in Lisp (in the same style as the
picture language) to simulate digital circuits. Here&rsquo;s the expected
usage:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">b</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">c</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">d</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">e</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">s</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>or-gate a b d<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>and-gate a b c<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>inverter c e<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>and-gate d e s<span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The <code>or-gate</code> takes two input wires <code>a</code> and <code>b</code>, and returns the
<code>OR</code> of the signals on wire <code>d</code>, very much like a real OR gate:
</p>

<p>
We could use these primitives to
write a half adder:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org29a380f"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">half-adder</span> a b s c<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">d</span> <span style="color: #b751b6;">(</span>make-wire<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #6a1868;">e</span> <span style="color: #b751b6;">(</span>make-wire<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>or-gate a b d<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>and-gate a b c<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>inverter c e<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>and-gate d e s<span style="color: #50a14f;">)</span>
    <span style="color: #2e8b57;">'OK</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Note carefully that the procedure <code>half-adder</code> doesn&rsquo;t actually
return anything: it merely makes calls to the gate procedures.
We&rsquo;ll see why later. Since the language is hierarchical, we could
now write a full adder:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org637fbcb"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">full-adder</span> a b c-in sum c-out<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">s</span> <span style="color: #b751b6;">(</span>make-wire<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #6a1868;">c1</span> <span style="color: #b751b6;">(</span>make-wire<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #6a1868;">c2</span> <span style="color: #b751b6;">(</span>make-wire<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>half-adder b c-in s c1<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>half-adder a s sum c2<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>or-gate c1 c2 c-out<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org28667ec" class="outline-3">
<h3 id="org28667ec"><span class="section-number-3">11.2.</span> Gates</h3>
<div class="outline-text-3" id="text-11-2">
<p>
Let us now implement the primitive gates of this language. Here&rsquo;s
an <code>inverter</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orga4bdd77"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">inverter</span> in out<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">invert-in</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">let</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #6a1868;">new</span>
           <span style="color: #986801;">(</span>logical-not <span style="color: #4db5bd;">(</span>get-signal in<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span>after-delay inverter-delay
                   <span style="color: #b751b6;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #986801;">()</span>
                     <span style="color: #986801;">(</span>set-signal! out <span style="color: #a626a4;">new</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>add-action! in invert-in<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
<code>inverter</code> defines a procedure called <code>invert-in</code>, and adds that
action to the wire <code>in</code>. <code>invert-in</code> itself takes the logical not
of <code>in</code> and sets the signal on <code>out</code> to this value, after some
delay. See that this is precisely how a digital inverter in the
real world is expected to work: wires have certain signals
(<code>get-signal</code> and <code>set-signal</code>), these signals change according to
how the wires are routed <code>add-action!</code>, and there are certain
delays before the signal changes.
</p>

<p>
Of course, the primitive <code>logical-not</code> is easy to define:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org0856990"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">logical-not</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> s <span style="color: #2e8b57;">0</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> s <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
         <span style="color: #da8548;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"Invalid signal"</span> s<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Similarly, <code>and-gate</code> can be defined as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgc0f7871"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">and-gate</span> a1 a2 out<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">and-action-proc</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">let</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #6a1868;">new-value</span>
           <span style="color: #986801;">(</span>logical-and <span style="color: #4db5bd;">(</span>get-signal a1<span style="color: #4db5bd;">)</span>
                        <span style="color: #4db5bd;">(</span>get-signal a2<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span>after-delay and-gate-delay
                   <span style="color: #b751b6;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #986801;">()</span>
                     <span style="color: #986801;">(</span>set-signal! out new-value<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>add-action! a1 and-action-proc<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>add-action! a2 and-action-proc<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
The only difference is in that we need to <code>get-signal</code> two signals
and <code>add-action!</code>&rsquo;s to two signals. <code>logical-and</code> can be
implemented as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org9c91227"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">logical-and</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> a <span style="color: #2e8b57;">0</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #e45649;">cond</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> b <span style="color: #2e8b57;">0</span><span style="color: #986801;">)</span> <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span>
               <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> b <span style="color: #2e8b57;">1</span><span style="color: #986801;">)</span> <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> a <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #e45649;">cond</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> b <span style="color: #2e8b57;">0</span><span style="color: #986801;">)</span> <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span>
               <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> b <span style="color: #2e8b57;">1</span><span style="color: #986801;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Finally, an <code>or-gate</code> is implemented as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgc97f43d"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">or-gate</span> r1 r2 out<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">or-action-proc</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">let</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #6a1868;">new-value</span>
           <span style="color: #986801;">(</span>logical-or <span style="color: #4db5bd;">(</span>get-signal r1<span style="color: #4db5bd;">)</span>
                        <span style="color: #4db5bd;">(</span>get-signal r2<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span>after-delay or-gate-delay
                   <span style="color: #b751b6;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #986801;">()</span>
                     <span style="color: #986801;">(</span>set-signal! out new-value<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>add-action! r1 or-action-proc<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>add-action! r2 or-action-proc<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
<code>logical-or</code> is defined similar to <code>logical-and</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org2cd8625"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">logical-or</span> a b<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> a <span style="color: #2e8b57;">0</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #e45649;">cond</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> b <span style="color: #2e8b57;">0</span><span style="color: #986801;">)</span> <span style="color: #2e8b57;">0</span><span style="color: #b751b6;">)</span>
               <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> b <span style="color: #2e8b57;">1</span><span style="color: #986801;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> a <span style="color: #2e8b57;">1</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #e45649;">cond</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> b <span style="color: #2e8b57;">0</span><span style="color: #986801;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span>
               <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> b <span style="color: #2e8b57;">1</span><span style="color: #986801;">)</span> <span style="color: #2e8b57;">1</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9e7cfb8" class="outline-3">
<h3 id="org9e7cfb8"><span class="section-number-3">11.3.</span> Wires</h3>
<div class="outline-text-3" id="text-11-3">
<p>
We define wires as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org71e5065"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-wire</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">signal</span> <span style="color: #2e8b57;">0</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #6a1868;">action-procs</span> '<span style="color: #b751b6;">()</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">set-my-signal!</span> <span style="color: #a626a4;">new</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">cond</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">=</span> signal <span style="color: #a626a4;">new</span><span style="color: #986801;">)</span> <span style="color: #2e8b57;">'DONE</span><span style="color: #b751b6;">)</span>
            <span style="color: #b751b6;">(</span><span style="color: #e45649;">else</span>
             <span style="color: #986801;">(</span><span style="color: #e45649;">set!</span> signal <span style="color: #a626a4;">new</span><span style="color: #986801;">)</span>
             <span style="color: #986801;">(</span>call-each action-procs<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">accept-action-proc</span> proc<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">set!</span> action-procs
            <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cons</span> proc action-procs<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span>proc<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
  <span style="color: #50a14f;">(</span><span style="color: #e45649;">define</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">dispatch</span> m<span style="color: #da8548;">)</span>
    <span style="color: #da8548;">(</span><span style="color: #e45649;">cond</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">eq?</span> m <span style="color: #2e8b57;">'get-signal</span><span style="color: #986801;">)</span> signal<span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">eq?</span> m <span style="color: #2e8b57;">'set-signal!</span><span style="color: #986801;">)</span> set-my-signal!<span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #a626a4;">eq?</span> m <span style="color: #2e8b57;">'add-action!</span><span style="color: #986801;">)</span> accept-action-proc<span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span><span style="color: #e45649;">else</span>
           <span style="color: #986801;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"Bad message"</span> m<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
  dispatch<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Clearly, a wire is defined by two local-scope variables, <code>signal</code>
and <code>action-procs</code>, which are initially set to <code>0</code> and <code>'()</code> (the
empty list, <code>nil</code>) respectively. Internally defined procedure
<code>set-my-signal!</code> does the obvious thing and sets the signal to the
new signal. It then calls all the action procedures of this wire.
<code>accept-action-proc</code> adds a new procedure to the front of the
existing action procedure list (<code>action-procs</code>) a new procedure.
It then calls this procedure for reasons we&rsquo;ll see later. Finally,
<code>dispatch</code> does the right thing according to its argument.
</p>

<p>
<code>call-each</code> is a simple <code>cdr</code> down a list and execution &#x2014; note the
extra parenthesis around <code>((car procs))</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org371cdf4"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">call-each</span> procs<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">null?</span> procs<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'DONE</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
         <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #a626a4;">car</span> procs<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>call-each <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> procs<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Naturally, we can now define <code>get-signal</code>, <code>set-signal</code>, and
<code>add-action</code> using the wire&rsquo;s <code>dispatch</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org54515c8"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">get-signal</span> wire<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>wire <span style="color: #2e8b57;">'get-signal</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">set-signal!</span> wire new-val<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #50a14f;">(</span>wire <span style="color: #2e8b57;">'set-signal!</span><span style="color: #50a14f;">)</span> new-val<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">add-action!</span> wire proc<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #50a14f;">(</span>wire <span style="color: #2e8b57;">'add-action!</span><span style="color: #50a14f;">)</span> proc<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge14f79f" class="outline-3">
<h3 id="orge14f79f"><span class="section-number-3">11.4.</span> Delays and Propagation</h3>
<div class="outline-text-3" id="text-11-4">
<p>
We define the <code>after-delay</code> procedure as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgee3f0b0"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">after-delay</span> <span style="color: #a626a4;">delay</span> action<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>add-to-agenda!
   <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #a626a4;">delay</span> <span style="color: #da8548;">(</span>current-time the-agenda<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
   action
   the-agenda<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
<code>after-delay</code> calls a function called <code>add-to-agenda!</code>. This
function takes three arguments to add to a data structure called
an agenda: the time at which to add an action, the action, and the
agenda object to add to.
</p>

<p>
To &ldquo;run&rdquo; the agenda, we define <code>propagate</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgdd6bac4"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">propagate</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>empty-agenda? the-agenda<span style="color: #da8548;">)</span> <span style="color: #2e8b57;">'DONE</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
         <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span>first-agenda-item the-agenda<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>remove-first-item! the-agenda<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>propagate<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
<code>propagate</code> simply executes the first item off the agenda, removes it,
then executes the rest of the agenda until there&rsquo;s nothing else
left in the agenda.
</p>
</div>
</div>

<div id="outline-container-org7ad0538" class="outline-3">
<h3 id="org7ad0538"><span class="section-number-3">11.5.</span> The Agenda</h3>
<div class="outline-text-3" id="text-11-5">
<p>
We&rsquo;ve the use of the agenda. We need the following primitives:
</p>

<pre class="example" id="org71af079">
(make-agenda)
(current-time agenda)
(empty-agenda? agenda)
(add-to-agenda! time action agenda)
(first-agenda-item agenda)
(remove-first-item! agenda)
</pre>

<p>
Here&rsquo;s a data structure which can do the job:
</p>

<p>
<a href="./images/the_agenda.pdf">./images/the_agenda.pdf</a>
</p>

<p>
In essence, the agenda is a sorted list. The <code>car</code> of the agenda is the
current time. The <code>cdr</code> of this agenda is a list of pairs, each of
which we&rsquo;ll call a &ldquo;time segment&rdquo;. The <code>cdr</code> of each time segment
is a queue of actions to execute, and the <code>car</code> is the time at
which all these actions are scheduled.
</p>
</div>

<div id="outline-container-org55af064" class="outline-4">
<h4 id="org55af064"><span class="section-number-4">11.5.1.</span> Time Segments</h4>
<div class="outline-text-4" id="text-11-5-1">
<p>
These are trivial to implement, since they&rsquo;re just pairs:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgbf7d5c5"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-time-segment</span> <span style="color: #e45649;">time</span> q<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #e45649;">time</span> q<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">segment-time</span> s<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> s<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">segment-queue</span> s<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> s<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org977eea8" class="outline-4">
<h4 id="org977eea8"><span class="section-number-4">11.5.2.</span> Agenda Implementation</h4>
<div class="outline-text-4" id="text-11-5-2">
<p>
The constructors, selectors, and mutators are:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orga04ea52"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-agenda</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">list</span> <span style="color: #2e8b57;">0</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">current-time</span> agenda<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> agenda<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">set-current-time!</span> agenda <span style="color: #e45649;">time</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>set-car! agenda <span style="color: #e45649;">time</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">segments</span> agenda<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> agenda<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">set-segments!</span> agenda segments<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>set-cdr! agenda segments<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">first-segment</span> agenda<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> <span style="color: #50a14f;">(</span>segments agenda<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">rest-segments</span> agenda<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> <span style="color: #50a14f;">(</span>segments agenda<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
There&rsquo;s only one predicate:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org27e181b"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">empty-agenda?</span> agenda<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">null?</span> <span style="color: #50a14f;">(</span>segments agenda<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
<code>add-to-agenda</code> is defined as:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org713f537"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">add-to-agenda!</span> <span style="color: #e45649;">time</span> action agenda<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">belongs-before?</span> segments<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">or</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">null?</span> segments<span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #a626a4;">&lt;</span> <span style="color: #e45649;">time</span> <span style="color: #b751b6;">(</span>segment-time <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> segments<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">make-new-time-segment</span> <span style="color: #e45649;">time</span> action<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">let</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #6a1868;">q</span> <span style="color: #986801;">(</span>make-queue<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span>insert-queue! q action<span style="color: #da8548;">)</span>
      <span style="color: #da8548;">(</span>make-time-segment <span style="color: #e45649;">time</span> q<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">add-to-segments!</span> segments<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">=</span> <span style="color: #b751b6;">(</span>segment-time <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> segments<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span> <span style="color: #e45649;">time</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span>insert-queue! <span style="color: #b751b6;">(</span>segment-queue <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> segments<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
                       action<span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span><span style="color: #e45649;">let</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #6a1868;">rest</span> <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">cdr</span> segments<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span><span style="color: #e45649;">if</span> <span style="color: #986801;">(</span>belongs-before? <span style="color: #a626a4;">rest</span><span style="color: #986801;">)</span>
              <span style="color: #986801;">(</span>set-cdr!
               segments
               <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #a2b6da;">(</span>make-new-time-segment <span style="color: #e45649;">time</span> action<span style="color: #a2b6da;">)</span>
                     <span style="color: #a2b6da;">(</span><span style="color: #a626a4;">cdr</span> segments<span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
              <span style="color: #986801;">(</span>add-to-segments! <span style="color: #a626a4;">rest</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">segments</span> <span style="color: #b751b6;">(</span>segments agenda<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span>belongs-before? segments<span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span>set-segments!
         agenda
         <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #986801;">(</span>make-new-time-segment <span style="color: #e45649;">time</span> action<span style="color: #986801;">)</span>
               segments<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span>add-to-segments! segments<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
This procedure wants to add an action \(A\) at time \(t\) to the
agenda. Several cases present themselves:
</p>

<ol class="org-ol">
<li>\(t\) is less than the earliest time in the agenda. In this case,
a new time segment must be created, and the <code>cdr</code> of the agenda
must point to it. The <code>cdr</code> of this new time segment should be
the rest of the segments.</li>
<li>\(t\) is equal to one of the times in the agenda. In this case,
\(A\) must be inserted into the action queue of the correct time
segment.</li>
<li>\(t\) is any other value. In this case, a new time segment must
be created and placed in the correct place. The <code>cdr</code> of the
previous segment must be the new segment, and the <code>cdr</code> of the
new segment must be the rest of the segments.</li>
</ol>

<p>
This procedure does exactly this. We first define some helper
functions: <code>belongs-before?</code> simply compares the required time of
\(A\) with the first segment of a list of input segments, or an
empty list. <code>make-new-time-segment</code> simply creates a queue,
inserts \(A\) into it, and creates a time segment ready for
insertion. <code>add-to-segments!</code> is a recursively written procedure.
The base cases are:
</p>
<ol class="org-ol">
<li>If \(t\) is equal to the <code>car</code> of the segments, add it to the
action queue of this segment.</li>
<li>If \(t\) is less than the <code>car</code> of the segments, put the segment
before it.</li>
</ol>
<p>
Finally, the actual function checks if \(t\) is less than the
earliest time in the agenda, in which case <code>set-segments!</code> is
called. Otherwise, <code>add-to-segments!</code> is called to do the right
thing. In essence, this procedure is an insertion sort.
</p>

<p>
We now define how to remove the first time of the agenda:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgb6b1a13"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">remove-first-item!</span> agenda<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">q</span> <span style="color: #b751b6;">(</span>segment-queue <span style="color: #986801;">(</span>first-segment agenda<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>delete-queue! q<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span>empty-queue? q<span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span>set-segments! agenda <span style="color: #b751b6;">(</span>rest-segments agenda<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>


<p>
<code>delete-queue!</code> (albeit poorly named) is a procedure which deletes
the first element of a queue. If this causes the entire queue to
be empty, we get rid of the time segment.
</p>

<p>
Finally, a procedure for getting the first agenda item and setting
the time counter to its time is:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org99bde1a"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">first-agenda-item</span> agenda<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>empty-agenda? agenda<span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"Agenda is empty --- FIRST-AGENDA-ITEM"</span><span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #e45649;">let</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span><span style="color: #6a1868;">first-seg</span> <span style="color: #986801;">(</span>first-segment agenda<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span>set-current-time! agenda <span style="color: #b751b6;">(</span>segment-time first-seg<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
        <span style="color: #da8548;">(</span>front-queue <span style="color: #b751b6;">(</span>segment-queue first-seg<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org59851cf" class="outline-3">
<h3 id="org59851cf"><span class="section-number-3">11.6.</span> Queues</h3>
<div class="outline-text-3" id="text-11-6">
<p>
Our only missing piece now is implementing the action queues time
segments use. These are FIFO (first in, first out) buffers, and
thus the following constructors, selectors, and mutators are
required:
</p>

<pre class="example" id="org24fa9e5">
(make-queue)
(empty-queue? q)
(front-queue q)
(insert-queue! q item)
(delete-queue! q)
</pre>

<p>
It is natural to represent a queue as a standard list, since it&rsquo;s
just a bunch of items. However, this will cause the
<code>insert-queue!</code> mutator to run in \(O(n)\) time. This is because
linked lists by default store only a pointer to the first element,
and there&rsquo;s no way to get a pointer to the last element without
traversing the list. We avoid this problem by implementing a
structure which looks like this:
</p>

<p>
<a href="./images/q.pdf">./images/q.pdf</a>
</p>

<p>
The <code>rear-ptr</code> always points to the last element of the queue,
giving us an \(O(1)\) way to insert elements to the end of the
queue. Queues are thus a pair of &ldquo;pointers&rdquo;.
</p>

<p>
We initialize an empty queue as a pair of empty lists. An empty
queue is thus one with the <code>front-ptr</code> equal to <code>null</code>. Thus:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org6609b22"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">make-queue</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> '<span style="color: #50a14f;">()</span> '<span style="color: #50a14f;">()</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">empty-queue?</span> queue<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">null?</span> <span style="color: #50a14f;">(</span>front-ptr queue<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">front-ptr</span> queue<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> queue<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">rear-ptr</span> queue<span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> queue<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">set-front-ptr!</span> queue item<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>set-car! queue item<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">set-rear-ptr!</span> queue item<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>set-cdr! queue item<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">front-queue</span> queue<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>empty-queue? queue<span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"FRONT: empty queue"</span> queue<span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">car</span> <span style="color: #da8548;">(</span>front-ptr queue<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Now, the core implementation of a queue: the insertion of an item.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgdb3c667"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">insert-queue!</span> queue item<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">new-pair</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cons</span> item '<span style="color: #986801;">()</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">cond</span> <span style="color: #da8548;">(</span><span style="color: #b751b6;">(</span>empty-queue? queue<span style="color: #b751b6;">)</span>
           <span style="color: #b751b6;">(</span>set-front-ptr! queue new-pair<span style="color: #b751b6;">)</span>
           <span style="color: #b751b6;">(</span>set-rear-ptr! queue new-pair<span style="color: #b751b6;">)</span>
           queue<span style="color: #da8548;">)</span>
          <span style="color: #da8548;">(</span><span style="color: #e45649;">else</span>
           <span style="color: #b751b6;">(</span>set-cdr! <span style="color: #986801;">(</span>rear-ptr queue<span style="color: #986801;">)</span> new-pair<span style="color: #b751b6;">)</span>
           <span style="color: #b751b6;">(</span>set-rear-ptr! queue new-pair<span style="color: #b751b6;">)</span>
           queue<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
First, create a new queue item object. Then, two cases present themselves:
</p>
<ol class="org-ol">
<li>If the queue was empty, set both the <code>front-ptr</code> and <code>rear-ptr</code>
to the new item, and return the queue.</li>
<li>Otherwise, go to the last item of the queue. Set its <code>cdr</code> to
the new item, and set the <code>rear-ptr</code> to the new item. Return the
queue.</li>
</ol>


<p>
Finally, we must implement deletion of the first item.
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org3b18d2f"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">delete-queue!</span> queue<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>empty-queue? queue<span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span><span style="color: #a626a4;">error</span> <span style="color: #50a14f;">"DELETE-QUEUE!: called with empty queue"</span> queue<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
        <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span>
         <span style="color: #da8548;">(</span>set-front-ptr! queue <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cdr</span> <span style="color: #986801;">(</span>front-ptr queue<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         queue<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Which simply makes <code>front-ptr</code> point to the second element of the
queue, and returns the queue. If the queue is empty, it throws an
error since you can&rsquo;t delete the first element of an empty queue.
</p>
</div>
</div>

<div id="outline-container-org9e37d4a" class="outline-3">
<h3 id="org9e37d4a"><span class="section-number-3">11.7.</span> Using the Digital Circuit Language</h3>
<div class="outline-text-3" id="text-11-7">
<p>
Before using our (now complete) circuit language, we define a
procedure called <code>probe</code>, which shows the simulator in action. That
is, it adds an action to a wire which prints some wire information
whenever the signal changes. Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org4e40114"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">probe</span> name wire<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>add-action! wire
               <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">()</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> name<span style="color: #da8548;">)</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> <span style="color: #50a14f;">": TIME = "</span><span style="color: #da8548;">)</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> <span style="color: #b751b6;">(</span>current-time the-agenda<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> <span style="color: #50a14f;">": NEW-VAL = "</span><span style="color: #da8548;">)</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">display</span> <span style="color: #b751b6;">(</span>get-signal wire<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
                 <span style="color: #da8548;">(</span><span style="color: #a626a4;">newline</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-racket">























<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">the-agenda</span> <span style="color: #a626a4;">(</span>make-agenda<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">inverter-delay</span> <span style="color: #2e8b57;">2</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">and-gate-delay</span> <span style="color: #2e8b57;">3</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">or-gate-delay</span> <span style="color: #2e8b57;">5</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">input-1</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">input-2</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">sum</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">carry</span> <span style="color: #a626a4;">(</span>make-wire<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>probe <span style="color: #2e8b57;">'SUM</span> sum<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>probe <span style="color: #2e8b57;">'CAR</span> carry<span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>half-adder input-1 input-2 sum carry<span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>set-signal! input-1 <span style="color: #2e8b57;">1</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>propagate<span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>set-signal! input-2 <span style="color: #2e8b57;">1</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>propagate<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example" id="org55a2dec">
SUM: TIME = 0: NEW-VAL = 0
CAR: TIME = 0: NEW-VAL = 0
OK
DONE
SUM: TIME = 8: NEW-VAL = 1
DONE
DONE
CAR: TIME = 11: NEW-VAL = 1
SUM: TIME = 16: NEW-VAL = 0
DONE
</pre>
</div>
</div>

<div id="outline-container-orgddc463a" class="outline-3">
<h3 id="orgddc463a"><span class="section-number-3">11.8.</span> Church&rsquo;s <code>set-car!</code> and <code>set-cdr!</code></h3>
<div class="outline-text-3" id="text-11-8">
<p>
Although <code>set-car!</code> and <code>set-cdr!</code> are primitives for efficiency
reasons, it is theoretically possible to define them in terms of
<code>set!</code>. That is, once we have one way to do assignment, it is
unnecessary to define more primitives, similar to how <code>cons</code>,
<code>car</code>, and <code>cdr</code> could be implemented by &lambda;-expressions.
Consider:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>m<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>m x y<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>x <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>a d<span style="color: #da8548;">)</span> a<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>x <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>a d<span style="color: #da8548;">)</span> d<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> a<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cdr</span> a<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1
2
</pre>


<p>
<code>cons</code> defines a pair as a &lambda; which takes as an argument a
procedure <code>m</code>, which it applies to arguments <code>x</code> and <code>y</code>. <code>car</code>
takes as an input a pair (a &lambda; which takes a &lambda;
argument), and gives it as an argument a &lambda; which takes two
argument and returns the first. <code>cdr</code> does the same thing, except
its &lambda; argument returns the second argument. Since these are
purely functional, we can apply the substitution rule to see what
really goes on:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a</span> <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>m<span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span>m <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> a<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>m<span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span>m <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>a d<span style="color: #50a14f;">)</span> a<span style="color: #a626a4;">)</span> <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #4078f2;">)</span>
<span style="color: #2e8b57;">1</span>
</pre>
</div>

<p>
We can also define <code>cons</code>, <code>car</code>, and <code>cdr</code> such that they support
<code>set-car!</code> and <code>set-cdr!</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> x y<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">(</span>m<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span>m x
       y
       <span style="color: #da8548;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #b751b6;">(</span>n<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #e45649;">set!</span> x n<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
       <span style="color: #da8548;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #b751b6;">(</span>n<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #e45649;">set!</span> y n<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>x <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>a d sa sd<span style="color: #da8548;">)</span> a<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cdr</span> x<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>x <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>a d sa sd<span style="color: #da8548;">)</span> d<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">set-car!</span> x n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>x <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>a d sa sd<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>sa n<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">set-cdr!</span> x n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>x <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>a d sa sd<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span>sd n<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">a</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> a<span style="color: #4078f2;">)</span> <span style="color: #4078f2;">(</span><span style="color: #a626a4;">cdr</span> a<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>set-car! a <span style="color: #2e8b57;">10</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>set-cdr! a <span style="color: #2e8b57;">20</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">car</span> a<span style="color: #4078f2;">)</span> <span style="color: #4078f2;">(</span><span style="color: #a626a4;">cdr</span> a<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1
2
10
20
</pre>


<p>
All we need to do is add two arguments to <code>m</code>: &lambda;&rsquo;s which set
<code>x</code> and <code>y</code> to the argument. <code>car</code> and <code>cdr</code> are nearly identical to their
previous forms, with the only difference being the number of
arguments the &lambda; passed to the pair (<code>m</code>) takes. <code>set-car!</code>
and <code>set-cdr!</code> need only call the <code>set!</code> &lambda;&rsquo;s in <code>m</code> with the
value they are to be set to.
</p>

<p>
Thus, once we have a single assignment procedure (<code>set!</code>), we can
create any other forms of assignment functionally. Note, however,
that this is not necessarily how <code>set-car!</code> and <code>set-cdr!</code> are
<i>actually</i> implemented, since this way is less efficient.
</p>
</div>
</div>
</div>

<div id="outline-container-org25fd506" class="outline-2">
<h2 id="org25fd506"><span class="section-number-2">12.</span> Lecture 6A: Streams, Part I</h2>
<div class="outline-text-2" id="text-12">
<p>
In the last lecture, we discussed assignment. We also saw that this
one addition required a complete change of perspective from our
simple substitution model to an environment based model, which was
required since assignment introduces the ideas of state and of time.
Pairs and variables are actually <i>objects</i> with identity instead of
mere mathematical variables. Two pairs with the same <code>car</code> and <code>cdr</code>
may still be different objects. In this sense, assignment causes the
programming language to be philosophically harder, and can create
state-related bugs. Why did we choose to incur this cost? To build
modular systems, such as the psuedorandom number generator we built.
Assignment often helps modularity, since state is a part of the real
world, as in the case of digital circuits.
</p>

<p>
In this lecture, we will attempt to shift our perspective of the
world in order to remove state, by looking at it from a &ldquo;signal
processing&rdquo; style system: with signals coming in, being processed,
and some output being generated.
</p>
</div>

<div id="outline-container-org6822237" class="outline-3">
<h3 id="org6822237"><span class="section-number-3">12.1.</span> Stream Processing</h3>
<div class="outline-text-3" id="text-12-1">
<p>
Consider the following two problems:
</p>

<ol class="org-ol">
<li><p>
Given a tree that looks like:
</p>
<p>
We want to sum all the squares of all the odd nodes. A
conventional solution to this problem is as follows:
</p>

<div class="org-src-container">
<pre class="src src-racket">


<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-odd-squares</span> tree<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>leaf-node? tree<span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">odd?</span> tree<span style="color: #da8548;">)</span>
          <span style="color: #da8548;">(</span>square tree<span style="color: #da8548;">)</span>
          <span style="color: #2e8b57;">0</span><span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span><span style="color: #a626a4;">+</span> <span style="color: #da8548;">(</span>sum-odd-squares
          <span style="color: #b751b6;">(</span>left-branch tree<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
         <span style="color: #da8548;">(</span>sum-odd-squares
          <span style="color: #b751b6;">(</span>right-branch tree<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">my-tree</span> <span style="color: #a626a4;">(</span>make-tree <span style="color: #50a14f;">(</span>make-tree <span style="color: #2e8b57;">1</span> <span style="color: #da8548;">(</span>make-tree <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">7</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span>make-tree <span style="color: #2e8b57;">13</span> <span style="color: #da8548;">(</span>make-tree <span style="color: #2e8b57;">12</span> <span style="color: #2e8b57;">14</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>sum-odd-squares my-tree<span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
219
</pre></li>

<li><p>
Given an input \(k\), we want returned a list of all the odd Fibonacci
numbers till the \(n^{\mathrm{th}}\) Fibonacci number.
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">odd-fibs</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">define</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">next</span> k<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">if</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">&gt;</span> k n<span style="color: #da8548;">)</span>
        '<span style="color: #da8548;">()</span>
        <span style="color: #da8548;">(</span><span style="color: #e45649;">let</span> <span style="color: #b751b6;">(</span><span style="color: #986801;">(</span><span style="color: #6a1868;">f</span> <span style="color: #4db5bd;">(</span>fib k<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span><span style="color: #e45649;">if</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">odd?</span> f<span style="color: #986801;">)</span>
              <span style="color: #986801;">(</span><span style="color: #a626a4;">cons</span> f <span style="color: #4db5bd;">(</span>next <span style="color: #a2b6da;">(</span>inc k<span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
              <span style="color: #986801;">(</span>next <span style="color: #4db5bd;">(</span>inc k<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>next <span style="color: #2e8b57;">1</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>odd-fibs <span style="color: #2e8b57;">10</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(1 1 3 5 13 21 55)
</pre></li>
</ol>


<p>
Now, we can see that these procedures are actually doing the
following:
</p>

<ol class="org-ol">
<li>Square odd nodes in a tree:
<ol class="org-ol">
<li>Enumerate the leaves.</li>
<li>Filter for <code>odd?</code>-ness.</li>
<li>Map <code>square</code>.</li>
<li>Accumulate using <code>+</code> starting at 0.</li>
</ol></li>
<li>Find odd Fibonacci numbers till the \(n^{\mathrm{th}}\) one:
<ol class="org-ol">
<li>Enumerate numbers from 1 to \(n\).</li>
<li>Map <code>fib</code>.</li>
<li>Filter for <code>odd?</code>-ness.</li>
<li>Accumulate using <code>cons</code>, starting with the empty list <code>'()</code>.</li>
</ol></li>
</ol>

<p>
We&rsquo;ve rewritten the procedures in terms of enumerating, mapping,
filtering, and accumulating. Note that this is similar to how
signals are processed by passing them through filters and the like.
However, our Lisp procedures in their
current state do not explicitly have these distinct parts.
</p>

<p>
Let us therefore invent a language for writing procedures in this
signal processing way. The objects passed between maps, filters,
etc. are called &ldquo;streams&rdquo;, which are defined by the following
selectors and constructors:
</p>
<ul class="org-ul">
<li>Constructor: <code>(cons-stream x y)</code>.</li>
<li>Selectors:
<ul class="org-ul">
<li><code>(head s)</code></li>
<li><code>(tail s)</code></li>
</ul></li>
</ul>

<p>
The behavior is such that for any <code>x</code> and <code>y</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket">

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">x</span> <span style="color: #2e8b57;">1</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">y</span> <span style="color: #2e8b57;">2</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>head <span style="color: #a626a4;">(</span>cons-stream x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>tail <span style="color: #a626a4;">(</span>cons-stream x y<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
1
2
</pre>


<p>
We also have <code>the-empty-stream</code>. Note that this description makes a
stream look a lot like a pair, and, for now, it&rsquo;s alright to
pretend streams <i>are</i> pairs. We can now define our stream
processing procedures:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="org4e367ba">

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">map-stream</span> proc s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>empty-stream? s<span style="color: #50a14f;">)</span>
      the-empty-stream
      <span style="color: #50a14f;">(</span>cons-stream
       <span style="color: #da8548;">(</span>proc <span style="color: #b751b6;">(</span>head s<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
       <span style="color: #da8548;">(</span>map-stream proc <span style="color: #b751b6;">(</span>tail s<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">filter-stream</span> <span style="color: #a626a4;">pred</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>empty-stream? s<span style="color: #da8548;">)</span> the-empty-stream<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">pred</span> <span style="color: #b751b6;">(</span>head s<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
     <span style="color: #da8548;">(</span>cons-stream <span style="color: #b751b6;">(</span>head s<span style="color: #b751b6;">)</span>
                  <span style="color: #b751b6;">(</span>filter-stream <span style="color: #a626a4;">pred</span> <span style="color: #986801;">(</span>tail s<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span> <span style="color: #da8548;">(</span>filter-stream <span style="color: #a626a4;">pred</span> <span style="color: #b751b6;">(</span>tail s<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">accumulate-stream</span> combiner init-val s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>empty-stream? s<span style="color: #50a14f;">)</span>
      init-val
      <span style="color: #50a14f;">(</span>combiner <span style="color: #da8548;">(</span>head s<span style="color: #da8548;">)</span>
                <span style="color: #da8548;">(</span>accumulate-stream combiner init-val <span style="color: #b751b6;">(</span>tail s<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">enumerate-tree</span> tree<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>leaf-node? tree<span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span>cons-stream tree the-empty-stream<span style="color: #50a14f;">)</span>
      <span style="color: #50a14f;">(</span>append-streams
       <span style="color: #da8548;">(</span>enumerate-tree
        <span style="color: #b751b6;">(</span>left-branch tree<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
       <span style="color: #da8548;">(</span>enumerate-tree
        <span style="color: #b751b6;">(</span>right-branch tree<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">append-streams</span> s1 s2<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span>empty-stream? s1<span style="color: #50a14f;">)</span>
      s2
      <span style="color: #50a14f;">(</span>cons-stream <span style="color: #da8548;">(</span>head s1<span style="color: #da8548;">)</span>
                   <span style="color: #da8548;">(</span>append-streams <span style="color: #b751b6;">(</span>tail s1<span style="color: #b751b6;">)</span> s2<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">enumerate-interval</span> low high<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&gt;</span> low high<span style="color: #50a14f;">)</span>
      the-empty-stream
      <span style="color: #50a14f;">(</span>cons-stream low
                   <span style="color: #da8548;">(</span>enumerate-interval <span style="color: #b751b6;">(</span>inc low<span style="color: #b751b6;">)</span> high<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">singleton</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>cons-stream s the-empty-stream<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
These should be relatively intuitive. We can now write our
procedures using stream processing:
</p>

<div class="org-src-container">
<pre class="src src-racket">


<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">sum-odd-squares</span> tree<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>accumulate-stream <span style="color: #a626a4;">+</span>
                     <span style="color: #2e8b57;">0</span>
                     <span style="color: #50a14f;">(</span>map-stream square
                          <span style="color: #da8548;">(</span>filter-stream <span style="color: #a626a4;">odd?</span>
                                  <span style="color: #b751b6;">(</span>enumerate-tree tree<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">odd-fibs</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>accumulate-stream <span style="color: #a626a4;">cons</span>
                    '<span style="color: #50a14f;">()</span>
                    <span style="color: #50a14f;">(</span>filter-stream <span style="color: #a626a4;">odd?</span>
                                   <span style="color: #da8548;">(</span>map-stream fib
                                               <span style="color: #b751b6;">(</span>enumerate-interval <span style="color: #2e8b57;">1</span> n<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #6a1868;">my-tree</span> <span style="color: #a626a4;">(</span>make-tree <span style="color: #50a14f;">(</span>make-tree <span style="color: #2e8b57;">1</span> <span style="color: #da8548;">(</span>make-tree <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">7</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span> <span style="color: #50a14f;">(</span>make-tree <span style="color: #2e8b57;">13</span> <span style="color: #da8548;">(</span>make-tree <span style="color: #2e8b57;">12</span> <span style="color: #2e8b57;">14</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>sum-odd-squares my-tree<span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>odd-fibs <span style="color: #2e8b57;">10</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
219
(1 1 3 5 13 21 55)
</pre>


<p>
This brings modularity into our programs: we&rsquo;re establishing
conventional interfaces via streams. This way of looking at
programs (mapping, filtering, etc.) is very general and can be used
to write all sorts of procedures.
</p>
</div>
</div>


<div id="outline-container-org91e162a" class="outline-3">
<h3 id="org91e162a"><span class="section-number-3">12.2.</span> Some More Complex Examples</h3>
<div class="outline-text-3" id="text-12-2">
</div>
<div id="outline-container-orge668ac8" class="outline-4">
<h4 id="orge668ac8"><span class="section-number-4">12.2.1.</span> Flattening</h4>
<div class="outline-text-4" id="text-12-2-1">
<p>
Suppose we have a &ldquo;stream of streams&rdquo;, or a data structure that
looks like the following:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #a626a4;">(</span><span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">3</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">5</span> <span style="color: #2e8b57;">6</span><span style="color: #a626a4;">)</span> <span style="color: #a626a4;">(</span><span style="color: #2e8b57;">7</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">9</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
That we want to process into a single stream:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #2e8b57;">1</span> <span style="color: #2e8b57;">2</span> <span style="color: #2e8b57;">3</span> <span style="color: #2e8b57;">4</span> <span style="color: #2e8b57;">5</span> <span style="color: #2e8b57;">6</span> <span style="color: #2e8b57;">7</span> <span style="color: #2e8b57;">8</span> <span style="color: #2e8b57;">98</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
That is, we want to &ldquo;flatten&rdquo; the stream of streams. We can do so
like this:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgef7add6">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">flatten</span> stream-of-streams<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>accumulate-stream append-streams
                     the-empty-stream
                     stream-of-streams<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Now, consider a function \(f\) that returns a stream. We want to
call \(f\) on a stream (map \(f\) to it), then take its output
stream-of-streams and flatten it. This is also simple:
</p>

<div class="org-src-container">
<pre class="src src-racket" id="orgef33472">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">flatmap</span> f s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">flatten</span> <span style="color: #50a14f;">(</span>map-stream f s<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge6e3d72" class="outline-4">
<h4 id="orge6e3d72"><span class="section-number-4">12.2.2.</span> Prime Sum Pairs</h4>
<div class="outline-text-4" id="text-12-2-2">
<p>
Our first problem is: given \(N\), find all pairs \(i\), \(j\) (\(0< j <
    i \leq N\)) such that \(i+j\) is prime. For instance, given \(N=6\),
our expected output is something like:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">\(i\)</th>
<th scope="col" class="org-right">\(j\)</th>
<th scope="col" class="org-right">\(i+j\)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">1</td>
<td class="org-right">5</td>
</tr>

<tr>
<td class="org-right">\(\vdots\)</td>
<td class="org-right">\(\vdots\)</td>
<td class="org-right">\(\vdots\)</td>
</tr>
</tbody>
</table>

<p>
We can therefore write:
</p>

<div class="org-src-container">
<pre class="src src-racket">

<span style="color: #4078f2;">(</span><span style="color: #e45649;">#%require</span> math/number-theory<span style="color: #4078f2;">)</span> <span style="color: #a52a2a; font-style: italic;">;; </span><span style="color: #a52a2a; font-style: italic;">for prime?</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">prime-sum-pairs</span> n<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>map-stream <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">(</span>p<span style="color: #da8548;">)</span>
                <span style="color: #da8548;">(</span><span style="color: #a626a4;">list</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">car</span> p<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">cadr</span> p<span style="color: #b751b6;">)</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">+</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">car</span> p<span style="color: #986801;">)</span> <span style="color: #986801;">(</span><span style="color: #a626a4;">cadr</span> p<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
              <span style="color: #50a14f;">(</span>filter-stream <span style="color: #da8548;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #b751b6;">(</span>p<span style="color: #b751b6;">)</span>
                               <span style="color: #b751b6;">(</span>prime? <span style="color: #986801;">(</span><span style="color: #a626a4;">+</span> <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">car</span> p<span style="color: #4db5bd;">)</span> <span style="color: #4db5bd;">(</span><span style="color: #a626a4;">cadr</span> p<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
                             <span style="color: #da8548;">(</span>flatmap <span style="color: #b751b6;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #986801;">(</span>i<span style="color: #986801;">)</span>
                                        <span style="color: #986801;">(</span>map-stream <span style="color: #4db5bd;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #a2b6da;">(</span>j<span style="color: #a2b6da;">)</span> <span style="color: #a2b6da;">(</span><span style="color: #a626a4;">list</span> i j<span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span>
                                                    <span style="color: #4db5bd;">(</span>enumerate-interval <span style="color: #2e8b57;">1</span> <span style="color: #a2b6da;">(</span>dec i<span style="color: #a2b6da;">)</span><span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span><span style="color: #b751b6;">)</span>
                                      <span style="color: #b751b6;">(</span>enumerate-interval <span style="color: #2e8b57;">1</span> n<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span>head <span style="color: #a626a4;">(</span>prime-sum-pairs <span style="color: #2e8b57;">6</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>head <span style="color: #a626a4;">(</span>tail <span style="color: #50a14f;">(</span>prime-sum-pairs <span style="color: #2e8b57;">6</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>head <span style="color: #a626a4;">(</span>tail <span style="color: #50a14f;">(</span>tail <span style="color: #da8548;">(</span>prime-sum-pairs <span style="color: #2e8b57;">6</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(2 1 3)
(3 2 5)
(4 1 5)
</pre>


<p>
How does this work? Let&rsquo;s read it inside out, starting with the
<code>flatmap</code>. The first argument to <code>flatmap</code> is a function which,
given an input <code>i</code>, creates a stream of lists of <code>i</code> and <code>j</code> for
all values of <code>j</code> between <code>1</code> and <code>i</code>. The second argument is
simply all <code>i</code>&rsquo;s from <code>1</code> to <code>n</code>. <code>flatmap</code> therefore creates a
stream that looks like the following:
</p>

<p>
\[\left[
   \binom{2}{1}~\binom{3}{1}~\binom{3}{2}~\binom{4}{1}~\binom{4}{2}~\binom{4}{3}~\binom{5}{1}~\cdots
   \right]\]
</p>

<p>
All that&rsquo;s left to do is filter this stream for the <code>prime?</code>-ness
of \(i+j\) in each list, then create our output in the expected
format. This is done using <code>filter-stream</code> with the right
\(\lambda\), and then mapping this stream to our output format.
</p>
</div>
</div>

<div id="outline-container-org480e7f8" class="outline-4">
<h4 id="org480e7f8"><span class="section-number-4">12.2.3.</span> <span class="todo TODO">TODO</span> Backtracking: The Eight Queens Problem</h4>
</div>
</div>


<div id="outline-container-org9c04f84" class="outline-3">
<h3 id="org9c04f84"><span class="section-number-3">12.3.</span> The Catch: On Efficiency</h3>
<div class="outline-text-3" id="text-12-3">
<p>
By treating streams the way we have, simply as lists, introduces a
form of inefficiency. Consider the problem of finding the second
prime in the interval \([10^4, 10^{15}]\). <code>enumerate-interval</code> would
never terminate, since it&rsquo;ll spend forever generating an incredibly
long list of numbers. Assuming this can be done, we&rsquo;ll spend
forever and a day filtering and checking primality, only to ignore
most of this work and pick up the second element of the list.
This is clearly outrageous, since most of the work has gone to
waste, assuming a computer could do it in the first place. It seems
the &ldquo;traditional&rdquo; approach, while less mathematically pretty, is
better, since it would stop as soon as it found the second prime.
</p>

<p>
Now, this would indeed be true if streams were lists. But &#x2014;
streams are streams, so we can indeed do:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">#%require</span> math/number-theory<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">get-prime</span> low high<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>filter-stream prime?
                 <span style="color: #50a14f;">(</span>enumerate-interval low high<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>head <span style="color: #a626a4;">(</span>tail <span style="color: #50a14f;">(</span>get-prime <span style="color: #2e8b57;">10000</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
10009
</pre>


<p>
And get a result. It seems that we can have our cake and eat it
too. What is this magic? How are we able to both have the
expressiveness of stream-style processing <i>and</i> the efficiency of
traditional programming? What is this magical black box called a
stream?
</p>
</div>
</div>

<div id="outline-container-org469e480" class="outline-3">
<h3 id="org469e480"><span class="section-number-3">12.4.</span> Implementing Streams</h3>
<div class="outline-text-3" id="text-12-4">
<p>
Streams work on the principle of &ldquo;laziness&rdquo;. That is, when we
declare a stream, it figures out <i>only</i> what the first element is, and
promises to do the rest of the work &ldquo;later&rdquo;. If, and <i>only if</i> we
need the second element is it computed, by us calling on the
promise. An alternate way to visualize this is by imagining how
you&rsquo;d thread a string through a series of tubes: we only pull out
of the far end as much string as we need.<sup><a id="fnr.8" class="footref" href="#fn.8" role="doc-backlink">8</a></sup>
</p>

<p>
Streams are an on-demand data structure. These are easy to
implement in our language using procedures as first-class citizens.
Here&rsquo;s how <code>cons-stream</code>, <code>head</code>, and <code>tail</code> are defined:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define-syntax</span> <span style="color: #6a1868;">cons-stream</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">syntax-rules</span> <span style="color: #50a14f;">()</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>cons-stream a e<span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #a626a4;">cons</span> a <span style="color: #b751b6;">(</span><span style="color: #a626a4;">delay</span> e<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">head</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">car</span> s<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">tail</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #a626a4;">force</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">cdr</span> s<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
<code>define-syntax</code> defines <code>cons-stream</code> to be a macro. All that this
means is that any instances of <code>(cons-stream a e)</code> are replaced by
<code>(cons a (delay e))</code> <i>before</i> we pass the program to the
interpreter. Why we define it as a macro rather than a procedure
will become clear momentarily. Note that by this token, streams are
created as the <code>cons</code> of the first input and the second input
passed to something called <code>delay</code>. <code>head</code> is the same as <code>car</code>,
and <code>tail</code> calls <code>force</code> on the <code>cdr</code> of the stream.
</p>

<p>
Clearly, there&rsquo;s some magic going on in <code>delay</code> and <code>force</code> which
makes streams lazy: but there&rsquo;s really none. Here&rsquo;s how they&rsquo;re
defined:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define-syntax</span> <span style="color: #6a1868;">delay</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">syntax-rules</span> <span style="color: #50a14f;">()</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">delay</span> expr<span style="color: #da8548;">)</span>
     <span style="color: #da8548;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #b751b6;">()</span> expr<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>

<span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">force</span> p<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>p<span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Again <code>delay</code> is simply a macro that replaces any instance of
<code>(delay expr)</code> with <code>(lambda () expr)</code>. That is, it hides the
expression inside a &lambda;. <code>force</code> calls this &lambda;, recovering
the expression.
</p>

<p>
Simply doing this creates the behavior we need. Consider our
previous example, that of finding primes (<code>get-prime</code>). Here&rsquo;s what
happens:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">get-prime</span> low high<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span>filter-stream prime?
                 <span style="color: #50a14f;">(</span>enumerate-interval low high<span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>head <span style="color: #a626a4;">(</span>tail <span style="color: #50a14f;">(</span>get-prime <span style="color: #2e8b57;">10000</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
We can use the substitution model since everything is purely
functional:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span>enumerate-interval <span style="color: #2e8b57;">10000</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
How is <code>enumerate-interval</code> defined?
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">enumerate-interval</span> <span style="color: #2e8b57;">10000</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">if</span> <span style="color: #50a14f;">(</span><span style="color: #a626a4;">&gt;</span> <span style="color: #2e8b57;">10000</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #50a14f;">)</span>
      the-empty-stream
      <span style="color: #50a14f;">(</span>cons-stream <span style="color: #2e8b57;">10000</span>
                   <span style="color: #da8548;">(</span>enumerate-interval <span style="color: #b751b6;">(</span>inc <span style="color: #2e8b57;">10000</span><span style="color: #b751b6;">)</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
It does a <code>cons-stream</code> on <code>10000</code> and a <i>promise</i> to compute
<code>(enumerate-interval 10001 1000000000000000)</code>. Or, explicitly
written:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">10000</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">delay</span> <span style="color: #50a14f;">(</span>enumerate-interval <span style="color: #da8548;">(</span>inc <span style="color: #2e8b57;">10000</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Expanding out the <code>delay</code> and checking its output:
</p>
<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">10000</span> <span style="color: #a626a4;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #50a14f;">()</span> <span style="color: #50a14f;">(</span>enumerate-interval <span style="color: #da8548;">(</span>inc <span style="color: #2e8b57;">10000</span><span style="color: #da8548;">)</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(10000 . #&lt;procedure:...CDEkB/ob-p1kSJ7.rkt:91:12&gt;)
</pre>


<p>
So our &ldquo;stream&rdquo; really is just a pair of the first element and some
procedure that delay created. Calling <code>head</code> would just give us:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span>head <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">10000</span> <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">()</span> <span style="color: #da8548;">(</span>enumerate-interval <span style="color: #b751b6;">(</span>inc <span style="color: #2e8b57;">10000</span><span style="color: #b751b6;">)</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
10000
</pre>


<p>
What would <code>tail</code> give us? It&rsquo;ll simply call the &lambda;, giving us
another pair:
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span>tail <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">10000</span> <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">()</span> <span style="color: #da8548;">(</span>enumerate-interval <span style="color: #b751b6;">(</span>inc <span style="color: #2e8b57;">10000</span><span style="color: #b751b6;">)</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(10001 . #&lt;procedure:...CDEkB/ob-zfZJq9.rkt:25:4&gt;)
</pre>


<p>
Clearly, <code>enumerate-interval</code> was only called the second time
<i>when</i> we called tail, and not before. This is where the efficiency
is created.
</p>

<p>
Note that we&rsquo;re filtering the stream for <code>prime?</code>-ness. How does
<code>filter-stream</code> work? Here&rsquo;s the definition:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">filter-stream</span> <span style="color: #a626a4;">pred</span> s<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">cond</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span>empty-stream? s<span style="color: #da8548;">)</span> the-empty-stream<span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">pred</span> <span style="color: #b751b6;">(</span>head s<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span>
     <span style="color: #da8548;">(</span>cons-stream <span style="color: #b751b6;">(</span>head s<span style="color: #b751b6;">)</span>
                  <span style="color: #b751b6;">(</span>filter-stream <span style="color: #a626a4;">pred</span> <span style="color: #986801;">(</span>tail s<span style="color: #986801;">)</span><span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">else</span> <span style="color: #da8548;">(</span>filter-stream <span style="color: #a626a4;">pred</span> <span style="color: #b751b6;">(</span>tail s<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Since it also uses <code>cons-stream</code>, the output it generates is also a
promise-style pair. <code>filter-stream</code> will keep &ldquo;tugging&rdquo; on the
stream (keep calling on promises, as in the <code>else</code> clause), until
it finds a prime.
</p>

<div class="org-src-container">
<pre class="src src-racket">
<span style="color: #4078f2;">(</span><span style="color: #e45649;">#%require</span> math/number-theory<span style="color: #4078f2;">)</span>
<span style="color: #4078f2;">(</span>filter-stream prime? <span style="color: #a626a4;">(</span><span style="color: #a626a4;">cons</span> <span style="color: #2e8b57;">10000</span> <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">()</span> <span style="color: #da8548;">(</span>enumerate-interval <span style="color: #b751b6;">(</span>inc <span style="color: #2e8b57;">10000</span><span style="color: #b751b6;">)</span> <span style="color: #2e8b57;">1000000000000000</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<pre class="example">
(10007 . #&lt;procedure:...CDEkB/ob-Mvek4B.rkt:25:4&gt;)
</pre>


<p>
Since we want to find the second prime, when we call <code>tail</code> on the
stream, the <code>delay</code> is <code>force</code>&rsquo;d, and we get the prime <code>10009</code>.
</p>

<p>
Note that we define <code>delay</code> and <code>cons-stream</code> as macros because we
<i>don&rsquo;t</i> want their arguments evaluated: i.e., we want them to be
lazy. This is only possible if we define them as macros and
directly substitute the source before compilation.
</p>
</div>

<div id="outline-container-orgc92105e" class="outline-4">
<h4 id="orgc92105e"><span class="section-number-4">12.4.1.</span> A Small Optimization</h4>
<div class="outline-text-4" id="text-12-4-1">
<p>
Often, calling <code>tail</code> repeatedly will result in the recomputation
of certain procedures that may already have been computed. This
can get expensive, so we add memoization by slightly changing
<code>delay</code>:
</p>
<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define-syntax</span> <span style="color: #6a1868;">delay</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">syntax-rules</span> <span style="color: #50a14f;">()</span>
    <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #a626a4;">delay</span> expr<span style="color: #da8548;">)</span>
     <span style="color: #da8548;">(</span>memo-proc <span style="color: #b751b6;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #986801;">()</span> expr<span style="color: #b751b6;">)</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
<code>memo-proc</code> itself just remembers if it has already computed a
procedure by using a flag (<code>already-run?</code>) and storing the value
in <code>result</code>:
</p>

<div class="org-src-container">
<pre class="src src-racket"><span style="color: #4078f2;">(</span><span style="color: #e45649;">define</span> <span style="color: #a626a4;">(</span><span style="color: #a626a4;">memo-proc</span> proc<span style="color: #a626a4;">)</span>
  <span style="color: #a626a4;">(</span><span style="color: #e45649;">let</span> <span style="color: #50a14f;">(</span><span style="color: #da8548;">(</span><span style="color: #6a1868;">already-run?</span> <span style="color: #a626a4;">false</span><span style="color: #da8548;">)</span> <span style="color: #da8548;">(</span><span style="color: #6a1868;">result</span> <span style="color: #a626a4;">false</span><span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span>
    <span style="color: #50a14f;">(</span><span style="color: #e45649;">lambda</span> <span style="color: #da8548;">()</span>
      <span style="color: #da8548;">(</span><span style="color: #e45649;">if</span> <span style="color: #b751b6;">(</span><span style="color: #a626a4;">not</span> already-run?<span style="color: #b751b6;">)</span>
          <span style="color: #b751b6;">(</span><span style="color: #e45649;">begin</span>
            <span style="color: #986801;">(</span><span style="color: #e45649;">set!</span> result <span style="color: #4db5bd;">(</span>proc<span style="color: #4db5bd;">)</span><span style="color: #986801;">)</span>
            <span style="color: #986801;">(</span><span style="color: #e45649;">set!</span> already-run? <span style="color: #a626a4;">true</span><span style="color: #986801;">)</span>
            result<span style="color: #b751b6;">)</span>
          result<span style="color: #da8548;">)</span><span style="color: #50a14f;">)</span><span style="color: #a626a4;">)</span><span style="color: #4078f2;">)</span>
</pre>
</div>

<p>
Streams, clearly, make life simpler and bring more modularity into
our code.
</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<code>let</code> is a Lisp primitive which takes as its first argument a
series of definitions, and second input a series of applications that may
use these definitions. The trick is that these definitions are only
valid in the body (second argument) of <code>let</code>, effectively creating a
local namespace.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
For an operation defined on members of a set, the result of
that operation is a member of the set. For instance, addition on
natural numbers.
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Note that Lisp actually implements pairs using &ldquo;real&rdquo; data
structures, since using procedures this way is less efficient.
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
\(p \otimes p = p\)
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5" role="doc-backlink">5</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
LISP actually stands for LISt Processing.
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6" role="doc-backlink">6</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
We use &ldquo;initiate&rdquo; and &ldquo;substitute&rdquo; interchangeably to mean
swapping out expressions in the skeleton provided by the RHS of the
rules.
</p></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7" role="doc-backlink">7</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
&ldquo;Garbage in, garbage out&rdquo; means that the simplifier will
produce garbage output if the rules supplied to it are garbage. That
is, it makes no attempt to fix flaws in logic on the part of the user,
much like a computer. This underlying principle of computing was noted
by the father of computers, Charles Babbage: &ldquo;On two occasions I have
been asked, &lsquo;Pray, Mr. Babbage, if you put into the machine wrong
figures, will the right answers come out?&rsquo; I am not able rightly
to apprehend the kind of confusion of ideas that could provoke such a
question.&rdquo;
</p></div></div>

<div class="footdef"><sup><a id="fn.8" class="footnum" href="#fnr.8" role="doc-backlink">8</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
This is indeed how the video lectures explain it, see Lecture
6A at timestamp 47:39.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<hr><p style="font-size: 75%">Created in GNU <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.2 (<a href="https://orgmode.org">Org</a> mode 9.5).</p>
</div>
</body>
</html>
